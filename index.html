<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Doctor Car Pro — OBD-II (ELM327)</title>
<meta name="theme-color" content="#0d0f15">

<!-- Librerías existentes -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- VIN DECODER — NUEVO: Tesseract para OCR local -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.3/dist/tesseract.min.js"></script>

<style>
/* (…tus estilos existentes sin cambios…) */

/* ===== Añadidos ligeros para el módulo VIN ===== */
.vin-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.vin-kv{background:rgba(12,20,30,.45);border:1px solid var(--line);border-radius:12px;padding:10px}
.vin-kv b{display:block;color:var(--muted);margin-bottom:6px}
.vin-video{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#000}
.vin-video video{width:100%;height:auto;display:block;transform:scaleX(-1)}
.vin-overlay{position:absolute;border:2px dashed var(--acc);pointer-events:auto;cursor:move;width:68%;height:18%;left:16%;bottom:12%;
  display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px;background:transparent}
.badge{font-size:12px;color:var(--muted)}
.badge.ok{background:#22c55e22;border:1px solid #22c55e55;border-radius:8px;padding:2px 6px;color:#a7f3d0}
.badge.err{background:#ef444422;border:1px solid #ef444466;border-radius:8px;padding:2px 6px;color:#fecaca}
.badge.warn{background:#f59e0b22;border:1px solid #f59e0b55;border-radius:8px;padding:2px 6px;color:#fde68a}
.drop{border:1px dashed var(--line);border-radius:12px;padding:10px;text-align:center;color:var(--muted);background:rgba(12,20,30,.45)}
@media (max-width:900px){ .vin-grid{grid-template-columns:1fr} }
</style>
</head>

<body class="bg-dark">
<header>
  <div class="topbar">
    <button id="btnBackHome" class="btn ghost backBtn" title="Regresar al menú">← Menú principal</button>
    <img id="appLogo" class="logo" alt="Logo">
    <div><div class="brand">Doctor Car Pro</div><div class="badge">OBD-II • ELM327</div></div>
    <span class="grow"></span>
    <span id="connStatus" class="tag">Desconectado</span>
    <button id="btnConnect" class="btn primary">Conectar</button>
    <button id="btnDisconnect" class="btn ghost hidden">Desconectar</button>
  </div>
</header>

<div class="container">
  <!-- ====== HOME ====== -->
  <section id="page-home" class="card">
    <div class="h"><h2>Menú principal</h2><span class="tag">Selecciona una función</span></div>
    <div class="homeGrid" id="homeGrid">
      <!-- (…tiles existentes…) -->

      <!-- VIN DECODER — NUEVO: acceso desde el Home -->
      <div class="tile" data-go="vin"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 9h10M7 13h6"/><path d="M4 3h4M16 3h4"/>
        </svg></div><div class="title">VIN Decoder</div><div class="sub">Cámara + básico</div></div>
    </div>
  </section>

  <!-- (…todas tus pantallas existentes: dash, scan, live, charts, etc… sin cambios…) -->

  <!-- VIN DECODER — NUEVO -->
  <section id="page-vin" class="card hidden">
    <div class="h"><h2>VIN Decoder</h2><span class="tag">Cámara + OCR + Check Digit</span></div>

    <div class="row">
      <div class="card">
        <label>VIN</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="vinIn" class="mono" placeholder="Ej: 1HGCM82633A004352" maxlength="34"/>
          <input id="vinYear" type="number" placeholder="Año (opcional)" min="1900" max="2035" style="width:160px"/>
          <button id="vinDecode" class="btn primary">Decodificar</button>
          <button id="vinFromECU" class="btn ghost" title="Léelo por OBD 0902">Tomar VIN de ECU</button>
          <button id="vinClear" class="btn ghost">Limpiar</button>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <span id="vinCheck" class="badge warn">Sin verificar</span>
          <button id="vinCopy" class="btn ghost">Copiar VIN</button>
          <button id="vinOpen" class="btn ghost">Abrir en NHTSA</button>
        </div>
        <hr/>
        <div class="vin-video">
          <video id="vinVideo" autoplay playsinline></video>
          <div id="vinOverlay" class="vin-overlay">Caja de recorte</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <button id="vinCamStart" class="btn ghost">Abrir cámara</button>
          <button id="vinCamStop" class="btn ghost">Detener</button>
          <button id="vinCapture" class="btn ghost">Capturar</button>
          <label class="badge" style="display:flex;align-items:center;gap:8px">
            <input id="vinScanAuto" type="checkbox"> Escaneo continuo
          </label>
          <label class="badge">Intervalo
            <input id="vinScanInt" type="number" value="1500" min="400" max="5000" style="width:90px;margin-left:6px">
            ms
          </label>
          <label class="badge" style="margin-left:auto">Imagen:
            <input id="vinFile" type="file" accept="image/*" style="margin-left:6px">
          </label>
        </div>
        <div id="vinOcrStatus" class="badge" style="margin-top:6px">Estado: inactivo</div>
      </div>

      <div class="card">
        <div class="h"><h2>Datos básicos</h2><span class="badge">NHTSA vPIC</span></div>
        <div class="vin-grid" id="vinGrid">
          <!-- Campos (se rellenan por JS) -->
          <div class="vin-kv"><b>Marca</b><div id="fMake">(—)</div></div>
          <div class="vin-kv"><b>Modelo</b><div id="fModel">(—)</div></div>
          <div class="vin-kv"><b>Motor</b><div id="fEngine">(—)</div></div>
          <div class="vin-kv"><b>Fabricación</b><div id="fPlant">(—)</div></div>
          <div class="vin-kv"><b>Peso (GVWR)</b><div id="fGVWR">(—)</div></div>
          <div class="vin-kv"><b>Color</b><div id="fColor">(—)</div></div>
          <div class="vin-kv"><b>Transmisión</b><div id="fTrans">(—)</div></div>
          <div class="vin-kv"><b>Tamaño de rueda</b><div id="fWheel">(—)</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- (…resto de pantallas existentes infoplus, settings, upgrade, help…) -->

</div>

<footer>© <span id="year"></span> Doctor Car Pro</footer>

<!-- Login modal (sin cambios) -->
<div id="loginModal" class="modal hidden" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:100">
  <!-- (…contenido del modal…) -->
</div>

<script>
/* ====== (tu JS existente completo) ====== */
/* (Se deja intacto todo lo que ya tienes arriba) */

/* ====== VIN DECODER — NUEVO ====== */
(function(){
  // Elementos
  const vinIn = document.getElementById('vinIn');
  const vinYear = document.getElementById('vinYear');
  const vinDecode = document.getElementById('vinDecode');
  const vinClear = document.getElementById('vinClear');
  const vinFromECU = document.getElementById('vinFromECU');
  const vinCopy = document.getElementById('vinCopy');
  const vinOpen = document.getElementById('vinOpen');
  const vinCheck = document.getElementById('vinCheck');

  const f = (id)=>document.getElementById(id);
  const fMake=f('fMake'), fModel=f('fModel'), fEngine=f('fEngine'), fPlant=f('fPlant'),
        fGVWR=f('fGVWR'), fColor=f('fColor'), fTrans=f('fTrans'), fWheel=f('fWheel');

  // Cámara/OCR
  const video = document.getElementById('vinVideo');
  const overlay = document.getElementById('vinOverlay');
  const ocrStatus = document.getElementById('vinOcrStatus');
  const camStart = document.getElementById('vinCamStart');
  const camStop = document.getElementById('vinCamStop');
  const capture = document.getElementById('vinCapture');
  const scanAuto = document.getElementById('vinScanAuto');
  const scanInt = document.getElementById('vinScanInt');
  const vinFile = document.getElementById('vinFile');

  const BASE='https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/';
  let stream=null, worker=null, scanTimer=null, ocrRunning=false;

  // Utilidades VIN
  const VIN_CLEAN=/[A-HJ-NPR-Z0-9]/gi;
  const VIN_FULL=/([A-HJ-NPR-Z0-9\-\s]{17,28})/gi;
  function ocrFix(s){
    if(!s) return s;
    let t=s.toUpperCase().replace(/[^\w\s\-]/g,'');
    t=t.replace(/O/g,'0').replace(/I/g,'1').replace(/Q/g,'0');
    t=t.replace(/(?<=\d)S(?=\d)/g,'5').replace(/(?<=\d)Z(?=\d)/g,'2').replace(/(?<=\d)B(?=\d)/g,'8');
    return t;
  }
  function sanitize(v){ const only=(ocrFix(v).match(VIN_CLEAN)||[]).join(''); return only.toUpperCase().slice(0,17); }

  // Check digit ISO 3779
  const T={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,J:1,K:2,L:3,M:4,N:5,P:7,R:9,S:2,T:3,U:4,V:5,W:6,X:7,Y:8,Z:9};
  const W=[8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
  function cd(v){ if(!v||v.length!==17) return null; let s=0; for(let i=0;i<17;i++){ const c=v[i]; const val=/\d/.test(c)? +c : (T[c]||0); s+=val*W[i]; } const r=s%11; return r===10?'X':String(r); }
  function check(v){
    if(!v||v.length!==17){ vinCheck.className='badge warn'; vinCheck.textContent='Sin verificar'; return; }
    const got=v[8], exp=cd(v);
    if(exp===got){ vinCheck.className='badge ok'; vinCheck.textContent='Check digit OK'; }
    else { vinCheck.className='badge err'; vinCheck.textContent=`Check digit NO coincide (calc ${exp})`; }
  }

  // Decodificación básica
  function setBasic(res){
    const pick=(arr)=>{ for(const k of arr){ if(res[k]) return res[k]; } return null; };
    const orDash=(v)=> (v && String(v).trim()!=='') ? v : '(—)';

    const engineParts=[];
    if(res.EngineModel) engineParts.push(res.EngineModel);
    if(res.EngineConfiguration) engineParts.push(res.EngineConfiguration);
    if(res.EngineCylinders) engineParts.push(`${res.EngineCylinders} cilindros`);
    if(res.EngineHP) engineParts.push(`${res.EngineHP} HP`);
    else if(res.EngineKW) engineParts.push(`${res.EngineKW} kW`);
    if(res.DisplacementL) engineParts.push(`${res.DisplacementL} L`);
    else if(res.DisplacementCC) engineParts.push(`${res.DisplacementCC} cc`);
    else if(res.DisplacementCI) engineParts.push(`${res.DisplacementCI} ci`);

    const plantParts=[];
    if(res.ModelYear) plantParts.push(`Año: ${res.ModelYear}`);
    const loc=[res.PlantCity,res.PlantState,res.PlantCountry].filter(Boolean).join(', ');
    if(loc) plantParts.push(`Planta: ${loc}`);

    const gvwr = res.GVWR || res.GVWRFrom || res.GrossVehicleWeightRatingFrom || res.GrossVehicleWeightRatingTo || '';

    const trans = (res.TransmissionStyle && res.TransmissionSpeeds)
      ? `${res.TransmissionStyle} · ${res.TransmissionSpeeds} vel.`
      : (res.TransmissionStyle || res.TransmissionSpeeds || '');

    const wheel = res.WheelSizeFront || res.WheelSizeRear
      ? `Del.: ${res.WheelSizeFront||'—'} · Tras.: ${res.WheelSizeRear||'—'}`
      : (res.WheelBase || res.WheelBaseType || res.TireSize || res.TireSizeFront || res.TireSizeRear || '');

    fMake.textContent  = orDash(pick(['Make','Manufacturer','ManufacturerName']));
    fModel.textContent = orDash(res.Model);
    fEngine.textContent= orDash(engineParts.join(' · '));
    fPlant.textContent = orDash(plantParts.join(' · '));
    fGVWR.textContent  = orDash(gvwr);
    fColor.textContent = orDash(res.Color || res.ExteriorColor);
    fTrans.textContent = orDash(trans);
    fWheel.textContent = orDash(wheel);
  }

  async function decode(auto=false){
    const vin = sanitize(vinIn.value);
    const year = vinYear.value ? parseInt(vinYear.value,10) : null;
    if(!vin){ if(!auto) alert('Introduce un VIN válido.'); return; }
    check(vin);
    try{
      // Nota: vPIC pública
      let url = BASE + encodeURIComponent(vin) + '?format=json';
      if(year) url += '&modelyear='+encodeURIComponent(year);
      const r = await fetch(url);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      const res = data?.Results?.[0];
      if(!res){ alert('Sin resultados'); return; }
      setBasic(res);
    }catch(e){ alert('Error al decodificar: '+(e.message||e)); }
  }

  // OCR helpers
  async function initOCR(){
    if(worker) return;
    ocrStatus.textContent='Inicializando OCR…';
    worker=Tesseract.createWorker({ logger:m=>{
      if(m.status==='recognizing text' && m.progress!=null) ocrStatus.textContent=`OCR: ${(m.progress*100|0)}%`;
      else if(m.status) ocrStatus.textContent=`OCR: ${m.status}`;
    }});
    await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
    await worker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK });
    ocrStatus.textContent='OCR listo';
  }
  async function startCam(){
    if(stream) return;
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    video.srcObject=stream; ocrStatus.textContent='Cámara activa'; initOCR().catch(()=>{});
  }
  function stopCam(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; }
    if(scanTimer){ clearInterval(scanTimer); scanTimer=null; }
    ocrStatus.textContent='Cámara detenida';
  }
  // overlay draggable
  (function(){
    let down=false,sx=0,sy=0,ox=0,oy=0;
    overlay.addEventListener('pointerdown',e=>{
      down=true; overlay.setPointerCapture(e.pointerId);
      sx=e.clientX; sy=e.clientY;
      const rc=overlay.getBoundingClientRect(), pr=document.querySelector('.vin-video').getBoundingClientRect();
      ox=rc.left-pr.left; oy=rc.top-pr.top;
    });
    window.addEventListener('pointermove',e=>{
      if(!down) return;
      const pr=document.querySelector('.vin-video').getBoundingClientRect();
      let nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy);
      nx=Math.max(0,Math.min(nx,pr.width-overlay.offsetWidth));
      ny=Math.max(0,Math.min(ny,pr.height-overlay.offsetHeight));
      overlay.style.left=(nx/pr.width*100)+'%';
      overlay.style.top=(ny/pr.height*100)+'%';
      overlay.style.bottom='auto';
    });
    window.addEventListener('pointerup',()=>down=false);
  })();

  function frameCanvas(){
    const vw=video.videoWidth, vh=video.videoHeight;
    if(!vw||!vh) return null;
    const vr=video.getBoundingClientRect(), or=overlay.getBoundingClientRect();
    const sx=(or.left - vr.left) * (vw/vr.width);
    const sy=(or.top  - vr.top ) * (vh/vr.height);
    const sw=or.width * (vw/vr.width), sh=or.height * (vh/vr.height);
    const c=document.createElement('canvas'); c.width=sw; c.height=sh;
    const ctx=c.getContext('2d'); ctx.translate(c.width,0); ctx.scale(-1,1);
    ctx.drawImage(video, sx,sy,sw,sh, 0,0,c.width,c.height);
    return c;
  }

  async function doOCRfromVideo(){
    if(!stream){ ocrStatus.textContent='Cámara no iniciada'; return; }
    if(ocrRunning) return; ocrRunning=true;
    try{
      await initOCR(); const c=frameCanvas();
      if(!c){ ocrStatus.textContent='Esperando video…'; return; }
      const { data } = await worker.recognize(c.toDataURL('image/jpeg',.9));
      handleOcrText(data?.text||'');
    }catch(e){ ocrStatus.textContent='Error OCR: '+(e.message||e); }
    finally{ ocrRunning=false; }
  }

  async function doOCRfromFile(file){
    await initOCR();
    const img=new Image(); const url=URL.createObjectURL(file);
    img.onload=async ()=>{
      const maxW=1600, sc=Math.min(1, maxW/img.width);
      const c=document.createElement('canvas'); c.width=Math.round(img.width*sc); c.height=Math.round(img.height*sc);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const { data } = await worker.recognize(c.toDataURL('image/jpeg',.92));
      URL.revokeObjectURL(url);
      handleOcrText(data?.text||'');
    };
    img.onerror = ()=>{ URL.revokeObjectURL(url); ocrStatus.textContent='No se pudo leer la imagen.'; };
    img.src=url;
  }

  function handleOcrText(text){
    const txt=ocrFix(text); const cands=[]; let m;
    while((m=VIN_FULL.exec(txt))!==null) cands.push(m[1]);
    if(cands.length===0){
      const flat=(txt.match(VIN_CLEAN)||[]).join('');
      for(let i=0;i+17<=flat.length;i++) cands.push(flat.slice(i,i+17));
    }
    // elegir el mejor (check digit ok > unknown > invalid)
    let best=null,score=-1;
    for(const c of cands){
      const s=sanitize(c); if(s.length!==17) continue;
      const exp=cd(s), got=s[8];
      const sc = (exp===got)?2 : (exp?1:0);
      if(sc>score){ score=sc; best=s; }
      if(sc===2) break;
    }
    if(best){
      vinIn.value=best; check(best);
      ocrStatus.textContent='VIN detectado: '+best;
      decode(true);
    } else {
      ocrStatus.textContent='No se detectó VIN válido.';
    }
  }

  // Eventos VIN UI
  vinDecode.onclick = ()=>decode(false);
  vinClear.onclick = ()=>{
    vinIn.value=''; vinYear.value=''; check(null);
    [fMake,fModel,fEngine,fPlant,fGVWR,fColor,fTrans,fWheel].forEach(el=>el.textContent='(—)');
  };
  vinCopy.onclick = ()=>{
    const v=vinIn.value.trim(); if(!v) return alert('No hay VIN');
    navigator.clipboard?.writeText(v).then(()=>alert('VIN copiado'));
  };
  vinOpen.onclick = ()=>{
    const v=vinIn.value.trim(); if(!v) return alert('No hay VIN');
    window.open('https://vpic.nhtsa.dot.gov/decoder/?vin='+encodeURIComponent(v),'_blank');
  };

  // Integra con tu lectura OBD (ya tienes mode09_02)
  vinFromECU.onclick = async ()=>{
    try{
      const v = await mode09_02(); // usa tu misma función existente
      if(v){ vinIn.value=v; check(v); decode(true); }
      else alert('No se pudo leer el VIN por OBD.');
    }catch(e){ alert('Error OBD: '+(e.message||e)); }
  };

  // Cámara/OCR UI
  camStart.onclick = ()=>startCam().catch(e=>alert(e.message));
  camStop.onclick  = ()=>stopCam();
  capture.onclick  = ()=>doOCRfromVideo();
  scanAuto.addEventListener('change', ()=>{
    if(scanAuto.checked){
      const iv=Math.max(400, parseInt(scanInt.value,10)||1500);
      scanTimer=setInterval(()=>doOCRfromVideo(), iv);
      ocrStatus.textContent='Escaneo continuo activo';
    } else { if(scanTimer){ clearInterval(scanTimer); scanTimer=null; } ocrStatus.textContent='Escaneo continuo detenido'; }
  });
  vinFile.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) doOCRfromFile(f); });

  // Entra directo a la pantalla si viene de la Home
  // (el router ya existe; solo asegurarse de poder ir a 'vin')
})();

/* ====== Router: añade 'vin' a la lista ====== */
(function extendRouter(){
  const pagesArr = ['home','dash','scan','live','charts','ff','im','info','battery','maintenance','dtcinfo','protocols','infoplus','settings','upgrade','help','vin'];
  // Reemplaza la lista si aún no está; si ya tienes una var, ajústala:
  try{
    window.pages = pagesArr;
  }catch(e){}
})();
</script>
</body>
</html>
