<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Doctor Car Pro — OBD-II (ELM327)</title>

<!-- Color de barra (cambia dinámicamente según modo de fondo) -->
<meta name="theme-color" content="#0d0f15">

<!-- Librerías -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --ink:#e9edf4; --muted:#9aa4b2; --line:#253241;
  --pri:#1dd6b3; --pri2:#66f0cf; --acc:#7aa2f7;
  --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --radius:16px; --gap:14px; --shadow:0 12px 28px rgba(0,0,0,.35);
  --font: ui-sans-serif, system-ui, -apple-system, "SF Pro Text", Inter, Roboto, Arial;
}

/* ===== Modos de fondo ===== */
body.bg-transparent{ background: transparent !important; background-color: transparent !important; }
body.bg-dark{ background: linear-gradient(180deg,#0b0d13 0%, #0e111a 60%, #0d0f15 100%) !important; }

/* Base */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family:var(--font); color:var(--ink); letter-spacing:.2px}
body::before, body::after { content:none!important }

/* Header glass */
header{
  position:sticky; top:0; z-index:80;
  background:rgba(10,14,18,.35)!important;
  backdrop-filter:saturate(140%) blur(12px);
  -webkit-backdrop-filter:saturate(140%) blur(12px);
  border-bottom:1px solid rgba(255,255,255,.14)
}
.topbar{display:flex; align-items:center; gap:12px; padding:12px 14px}
.logo{width:36px; height:36px; border-radius:10px; background:#000; object-fit:cover}
.brand{font-weight:800}
.badge{font-size:12px; color:var(--muted)}
.grow{flex:1}

/* Botones */
.btn{ display:inline-flex; align-items:center; gap:8px; border-radius:12px; padding:9px 12px; cursor:pointer; border:1px solid var(--line) }
.btn.primary{ background:linear-gradient(180deg,var(--pri2),var(--pri)); color:#05211b; font-weight:800; border:none }
.btn.ghost{ background:rgba(17,24,37,.55); color:var(--ink); backdrop-filter: blur(8px) saturate(130%); -webkit-backdrop-filter: blur(8px) saturate(130%); }
.backBtn{display:none}
.tag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}

/* Layout */
.container{max-width:1100px; margin:18px auto; padding:0 14px}

/* Cards glass */
.card{
  background:rgba(15,25,34,.45);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px; margin-bottom:16px;
  backdrop-filter: blur(12px) saturate(140%);
  -webkit-backdrop-filter: blur(12px) saturate(140%);
}
.h{display:flex; align-items:center; gap:10px; margin-bottom:10px}
.h h2{margin:0; font-size:18px}
.row{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--gap)}
@media (max-width:900px){ .row{grid-template-columns:1fr} }

input,select,textarea{
  width:100%; padding:10px 12px;
  background:rgba(12,20,30,.55);
  color:var(--ink); border:1px solid var(--line); border-radius:12px; outline:none
}

/* Tablas / charts */
.table{width:100%; border-collapse:collapse; font-size:14px}
.table th,.table td{border-bottom:1px solid var(--line); padding:10px 8px; text-align:left}
.canvasWrap{
  background:rgba(12,20,30,.45);
  border:1px solid var(--line);
  border-radius:12px; padding:8px;
  backdrop-filter: blur(8px) saturate(120%);
  -webkit-backdrop-filter: blur(8px) saturate(120%);
}
.notice{padding:10px 12px; border:1px dashed var(--line); border-radius:10px; color:var(--muted)}
.hidden{display:none!important}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

/* HOME con iconos */
.homeGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
@media (max-width:900px){ .homeGrid{grid-template-columns:repeat(2,1fr)} }
.tile{
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
  padding:18px; min-height:140px; border-radius:16px;
  background:rgba(18,28,40,.45);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  transition:.08s transform, .1s outline;
  text-align:center; user-select:none; cursor:pointer;
  backdrop-filter: blur(10px) saturate(130%);
  -webkit-backdrop-filter: blur(10px) saturate(130%);
}
.tile:hover{ outline:2px solid var(--pri) } .tile:active{ transform:scale(.98) }
.tile .iconWrap{width:64px; height:64px; border-radius:14px; display:grid; place-items:center;
  background:rgba(11,17,28,.55); border:1px solid #223046;
  backdrop-filter: blur(8px) saturate(120%); -webkit-backdrop-filter: blur(8px) saturate(120%);
}
.tile svg{width:34px; height:34px}
.tile .title{font-weight:800} .tile .sub{font-size:12px; color:var(--muted)}

a.link{color:var(--acc); cursor:pointer; text-decoration:none}
a.link:hover{text-decoration:underline}

footer{opacity:.7; font-size:12px; text-align:center; padding:30px 0}

/* === Estilos específicos VIN (reutiliza tu glass UI) === */
.kv{ background:rgba(12,20,30,.55); border:1px solid var(--line); border-radius:12px; padding:10px 12px; }
.kv h4{margin:0 0 6px; font-size:.95rem; color:#cfe3ff; font-weight:700}
.kv p{margin:0; color:#cfe3ff}
.chip{ background:#132236; border:1px solid #244061; color:#cfe3ff; padding:8px 10px; border-radius:999px; font-weight:600; font-size:.88rem; display:inline-flex }

</style>
</head>

<body class="bg-dark">
<header>
  <div class="topbar">
    <button id="btnBackHome" class="btn ghost backBtn" title="Regresar al menú">← Menú principal</button>
    <img id="appLogo" class="logo" alt="Logo">
    <div>
      <div class="brand">Doctor Car Pro</div>
      <div class="badge">OBD-II • ELM327</div>
    </div>
    <span class="grow"></span>
    <span id="connStatus" class="tag">Desconectado</span>
    <button id="btnConnect" class="btn primary">Conectar</button>
    <button id="btnDisconnect" class="btn ghost hidden">Desconectar</button>
  </div>
</header>

<div class="container">
  <!-- ====== HOME ====== -->
  <section id="page-home" class="card">
    <div class="h"><h2>Menú principal</h2><span class="tag">Selecciona una función</span></div>
    <div class="homeGrid" id="homeGrid">
      <div class="tile" data-go="dash"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 12h4l2 4h4l2-4h2a2 2 0 0 0 2-2V8a3 3 0 0 0-3-3H7A3 3 0 0 0 4 8v2"/><circle cx="9" cy="16.5" r="1.5"/><circle cx="15" cy="16.5" r="1.5"/></svg>
      </div><div class="title">OBD-II / Panel</div><div class="sub">Conexión y lecturas</div></div>

      <div class="tile" data-go="scan"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 7h16M4 12h16M4 17h16"/><rect x="3" y="5" width="18" height="14" rx="2"/></svg>
      </div><div class="title">Escanear DTC</div><div class="sub">Leer / borrar</div></div>

      <div class="tile" data-go="live"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 12h4l3 6 4-12 3 6h4"/></svg>
      </div><div class="title">Datos en vivo</div><div class="sub">Stream PIDs</div></div>

      <div class="tile" data-go="charts"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 3v18h18"/><path d="M7 13l3 3 7-7"/></svg>
      </div><div class="title">Gráficas & PDF</div><div class="sub">Reporte</div></div>

      <div class="tile" data-go="battery"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="2" y="7" width="18" height="10" rx="2"/><path d="M22 10v4"/></svg>
      </div><div class="title">Battery Test</div><div class="sub">Voltaje 0142 + gráfica</div></div>

      <div class="tile" data-go="maintenance"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 7h18M6 7v13a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7"/><path d="M8 3h8v4H8z"/></svg>
      </div><div class="title">Maintenance</div><div class="sub">TPMS/Service/Oil/Key</div></div>

      <div class="tile" data-go="dtcinfo"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="9"/><path d="M12 8v5M12 16h.01"/></svg>
      </div><div class="title">DTC Library</div><div class="sub">Definiciones/causas</div></div>

      <div class="tile" data-go="protocols"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 12h16M12 4v16"/><circle cx="12" cy="12" r="9"/></svg>
      </div><div class="title">Protocols</div><div class="sub">ATSP rápido</div></div>

      <div class="tile" data-go="infoplus"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M6 7h12M6 12h12M6 17h12"/><rect x="3" y="4" width="18" height="16" rx="2"/></svg>
      </div><div class="title">Vehicle Info +</div><div class="sub">Specs/Recalls/Bulletins</div></div>

      <!-- ===== NUEVO: VIN DECODER ===== -->
      <div class="tile" data-go="vin"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10M7 12h6M7 16h3"/>
        </svg></div><div class="title">VIN Decoder</div><div class="sub">ISO 3779 + check digit</div></div>

      <div class="tile" data-go="settings"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.6 1.6 0 0 0 .3 1.8l.1.1a2 2 0 1 1-2.8 2.8l-.1-.1a1.6 1.6 0 0 0-1.8-.3 1.6 1.6 0 0 0-1 1.5V21a2 2 0 1 1-4 0v-.2a1.6 1.6 0 0 0-1-1.5 1.6 1.6 0 0 0-1.8.3l-.1.1a2 2 0 1 1-2.8-2.8l.1-.1a1.6 1.6 0 0 0 .3-1.8 1.6 1.6 0 0 0-1.5-1H3a2 2 0 1 1 0-4h.2a1.6 1.6 0 0 0 1.5-1z"/></svg>
      </div><div class="title">Configuración</div><div class="sub">Tema/Logo/Usuario</div></div>

      <div class="tile" data-go="upgrade"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>
      </div><div class="title">Upgrade</div><div class="sub">WhatsApp soporte</div></div>

      <div class="tile" data-go="help"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M9 9a3 3 0 0 1 6 0c0 3-3 3-3 6"/><path d="M12 17h.01"/><circle cx="12" cy="12" r="9"/></svg>
      </div><div class="title">Ayuda</div><div class="sub">Tips rápidos</div></div>
    </div>
  </section>

  <!-- ====== PANTALLAS BASE (IGUALES A TU ORIGINAL)… ====== -->
  <!-- Panel -->
  <section id="page-dash" class="card hidden">…</section>

  <!-- Escáner DTC -->
  <section id="page-scan" class="card hidden">…</section>

  <!-- Datos en vivo -->
  <section id="page-live" class="card hidden">…</section>

  <!-- Reportes & Gráficas -->
  <section id="page-charts" class="card hidden">…</section>

  <!-- Freeze Frame -->
  <section id="page-ff" class="card hidden">…</section>

  <!-- I/M readiness -->
  <section id="page-im" class="card hidden">…</section>

  <!-- Vehicle Info (Modo 09) -->
  <section id="page-info" class="card hidden">…</section>

  <!-- Battery Test -->
  <section id="page-battery" class="card hidden">…</section>

  <!-- Maintenance -->
  <section id="page-maintenance" class="card hidden">…</section>

  <!-- DTC Library -->
  <section id="page-dtcinfo" class="card hidden">…</section>

  <!-- Protocols (ATSP) -->
  <section id="page-protocols" class="card hidden">…</section>

  <!-- Vehicle Info + -->
  <section id="page-infoplus" class="card hidden">…</section>

  <!-- Configuración -->
  <section id="page-settings" class="card hidden">…</section>

  <!-- Upgrade -->
  <section id="page-upgrade" class="card hidden">…</section>

  <!-- Ayuda -->
  <section id="page-help" class="card hidden">…</section>

  <!-- ===== NUEVA PANTALLA: VIN DECODER ===== -->
  <section id="page-vin" class="card hidden">
    <div class="h"><h2>VIN Decoder</h2><span class="tag">ISO 3779 + dígito de control</span></div>
    <div class="row">
      <div class="card">
        <label><b>VIN (17 caracteres):</b></label>
        <input id="vinInput" class="mono" maxlength="17" placeholder="Ej: 1HGCM82633A004352" />
        <div class="notice">Se admiten 0–9 y A–Z (sin I, O, Q). Enter para decodificar.</div>
        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
          <button id="vinDecode" class="btn primary">Decodificar</button>
          <button id="vinClear" class="btn ghost">Limpiar</button>
          <button id="vinFrom0902" class="btn ghost">Rellenar con 0902</button>
          <button id="vinToggleBg" class="btn ghost">Fondo transparente</button>
          <button id="vinPdf" class="btn ghost">Imprimir / PDF</button>
        </div>
        <div id="vinStatus" style="margin-top:10px"></div>
      </div>
      <div class="card">
        <div class="row">
          <div class="kv">
            <h4>Fabricante (WMI)</h4><p id="kvWMI">—</p>
          </div>
          <div class="kv">
            <h4>País / Región</h4><p id="kvCR">—</p>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="kv"><h4>Año modelo (pos. 10)</h4><p id="kvYear">—</p></div>
          <div class="kv"><h4>Planta (pos. 11)</h4><p id="kvPlant">—</p></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="kv"><h4>VDS (4–9)</h4><p id="kvVDS">—</p></div>
          <div class="kv"><h4>VIS (10–17)</h4><p id="kvVIS">—</p></div>
        </div>
        <div class="kv" style="margin-top:10px">
          <h4>Número de serie (12–17)</h4><p id="kvSerial">—</p>
        </div>
      </div>
    </div>
  </section>
</div>

<footer>© <span id="year"></span> Doctor Car Pro</footer>

<!-- Login modal (igual que original) -->
<div id="loginModal" class="modal hidden" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:100">
  <div class="card" style="width:min(560px,92vw)">
    <div class="h"><h2>Bienvenido a Doctor Car Pro</h2></div>
    <p>Crea tu usuario local para proteger configuración y datos.</p>
    <div class="row">
      <div><label>Usuario</label><input id="mUser" placeholder="admin"></div>
      <div><label>Contraseña</label><input id="mPass" type="password" placeholder="••••••••"></div>
    </div>
    <div style="display:flex; gap:10px; margin-top:12px">
      <button id="mCreate" class="btn primary">Crear y entrar</button>
      <button id="mLater" class="btn ghost" style="margin-left:auto">Luego</button>
    </div>
  </div>
</div>
<script>
/* ====== Utils ====== */
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];
const log = t=>{ const c=$("#console"); if(!c) return; c.value += (t.endsWith("\n")? t : (t+"\n")); c.scrollTop=c.scrollHeight; };
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const BRAND_KEY='dcp.brand', AUTH_KEY='dcp.auth', PREF_KEY='dcp.prefs';

const S = {
  transport:'auto', conn:null, reader:null, writer:null,
  bleDev:null, bleTx:null, bleRx:null, serialPort:null,
  buffer:'', liveTimer:null, quickTimer:null, batTimer:null, logged:false,
  dtcLast:[], t0: Date.now(),
  series: { t:[], rpm:[], spd:[], ect:[], thr:[] }, maxPoints: 300,
  charts:{}
};

/* ====== Router ====== */
const pages=['home','dash','scan','live','charts','ff','im','info','battery','maintenance','dtcinfo','protocols','infoplus','settings','upgrade','help','vin'];
function go(p){
  pages.forEach(id=>$("#page-"+id)?.classList.add('hidden'));
  $("#page-"+p)?.classList.remove('hidden');
  $("#btnBackHome").style.display = (p!=='home')?'inline-flex':'none';
  window.scrollTo(0,0);
  savePrefs({ ...loadPrefs(), last:p });
}
$("#homeGrid").addEventListener('click',e=>{ const t=e.target.closest('.tile'); if(!t) return; go(t.dataset.go); });
$("#btnBackHome").onclick=()=>go('home');
$("#year").textContent=new Date().getFullYear();
go((JSON.parse(localStorage.getItem(PREF_KEY)||'{}').last)||'home');

/* ====== Branding & tema ====== */
function blobToDataURL(buf, type){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(new Blob([buf],{type})); }); }
function loadBrand(){ const x = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
  if (x.logo) $("#appLogo").src = x.logo;
  else $("#appLogo").src = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="black"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="#1dd6b3" font-family="Arial" font-size="34">DCP</text></svg>`);
  if (x.pri) document.documentElement.style.setProperty('--pri', x.pri);
  if (x.acc) document.documentElement.style.setProperty('--acc', x.acc);
}
loadBrand();
$("#logoFile")?.addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const b=await f.arrayBuffer(); const img=await blobToDataURL(b, f.type);
  const brand=JSON.parse(localStorage.getItem(BRAND_KEY)||'{}'); brand.logo=img;
  localStorage.setItem(BRAND_KEY, JSON.stringify(brand)); loadBrand();
});
$("#colorPri")?.addEventListener('input', e=> document.documentElement.style.setProperty('--pri', e.target.value));
$("#colorAcc")?.addEventListener('input', e=> document.documentElement.style.setProperty('--acc', e.target.value));
$("#btnSaveTheme")?.addEventListener('click', ()=>{ const b=JSON.parse(localStorage.getItem(BRAND_KEY)||'{}'); b.pri=$("#colorPri").value; b.acc=$("#colorAcc").value; localStorage.setItem(BRAND_KEY, JSON.stringify(b)); });
$("#btnResetTheme")?.addEventListener('click', ()=>{ localStorage.removeItem(BRAND_KEY); loadBrand(); });

/* ====== Preferencias (incluye modo de fondo) ====== */
function loadPrefs(){ return JSON.parse(localStorage.getItem(PREF_KEY)||'{}'); }
function savePrefs(p){ localStorage.setItem(PREF_KEY, JSON.stringify(p)); }
// aplicar modo de fondo en arranque
(function applyBgOnBoot(){
  const p=loadPrefs(), mode=p.bgMode || 'dark';
  document.body.classList.remove('bg-transparent','bg-dark');
  document.body.classList.add('bg-'+(mode==='transparent'?'transparent':'dark'));
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.setAttribute('content', mode==='transparent' ? 'transparent' : '#0d0f15');
  const sel = $("#bgMode"); if(sel) sel.value = mode;
})();
$("#bgMode")?.addEventListener('change', e=>{
  const mode=e.target.value;
  document.body.classList.remove('bg-transparent','bg-dark');
  document.body.classList.add('bg-'+(mode==='transparent'?'transparent':'dark'));
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.setAttribute('content', mode==='transparent' ? 'transparent' : '#0d0f15');
  savePrefs({ ...loadPrefs(), bgMode: mode });
});
// restaurar transporte
(function restorePrefs(){ const p=loadPrefs(); if(p.transport && $("#transport")) $("#transport").value=p.transport; })();

/* ====== Compatibilidad ====== */
(function showCompat(){ const b=[]; b.push(('serial' in navigator)?'Web Serial disponible':'Web Serial no disponible'); b.push((navigator.bluetooth)?'Web Bluetooth disponible':'Web Bluetooth no disponible'); $("#compatNote") && ($("#compatNote").innerHTML=b.join(' • ') + '.'); })();

/* ====== Login local ====== */
function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return 'H'+(h>>>0).toString(16); }
function authState(){ const a=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}'); S.logged=!!a.user; $("#authState") && ($("#authState").textContent=S.logged?`Autenticado como ${a.user}`:'No autenticado'); }
authState();
$("#btnRegister")?.addEventListener('click',()=>{ const u=$("#uUser").value.trim(), p=$("#uPass").value; if(!u||!p) return alert('Usuario y contraseña requeridos'); localStorage.setItem(AUTH_KEY, JSON.stringify({user:u, pass:hash(p)})); authState(); alert('Usuario guardado'); });
$("#btnLogin")?.addEventListener('click',()=>{ const u=$("#uUser").value.trim(), p=$("#uPass").value; const a=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}'); if(a.user===u && a.pass===hash(p)){ S.logged=true; $("#loginModal").classList.add('hidden'); authState(); } else alert('Credenciales inválidas'); });
$("#btnLogout")?.addEventListener('click',()=>{ localStorage.removeItem(AUTH_KEY); authState(); });
$("#mCreate")?.addEventListener('click',()=>{ const u=$("#mUser").value.trim(), p=$("#mPass").value; if(!u||!p) return alert('Completa usuario y contraseña'); localStorage.setItem(AUTH_KEY, JSON.stringify({user:u, pass:hash(p)})); $("#loginModal").classList.add('hidden'); authState(); });
$("#mLater")?.addEventListener('click',()=> $("#loginModal").classList.add('hidden'));
if (!localStorage.getItem(AUTH_KEY)) $("#loginModal")?.classList.remove('hidden');

/* ====== Transporte ====== */
const Transport = {
  async connect(kind){
    S.transport=kind||($("#transport")?.value||'auto');
    savePrefs({ ...loadPrefs(), transport:S.transport });
    if (S.transport==='serial' || (S.transport==='auto' && 'serial' in navigator)) return await TransportSerial.connect();
    else if (S.transport==='ble' || (S.transport==='auto' && navigator.bluetooth)) return await TransportBLE.connect();
    else if (S.transport==='demo') return await TransportDemo.connect();
    else throw new Error('No hay transporte compatible. Prueba Web Serial (Chrome desktop) o BLE compatible.');
  },
  async disconnect(){ await TransportSerial.disconnect(); await TransportBLE.disconnect(); await TransportDemo.disconnect(); S.conn=null; S.writer=null; S.reader=null; $("#connStatus").textContent='Desconectado'; $("#btnConnect").classList.remove('hidden'); $("#btnDisconnect").classList.add('hidden'); },
  async write(line){ const txt=line.endsWith('\r')? line : line+'\r'; log('> '+line); if(S.writer){ await S.writer(txt); } else throw new Error('No hay writer activo'); },
  async request(line, timeout=1700){ await Transport.write(line); return await Transport.readUntil('>', timeout); },
  async readUntil(term='>', timeout=1700){ const started=Date.now(); while(Date.now()-started<timeout){ const chunk=await Transport.readChunk(timeout-(Date.now()-started)); if(chunk){ S.buffer+=chunk; const idx=S.buffer.lastIndexOf(term); if(idx>=0){ const out=S.buffer.slice(0,idx); S.buffer=S.buffer.slice(idx+term.length); return clean(out); } } else { await sleep(20); } } return clean(S.buffer); },
  async readChunk(){ return null; }
};
const TransportSerial = {
  async connect(){ if(!('serial' in navigator)) throw new Error('Web Serial no disponible');
    S.serialPort = await navigator.serial.requestPort();
    await S.serialPort.open({ baudRate: 38400 });
    const dec = new TextDecoderStream(); S.serialPort.readable.pipeTo(dec.writable); const reader = dec.readable.getReader();
    S.reader = async ()=>{ const {value,done}=await reader.read(); if(done) return null; return value||null; };
    const enc = new TextEncoderStream(); enc.readable.pipeTo(S.serialPort.writable); const writer = enc.writable.getWriter(); S.writer = async (txt)=>{ writer.write(txt); };
    S.conn='serial'; $("#connStatus").textContent='Conectado (Serial)'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[Serial] Conectado.'); return true;
  },
  async disconnect(){ try{ if(S.serialPort){ await S.serialPort.close(); S.serialPort=null; } }catch(e){} }
};
const BLE_UUID={ svc:'6e400001-b5a3-f393-e0a9-e50e24dcca9e', tx:'6e400002-b5a3-f393-e0a9-e50e24dcca9e', rx:'6e400003-b5a3-f393-e0a9-e50e24dcca9e' };
const TransportBLE = {
  async connect(){ if(!navigator.bluetooth) throw new Error('Web Bluetooth no disponible');
    S.bleDev = await navigator.bluetooth.requestDevice({ filters:[{services:[BLE_UUID.svc]}], optionalServices:[BLE_UUID.svc] });
    const server = await S.bleDev.gatt.connect(); const svc = await server.getPrimaryService(BLE_UUID.svc);
    S.bleTx = await svc.getCharacteristic(BLE_UUID.tx); S.bleRx = await svc.getCharacteristic(BLE_UUID.rx);
    await S.bleRx.startNotifications(); let queue=''; S.bleRx.addEventListener('characteristicvaluechanged', e=>{ const v=new TextDecoder().decode(e.target.value); queue+=v; });
    S.reader = async ()=>{ await sleep(60); if(queue){ const z=queue; queue=''; return z; } return ''; };
    S.writer = async (txt)=>{ const data=new TextEncoder().encode(txt); for(let i=0;i<data.length;i+=20){ await S.bleTx.writeValueWithoutResponse(data.slice(i,i+20)); await sleep(8);} };
    S.conn='ble'; $("#connStatus").textContent='Conectado (BLE)'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[BLE] Conectado.'); return true;
  },
  async disconnect(){ try{ if(S.bleDev && S.bleDev.gatt.connected) S.bleDev.gatt.disconnect(); S.bleDev=null; S.bleTx=null; S.bleRx=null; }catch(e){} }
};
const TransportDemo = { async connect(){ S.reader=async()=>{ await sleep(50); return ''; }; S.writer=async()=>{}; S.conn='demo'; $("#connStatus").textContent='Demo'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[Demo] Modo demostración activo.'); return true; }, async disconnect(){} };

function clean(s){ return s.replace(/\r/g,'').replace(/ELM327 v[^\n]+\n?/i,'').replace(/^>/gm,'').replace(/\n\n+/g,'\n').trim(); }

/* ====== OBD helpers ====== */
async function initECU(){
  await Transport.request('ATZ',1800); await sleep(300);
  await Transport.request('ATE0'); await Transport.request('ATL0'); await Transport.request('ATS0'); await Transport.request('ATH0'); await Transport.request('ATSP0');
  const pids = await Transport.request('0100'); $("#kPID")?.textContent = pids.split('\n').pop() || pids.slice(-64);
  const vin = await mode09_02(); $("#kVIN")?.textContent = vin||'—';
  try{ const prot=await Transport.request('ATDP'); $("#kProto")?.textContent = prot.split('\n').pop() || prot; }catch(e){}
  try{ const v=await pid0142(); if(v!=null){ $("#kVBAT")?.textContent = v.toFixed(2)+' V'; $("#dVBAT") && ($("#dVBAT").textContent = v.toFixed(2)+' V'); } }catch(e){}
}
async function sendReq(cmd){ return await Transport.request(cmd); }
function hexToBytes(h){ h=h.replace(/\s/g,''); const a=[]; for(let i=0;i<h.length;i+=2)a.push(parseInt(h.substr(i,2),16)); return a; }
function parseLines(resp){ return resp.split('\n').map(x=>x.trim()).filter(Boolean); }
function lastDataLine(resp,prefix){ const lines=parseLines(resp).filter(x=>x && (!prefix || x.startsWith(prefix))); return lines.length? lines[lines.length-1]:''; }
function parseOBD(prefix, resp){ const l=lastDataLine(resp,prefix).replace(/^([0-9A-F]{2}\s*){2}/i,'').trim(); return hexToBytes(l.replace(/\s/g,'')); }
/* PIDs */
async function pid010C(){ const r=await sendReq('010C'); const b=parseOBD('41 0C',r); if(b.length>=2){ return ((b[0]<<8)|b[1])/4; } return null; }
async function pid010D(){ const r=await sendReq('010D'); const b=parseOBD('41 0D',r); if(b.length>=1) return b[0]; return null; }
async function pid0105(){ const r=await sendReq('0105'); const b=parseOBD('41 05',r); if(b.length>=1) return b[0]-40; return null; }
async function pid0111(){ const r=await sendReq('0111'); const b=parseOBD('41 11',r); if(b.length>=1) return (b[0]*100/255); return null; }
/* 0142 — Control Module Voltage (A*256 + B)/1000 V */
async function pid0142(){ const r=await sendReq('0142'); const b=parseOBD('41 42',r); if(b.length>=2){ return ((b[0]<<8)|b[1])/1000; } return null; }

async function readIM(){ const r=await sendReq('0101'); $("#imOut") && ($("#imOut").textContent=r||'—'); }
async function mode09_02(){
  const r=await sendReq('0902');
  $("#infoOut") && ($("#infoOut").textContent=r);
  const lines=parseLines(r).filter(x=>x.match(/^49 02/i)); let bytes=[];
  lines.forEach(line=>{ const parts=line.replace(/^49 02 [0-9A-F]{2}\s*/i,'').trim(); bytes=bytes.concat(hexToBytes(parts)); });
  const ascii=bytes.filter(b=>b>=0x20 && b<=0x7E);
  const vin=new TextDecoder().decode(new Uint8Array(ascii)).trim();
  return vin||'';
}

/* ====== DTC ====== */
function dtcFromBytes(arr){ const out=[]; for(let i=0;i+1<arr.length;i+=2){ const A=arr[i],B=arr[i+1]; const sys=['P','C','B','U'][(A & 0xC0)>>6]; const d1=(A & 0x30)>>4; const d2=(A & 0x0F); const code=sys + d1 + d2 + ((B>>4)&0x0F) + (B&0x0F); if(code!=='P0000') out.push(code); } return out; }
const DTC_DESC={ "P0300":"Random/Multiple Cylinder Misfire Detected","P0301":"Cylinder 1 Misfire Detected","P0171":"System Too Lean (Bank 1)","P0172":"System Too Rich (Bank 1)","P0118":"ECT Sensor High","P0117":"ECT Sensor Low","P0101":"MAF Range/Performance","P0420":"Catalyst Efficiency Below Threshold (B1)","P0430":"Catalyst Efficiency Below Threshold (B2)","P0440":"EVAP System","P0130":"O2 Sensor B1S1 Circuit","P0122":"Throttle/Pedal Position Sensor A Low" };
const DTC_CAUSES={ "P0171":["Vacío/fugas en admisión","MAF sucio o defectuoso","Baja presión de combustible","Sensor O2 sesgado"], "P0300":["Bujías/bobinas defectuosas","Fugas de vacío","Inyectores sucios","Baja presión de combustible"], "P0420":["Catalizador degradado","O2 posterior defectuoso","Fugas de escape antes del catalizador"], "P0122":["TPS fuera de rango","Cableado/cortos TPS","Conector flojo o sulfatado"] };
function renderDTC(list, where){
  const wrap=$(where);
  if(!wrap) return;
  if(!list.length){ wrap.innerHTML=`<div class="notice">Sin códigos.</div>`; return; }
  const rows=list.map(c=>{
    const d=DTC_DESC[c]||'Descripción genérica no encontrada.';
    return `<tr><td class="mono"><a class="link" data-dtc="${c}">${c}</a></td><td>${d}</td></tr>`;
  }).join('');
  wrap.innerHTML=`<table class="table"><thead><tr><th>Código</th><th>Descripción</th></tr></thead><tbody>${rows}</tbody></table>`;
  wrap.querySelectorAll('a[data-dtc]').forEach(a=>a.onclick=()=>openDtcInfo(a.dataset.dtc));
}

/* ====== UI / eventos base ====== */
$("#btnConnect")?.addEventListener('click', async ()=>{ try{ await Transport.connect($("#transport")?.value||'auto'); }catch(e){ alert(e.message); log('[ERROR] '+e.message);} });
$("#btnDisconnect")?.addEventListener('click', async ()=>{ await Transport.disconnect(); });
$("#btnInit")?.addEventListener('click', async ()=>{ if(!S.conn){ alert('Conéctate primero'); return; } try{ await initECU(); log('[OK] ECU inicializada.'); }catch(e){ log('[ERROR] init: '+e.message);} });
$("#btnClearLog")?.addEventListener('click', ()=> $("#console").value='');

$$('button[data-at]').forEach(b=> b.onclick = async ()=> { if(!S.conn) return alert('Conéctate primero'); const cmd=b.getAttribute('data-at'); const r=await Transport.request(cmd); log(r); });
$$('button[data-req]').forEach(b=> b.onclick = async ()=>{ if(!S.conn) return alert('Conéctate primero'); const cmd=b.getAttribute('data-req'); const r=await Transport.request(cmd); log(r); });

/* Quick poll */
$("#btnQuickPoll")?.addEventListener('click', async ()=>{
  if(!S.conn) return alert('Conéctate primero');
  clearInterval(S.quickTimer);
  S.quickTimer = setInterval(async ()=>{
    try{
      const [rpm,spd,ect,thr,vbat]=await Promise.all([pid010C(),pid010D(),pid0105(),pid0111(),pid0142()]);
      updateMini(rpm,spd,ect,thr,vbat);
    }catch(e){}
  }, 800);
  setTimeout(()=> clearInterval(S.quickTimer), 5000);
});
$("#btnStopPoll")?.addEventListener('click', ()=> clearInterval(S.quickTimer));

/* Live streaming */
function updateMini(rpm,spd,ect,thr,vbat){
  const d=(sel,val)=>{ const el=$(sel); if(el && val!=null) el.textContent=val; };
  if(rpm!=null) d("#dRPM", `${rpm.toFixed(0)} rpm`);
  if(spd!=null) d("#dSPD", `${spd} km/h`);
  if(ect!=null) d("#dECT", `${ect} °C`);
  if(thr!=null) d("#dTHR", `${thr.toFixed(0)} %`);
  if(vbat!=null){ d("#dVBAT", `${vbat.toFixed(2)} V`); d("#kVBAT", `${vbat.toFixed(2)} V`); }
  const t=(Date.now()-S.t0)/1000;
  S.series.t.push(t); S.series.rpm.push(rpm??null); S.series.spd.push(spd??null); S.series.ect.push(ect??null); S.series.thr.push(thr??null);
  Object.keys(S.series).forEach(k=>{ if(Array.isArray(S.series[k]) && S.series[k].length>S.maxPoints){ S.series[k].shift(); } });
  refreshCharts();
}
$("#btnStartLive")?.addEventListener('click', async ()=>{
  if(!S.conn) return alert('Conéctate primero');
  const rate = +$("#liveRate").value || 500;
  clearInterval(S.liveTimer);
  if(!S.charts.rpm) initCharts();
  S.liveTimer = setInterval(async ()=>{
    try{
      const [rpm,spd,ect,thr]=await Promise.all([pid010C(),pid010D(),pid0105(),pid0111()]);
      $("#liveRPM") && ($("#liveRPM").textContent = rpm!=null? `${rpm.toFixed(0)} rpm`:'—');
      $("#liveSPD") && ($("#liveSPD").textContent = spd!=null? `${spd} km/h`:'—');
      $("#liveECT") && ($("#liveECT").textContent = ect!=null? `${ect} °C`:'—');
      $("#liveTHR") && ($("#liveTHR").textContent = thr!=null? `${thr.toFixed(0)} %`:'—');
      updateMini(rpm,spd,ect,thr,null);
    }catch(e){}
  }, rate);
});
$("#btnStopLive")?.addEventListener('click', ()=> clearInterval(S.liveTimer));

/* DTC scan */
$("#btnScanDTC")?.addEventListener('click', async ()=>{
  if(!S.conn) return alert('Conéctate primero');
  const r = await Transport.request('03', 3000); log(r);
  const lines = parseLines(r).filter(x=>x.match(/^43 /i));
  let bytes=[]; lines.forEach(line=>{ const body=line.replace(/^43\s*/i,'').trim(); bytes=bytes.concat(hexToBytes(body.replace(/\s/g,''))); });
  const list = dtcFromBytes(bytes); S.dtcLast = list; renderDTC(list, "#dtcList");
  $("#dDTC") && ($("#dDTC").textContent = list.length? list.join(', '): 'Ninguno');
});
$("#btnClearDTC")?.addEventListener('click', async ()=>{
  if(!S.conn) return alert('Conéctate primero');
  if(!confirm('¿Seguro que deseas borrar DTC (04)?')) return;
  const r=await Transport.request('04',3000); log(r); alert('Solicitud de borrado enviada.');
  $("#dtcList") && ($("#dtcList").innerHTML=''); $("#dDTC") && ($("#dDTC").textContent='—'); S.dtcLast=[];
});
$("#btnReadPending")?.addEventListener('click', async ()=>{ if(!S.conn) return alert('Conéctate primero'); const r=await Transport.request('07',3000); alert('Pendientes:\n'+r); });
$("#btnReadPermanent")?.addEventListener('click', async ()=>{ if(!S.conn) return alert('Conéctate primero'); const r=await Transport.request('0A',3000); alert('Permanentes:\n'+r); });

/* Freeze / IM / Info */
$("#btnFF")?.addEventListener('click', async ()=>{ if(!S.conn) return alert('Conéctate primero'); const r=await Transport.request('02',3000); $("#ffOut") && ($("#ffOut").textContent=r); });
$("#btnIM")?.addEventListener('click', readIM);
$("#btnVIN")?.addEventListener('click', async ()=>{ const v=await mode09_02(); $("#infoOut") && ($("#infoOut").textContent='VIN: '+(v||'—')); $("#kVIN") && ($("#kVIN").textContent=v||'—'); $("#vSpecVin") && ($("#vSpecVin").value=v||''); });
$("#btnCALID")?.addEventListener('click', async ()=>{ const r=await Transport.request('0904'); const r2=await Transport.request('0906'); $("#infoOut") && ($("#infoOut").textContent=r+'\n'+r2); });
$("#btnECUName")?.addEventListener('click', async ()=>{ const r=await Transport.request('090A'); $("#infoOut") && ($("#infoOut").textContent=r); });
$("#vSpecFill")?.addEventListener('click',()=>{ const vin=$("#kVIN")?.textContent; if(vin && vin!=='—') $("#vSpecVin").value=vin; });

/* ====== Chart.js ====== */
function makeCfg(label){
  return { type:'line',
    data:{ labels:S.series.t, datasets:[{ label, data:[], borderWidth:2, pointRadius:0, tension:.25 }]},
    options:{ animation:false, responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{labels:{color:'#e7eaf3'}}},
      scales:{ x:{ ticks:{color:'#c7ccd7'}, grid:{color:'#223046'} },
               y:{ ticks:{color:'#c7ccd7'}, grid:{color:'#223046'} } } } };
}
function initCharts(){
  S.charts.rpm = new Chart(document.getElementById('chartRPM').getContext('2d'), makeCfg('RPM'));
  S.charts.spd = new Chart(document.getElementById('chartSPD').getContext('2d'), makeCfg('Velocidad'));
  S.charts.ect = new Chart(document.getElementById('chartECT').getContext('2d'), makeCfg('ECT °C'));
  S.charts.thr = new Chart(document.getElementById('chartTHR').getContext('2d'), makeCfg('Throttle %'));
}
function refreshCharts(){
  if(!S.charts.rpm) return;
  S.charts.rpm.data.labels = S.series.t;   S.charts.rpm.data.datasets[0].data = S.series.rpm;   S.charts.rpm.update('none');
  S.charts.spd.data.labels = S.series.t;   S.charts.spd.data.datasets[0].data = S.series.spd;   S.charts.spd.update('none');
  S.charts.ect.data.labels = S.series.t;   S.charts.ect.data.datasets[0].data = S.series.ect;   S.charts.ect.update('none');
  S.charts.thr.data.labels = S.series.t;   S.charts.thr.data.datasets[0].data = S.series.thr;   S.charts.thr.update('none');
}
$("#btnClearSeries")?.addEventListener('click', ()=>{ S.series = { t:[], rpm:[], spd:[], ect:[], thr:[] }; S.t0=Date.now(); refreshCharts(); });

/* ====== PDF ====== */
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const margin=36, line=18; let y=margin;
  const brand = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
  if(brand.logo){ try{ doc.addImage(brand.logo,'PNG', margin, y, 90, 90); }catch(e){} }
  doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text('Doctor Car Pro — Reporte de Diagnóstico', margin+100, y+20);
  doc.setFontSize(10); doc.setFont('helvetica','normal'); const now=new Date(); doc.text(now.toLocaleString(), margin+100, y+40); y += 100;
  const proto=$("#kProto")?.textContent||'—', vin=$("#kVIN")?.textContent||'—', vbat=$("#dVBAT")?.textContent||'—';
  doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Datos del vehículo', margin, y); y+=line;
  doc.setFont('helvetica','normal'); doc.text(`VIN: ${vin}`, margin, y); y+=line;
  doc.text(`Protocolo: ${proto}`, margin, y); y+=line;
  doc.text(`Voltaje módulo: ${vbat}`, margin, y); y+=line;
  const rpm=$("#dRPM")?.textContent||'—', spd=$("#dSPD")?.textContent||'—', ect=$("#dECT")?.textContent||'—', thr=$("#dTHR")?.textContent||'—';
  y+=line/2; doc.setFont('helvetica','bold'); doc.text('Lecturas actuales', margin, y); y+=line;
  doc.setFont('helvetica','normal'); doc.text(`RPM: ${rpm}`, margin, y); y+=line;
  doc.text(`Velocidad: ${spd}`, margin, y); y+=line;
  doc.text(`ECT: ${ect}`, margin, y); y+=line;
  doc.text(`Throttle: ${thr}`, margin, y); y+=line;
  y+=line/2; doc.setFont('helvetica','bold'); doc.text('Códigos DTC', margin, y); y+=line;
  doc.setFont('helvetica','normal');
  if(S.dtcLast.length){ S.dtcLast.forEach(c=>{ const d=DTC_DESC[c]||''; doc.text(`• ${c} ${d?('- '+d):''}`, margin, y); y+=line; }); }
  else { doc.text('Sin códigos activos.', margin, y); y+=line; }
  const cliente=$("#pdfCliente")?.value||'', notas=$("#pdfNotas")?.value||'';
  y+=line/2; doc.setFont('helvetica','bold'); doc.text('Cliente / Notas', margin, y); y+=line;
  doc.setFont('helvetica','normal'); if(cliente){ doc.text(`Cliente: ${cliente}`, margin, y); y+=line; }
  if(notas){ const split=doc.splitTextToSize(notas,520); doc.text(split, margin, y); y+=split.length*line; } else { doc.text('—', margin, y); y+=line; }
  if(S.charts.rpm){
    const w=240,h=140;
    try{ doc.addImage(S.charts.rpm.toBase64Image(),'PNG', margin, y, w, h);}catch(e){}
    try{ doc.addImage(S.charts.spd.toBase64Image(),'PNG', margin+w+20, y, w, h);}catch(e){}
    y+=h+10;
    try{ doc.addImage(S.charts.ect.toBase64Image(),'PNG', margin, y, w, h);}catch(e){}
    try{ doc.addImage(S.charts.thr.toBase64Image(),'PNG', margin+w+20, y, w, h);}catch(e){}
    y+=h+10;
  }
  doc.setFont('helvetica','italic'); doc.setFontSize(9);
  doc.text('Generado por Doctor Car Pro — OBD-II (uso informativo; no sustituye diagnóstico del fabricante).', margin, 812);
  doc.save(`DoctorCarPro_${(vin||'vehiculo').replace(/\s/g,'')}_${new Date().toISOString().slice(0,10)}.pdf`);
}
$("#btnGenPDF")?.addEventListener('click', generatePDF);

/* ====== Battery Test ====== */
let batChart=null;
function batSetState(v,rpm){
  let state='—';
  if((rpm||0)>600){
    if(v>=13.5 && v<=14.7) state='Charging OK';
    else if(v<13.2) state='Low charge';
    else if(v>15) state='Overcharge';
    else state='Check alternator';
  }else{
    if(v>=12.6) state='Good';
    else if(v>=12.2) state='Fair';
    else state='Weak';
  }
  $("#batState") && ($("#batState").textContent=state);
}
function initBatChart(){
  const ctx=document.getElementById('chartBAT').getContext('2d');
  batChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{ label:'Voltaje (V)', data:[], borderWidth:2, pointRadius:0, tension:.25 }]},
    options:{ animation:false, responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{labels:{color:'#e7eaf3'}}},
      scales:{ x:{ grid:{color:'#223046'}, ticks:{color:'#c7ccd7'} },
               y:{ grid:{color:'#223046'}, ticks:{color:'#c7ccd7'} } } }
  });
}
$("#batStart")?.addEventListener('click', async ()=>{
  if(!S.conn) return alert('Conéctate primero');
  if(!batChart) initBatChart();
  batChart.data.labels=[]; batChart.data.datasets[0].data=[]; batChart.update('none');
  clearInterval(S.batTimer);
  S.batTimer=setInterval(async()=>{
    try{
      const [v,rpm]=await Promise.all([pid0142(),pid010C()]);
      if(v!=null){
        $("#batV") && ($("#batV").textContent=v.toFixed(2)+' V');
        const t=new Date().toLocaleTimeString();
        batChart.data.labels.push(t);
        batChart.data.datasets[0].data.push(+v.toFixed(2));
        batChart.update('none');
      }
      if(rpm!=null){ $("#batRPM") && ($("#batRPM").textContent=rpm.toFixed(0)); }
      batSetState(v||0, rpm||0);
    }catch(e){}
  }, 800);
});
$("#batStop")?.addEventListener('click', ()=> clearInterval(S.batTimer));

/* ====== Protocols quick set ====== */
$$('button[data-sp]').forEach(b=> b.onclick = async ()=>{
  if(!S.conn) return alert('Conéctate primero');
  const n=b.getAttribute('data-sp'); const r=await Transport.request('ATSP'+n,2000); log(r);
  alert('Protocolo forzado: ATSP'+n);
});
$("#spAuto")?.addEventListener('click', async()=>{ if(!S.conn) return alert('Conéctate primero'); const r=await Transport.request('ATSP0',2000); log(r); alert('Protocolo en Auto (ATSP0)'); });

/* ====== DTC Library ====== */
function openDtcInfo(code){
  go('dtcinfo');
  const desc=DTC_DESC[code]||'Descripción no disponible.';
  const causes=DTC_CAUSES[code]||['Revise cableado/conectores','Verifique sensores relacionados','Compruebe fugas al vacío / escape'];
  $("#dtcQuery") && ($("#dtcQuery").value=code);
  $("#dtcResult") && ($("#dtcResult").innerHTML=`<div class="card"><h3 style="margin:0 0 8px 0">${code}</h3><div>${desc}</div><h4 style="margin:10px 0 6px 0">Posibles causas</h4><ul>${causes.map(c=>`<li>${c}</li>`).join('')}</ul></div>`);
}
$("#dtcSearch")?.addEventListener('click',()=>{ const c=$("#dtcQuery").value.trim().toUpperCase(); if(!c) return; openDtcInfo(c); });

/* ====== Nota iOS ====== */
(function boot(){ const ua=navigator.userAgent; const isIOS=/iPad|iPhone|iPod/.test(ua)&&!window.MSStream; if (isIOS && $("#compatNote")) $("#compatNote").innerHTML += '<br>iOS: Web Serial no disponible; BLE limitado.'; })();

/* =================================================================== */
/* =========================  VIN DECODER  ============================ */
/* =================================================================== */
const VIN = (()=>{

  const translit = {
    A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,    J:1,K:2,L:3,M:4,N:5,      P:7,      R:9,
    S:2,T:3,U:4,V:5,W:6,X:7,Y:8,Z:9,
    '0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9
  };
  const weights = [8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];

  const yearMap = (() => {
    const seq = "ABCDEFGHJKLMNPRSTVWXY123456789";
    const map = {};
    let year = 1980;
    for (let cycle = 0; cycle < 2; cycle++){
      for (const ch of seq){ map[ch] = year++; }
    }
    return map;
  })();

  const WMI = [
    {wmi:"1HG", make:"Honda", country:"USA", region:"Norteamérica"},
    {wmi:"2HG", make:"Honda", country:"Canadá", region:"Norteamérica"},
    {wmi:"JHM", make:"Honda", country:"Japón", region:"Asia"},
    {wmi:"1NX", make:"Toyota", country:"USA", region:"Norteamérica"},
    {wmi:"2T",  make:"Toyota", country:"Canadá", region:"Norteamérica"},
    {wmi:"3T",  make:"Toyota", country:"México", region:"Norteamérica"},
    {wmi:"JTD", make:"Toyota", country:"Japón", region:"Asia"},
    {wmi:"JT",  make:"Toyota", country:"Japón", region:"Asia"},
    {wmi:"1N4", make:"Nissan", country:"USA", region:"Norteamérica"},
    {wmi:"3N",  make:"Nissan", country:"México", region:"Norteamérica"},
    {wmi:"JN",  make:"Nissan", country:"Japón", region:"Asia"},
    {wmi:"1FA", make:"Ford", country:"USA", region:"Norteamérica"},
    {wmi:"1G",  make:"General Motors", country:"USA", region:"Norteamérica"},
    {wmi:"2G",  make:"General Motors", country:"Canadá", region:"Norteamérica"},
    {wmi:"1C4", make:"Chrysler/Dodge/Jeep", country:"USA", region:"Norteamérica"},
    {wmi:"5YJ", make:"Tesla", country:"USA", region:"Norteamérica"},
    {wmi:"JF", make:"Subaru", country:"Japón", region:"Asia"},
    {wmi:"JM", make:"Mazda", country:"Japón", region:"Asia"},
    {wmi:"JA", make:"Mitsubishi", country:"Japón", region:"Asia"},
    {wmi:"5NP", make:"Hyundai", country:"USA", region:"Norteamérica"},
    {wmi:"KMH", make:"Hyundai", country:"Corea", region:"Asia"},
    {wmi:"KNM", make:"Kia", country:"Corea", region:"Asia"},
  ];

  const sanitize = s => (s||"").toUpperCase().replace(/[^A-Z0-9]/g,"");

  function computeCheckDigit(vin){
    let sum=0;
    for(let i=0;i<17;i++){
      const ch=vin[i]; const val=translit[ch]; if(val===undefined) return null;
      sum += val * weights[i];
    }
    const mod = sum % 11;
    return mod === 10 ? 'X' : String(mod);
  }

  function validate(vin){
    if (vin.length !== 17) return {ok:false, reason:"El VIN debe tener 17 caracteres."};
    if (/[IOQ]/.test(vin)) return {ok:false, reason:"No se permiten I, O, Q en un VIN válido."};
    if (!/^[A-Z0-9]+$/.test(vin)) return {ok:false, reason:"Solo A–Z y 0–9."};
    const expected = computeCheckDigit(vin);
    if (expected === null) return {ok:false, reason:"Caracter inválido."};
    const actual = vin[8];
    if (actual !== expected) return {ok:false, reason:`Dígito de control inválido. Esperado ${expected}, encontrado ${actual}.`};
    return {ok:true};
  }

  function inferRegion(c){
    if ("12345".includes(c)) return "Norteamérica";
    if ("678".includes(c)) return "Oceanía/África";
    if (c==="9") return "Sudamérica";
    if (c==="J") return "Asia"; if (c==="K") return "Asia";
    if (c==="S") return "Europa"; if (c==="W") return "Europa"; if (c==="Z") return "Europa";
    return "—";
  }
  function inferCountry(c){
    if (c==="1") return "USA"; if (c==="2") return "Canadá"; if (c==="3") return "México";
    if (c==="J") return "Japón"; if (c==="K") return "Corea";
    if (c==="S") return "Reino Unido/Europa"; if (c==="W") return "Alemania"; if (c==="Z") return "Italia/Europa";
    return "—";
  }

  function decodeWMI(vin){
    const w3 = vin.slice(0,3), w2=vin.slice(0,2);
    let match = WMI.find(x => w3.startsWith(x.wmi));
    if (!match) match = WMI.find(x => w2===x.wmi);
    return {
      wmi: w3,
      make: match?.make || "Desconocido (amplía tabla WMI)",
      country: match?.country || inferCountry(vin[0]),
      region: match?.region || inferRegion(vin[0])
    };
  }

  function decode(vinRaw){
    const vin = sanitize(vinRaw);
    const valid = validate(vin);
    const info = { vin, valid };
    if (!valid.ok) return info;
    const wmi = decodeWMI(vin);
    const vds = vin.slice(3,9);
    const vis = vin.slice(9);
    const yearCode = vin[9];
    const year = yearMap[yearCode] || "—";
    const plant = vin[10] || "—";
    const serial = vin.slice(11) || "—";
    return { vin, valid, wmi, vds, vis, yearCode, modelYear:year, plant, serial };
  }

  function render(info){
    const status=$("#vinStatus"), WMI=$("#kvWMI"), CR=$("#kvCR"), YEAR=$("#kvYear"), PL=$("#kvPlant"), VDS=$("#kvVDS"), VIS=$("#kvVIS"), SER=$("#kvSerial");
    if(!status) return;
    status.innerHTML='';
    if(!info.valid.ok){
      status.innerHTML = `<div class="chip" style="border-color:#72323a;color:#ff9aa7;background:#2a1216">✖ ${info.valid.reason}</div>`;
      [WMI,CR,YEAR,PL,VDS,VIS,SER].forEach(n=> n && (n.textContent='—'));
      return;
    }
    status.innerHTML = `<div class="chip" style="border-color:#2d6a4f;color:#bff7d6;background:#10261c">✔ VIN válido (check digit OK)</div>`;
    WMI && (WMI.textContent = `${info.wmi.make} — ${info.wmi.wmi}`);
    CR && (CR.textContent = `${info.wmi.country} / ${info.wmi.region}`);
    YEAR && (YEAR.textContent = `${info.modelYear} (código: ${info.yearCode})`);
    PL && (PL.textContent = info.plant);
    VDS && (VDS.textContent = info.vds);
    VIS && (VIS.textContent = info.vis);
    SER && (SER.textContent = info.serial);
  }

  function bind(){
    const inp=$("#vinInput"); const btnD=$("#vinDecode"); const btnC=$("#vinClear"); const btn0902=$("#vinFrom0902"); const btnBg=$("#vinToggleBg"); const btnPdf=$("#vinPdf");
    if(!inp) return;
    const sanitizeInput = e=>{ const cur=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,""); if(cur!==e.target.value) e.target.value=cur; };
    const doDecode = ()=>{ const info = decode(inp.value); render(info); };
    inp.addEventListener('input', sanitizeInput);
    inp.addEventListener('keydown', e=>{ if(e.key==="Enter") doDecode(); });
    btnD?.addEventListener('click', doDecode);
    btnC?.addEventListener('click', ()=>{ inp.value=''; render({valid:{ok:false,reason:'Ingrese un VIN'}}); inp.focus(); });
    btn0902?.addEventListener('click', async ()=>{ const v=$("#kVIN")?.textContent; if(v && v!=='—'){ inp.value=v; doDecode(); } else { const vin = await mode09_02(); inp.value = vin; doDecode(); }});
    btnBg?.addEventListener('click', ()=>{ const sel=$("#bgMode"); if(sel){ sel.value = (sel.value==='transparent'?'dark':'transparent'); sel.dispatchEvent(new Event('change')); }});
    btnPdf?.addEventListener('click', ()=>{ window.print(); }); // usa CSS print limpio global
  }

  return { bind, decode, render };
})();

document.addEventListener('DOMContentLoaded', VIN.bind);
</script>
</body>
</html>
