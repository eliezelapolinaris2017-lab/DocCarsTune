<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Doctor Car Pro ‚Äî Lux UI + OBD-II</title>
<meta name="theme-color" content="#0b0f12">
<!-- librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ====== PALETA y look premium ====== */
:root{
  --bg0:#0b0f12; --bg1:#0e151a; --panel:#111a22; --ink:#e9edf4; --muted:#9aa4b2;
  --teal1:#66f0cf; --teal2:#1dd6b3; --teal3:#109e8b; --accent:#ff8f3d;
  --green:#22c55e; --red:#ef4444; --yellow:#f59e0b; --line:#1f2a33; --radius:16px;
  --shadow:0 12px 28px rgba(0,0,0,.45);
  --pri:#1dd6b3; --acc:#7aa2f7;
}
*{box-sizing:border-box} html,body{height:100%} body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"SF Pro Text",Inter,Roboto,Arial;
  background: radial-gradient(1200px 700px at 70% -10%, #113a39 0%, transparent 60%),
              radial-gradient(900px 600px at -10% 0%, #12313b 0%, transparent 60%),
              var(--bg0);
  color:var(--ink); letter-spacing:.2px;
}
header{position:sticky; top:0; z-index:50; backdrop-filter: saturate(140%) blur(10px);
  background:rgba(10,14,18,.55); border-bottom:1px solid var(--line)}
.topbar{display:flex; align-items:center; gap:12px; padding:12px 14px}
.logo{width:36px; height:36px; border-radius:10px; background:#000; object-fit:cover}
.brand{font-weight:800; letter-spacing:.4px}
.badge{font-size:12px; color:var(--muted)}
.grow{flex:1}
.btn{display:inline-flex; align-items:center; gap:10px; border-radius:12px; padding:10px 14px; border:1px solid var(--line); cursor:pointer}
.btn.primary{background:linear-gradient(180deg,var(--teal1),var(--teal2)); color:#05211b; font-weight:800; border:none}
.btn.ghost{background:#111825; color:var(--ink)}
.backBtn{display:none}
.tag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
.container{max-width:1024px; margin:18px auto; padding:0 14px}
.card{background:linear-gradient(180deg,#0f1922,#0c141a); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; margin-bottom:16px}
.h{display:flex; align-items:center; gap:10px; margin-bottom:10px}
.h h2{margin:0; font-size:18px}

/* ====== HOME ‚Äúgaraje‚Äù ====== */
.hero{display:grid; grid-template-columns:1fr; gap:14px}
.heroTop{
  display:grid; grid-template-columns: 1fr auto; gap:14px; align-items:center;
  background:linear-gradient(120deg, rgba(17,49,55,.8), rgba(14,24,32,.8));
  border:1px solid var(--line); border-radius:20px; padding:16px;
}
.car{display:grid; grid-template-columns: 88px 1fr; gap:14px; align-items:center}
.carImg{width:88px; height:64px; border-radius:14px; background:#0a1016; display:grid; place-items:center; border:1px solid var(--line)}
.carImg img{max-width:86px; max-height:62px; object-fit:cover}
.carMeta b{display:block; font-size:16px}
.carMeta small{color:var(--muted)}
.kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
.kpi{background:#0f1722; border:1px solid var(--line); border-radius:14px; padding:12px}
.kpi .v{font-size:18px; font-weight:800}
.kpi .l{font-size:12px; color:var(--muted)}
.cta{display:flex; gap:10px; align-items:center}

/* ====== Secciones estilo screenshots ====== */
.sectionTitle{font-weight:800; margin:0 0 10px}
.listCards{display:grid; gap:10px}
.cardRow{
  background:#0f1722; border:1px solid var(--line); border-radius:14px; padding:14px;
  display:flex; align-items:center; justify-content:space-between;
}
.cardRow .name{font-weight:700}
.cardRow .sub{font-size:12px; color:var(--muted)}
.status{font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--line);}
.status.pending{color:#ffb4a8; border-color:#533; background:rgba(255,68,68,.07)}
.status.ok{color:#8ff1bf; border-color:#1f483a; background:rgba(34,197,94,.06)}
.canvasWrap{background:#0f1722; border:1px solid var(--line); border-radius:14px; padding:10px}

/* ====== grid de accesos r√°pidos ====== */
.quickGrid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
.quickBtn{display:flex; flex-direction:column; gap:6px; padding:14px; background:#0f1722; border:1px solid var(--line); border-radius:14px; cursor:pointer}
.quickBtn b{font-size:14px}
.quickBtn small{color:var(--muted); font-size:12px}

/* ====== Brands ====== */
.brandSearch{position:sticky; top:68px; z-index:10; backdrop-filter: blur(6px); padding:8px 0}
.brandList{background:linear-gradient(180deg,#0f1922,#0b1218); border:1px solid var(--line); border-radius:16px; overflow:hidden}
.brandItem{display:flex; gap:12px; align-items:center; padding:12px 14px; border-bottom:1px solid var(--line)}
.brandItem:last-child{border-bottom:none}
.brandLogo{width:26px; height:26px; border-radius:6px; background:#05090d; display:grid; place-items:center; border:1px solid var(--line)}
.brandItem b{flex:1}

/* utilidades */
.hidden{display:none!important}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
hr{border:0; border-top:1px solid var(--line); opacity:.6; margin:10px 0}
@media (max-width:800px){ .heroTop{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="topbar">
    <button id="btnBackHome" class="btn ghost backBtn">‚Üê Men√∫</button>
    <img id="appLogo" class="logo" alt="Logo">
    <div>
      <div class="brand">Doctor Car Pro</div>
      <div class="badge">OBD-II ‚Ä¢ ELM327</div>
    </div>
    <span class="grow"></span>
    <span id="connStatus" class="tag">Desconectado</span>
    <button id="btnConnect" class="btn primary">Conectar</button>
    <button id="btnDisconnect" class="btn ghost hidden">Desconectar</button>
  </div>
</header>

<div class="container">
  <!-- ====== HOME / GARAGE ====== -->
  <section id="page-home" class="card">
    <div class="hero">
      <div class="heroTop">
        <div class="car">
          <div class="carImg"><img id="carPhoto" alt="Car"></div>
          <div class="carMeta">
            <b id="carName">Mi veh√≠culo</b>
            <small id="carYear">‚Äî ‚Ä¢ No conectado</small>
          </div>
        </div>
        <div class="cta">
          <select id="transport" class="btn ghost" style="padding:9px 10px">
            <option value="auto">Auto (Serial/BLE)</option>
            <option value="serial">Web Serial (USB)</option>
            <option value="ble">Web Bluetooth (BLE UART)</option>
            <option value="demo">Demo (sin hardware)</option>
          </select>
          <button id="btnConnect2" class="btn primary">Connect to OBD2</button>
          <button id="btnEditCar" class="btn ghost">Editar auto</button>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="v mono" id="kpiRPM">‚Äî</div><div class="l">RPM</div></div>
        <div class="kpi"><div class="v mono" id="kpiSPD">‚Äî</div><div class="l">Velocidad</div></div>
        <div class="kpi"><div class="v mono" id="kpiECT">‚Äî</div><div class="l">Refrigerante</div></div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">Accesos r√°pidos</h3>
        <div class="quickGrid">
          <div class="quickBtn" id="qInit"><b>Inicializar ECU</b><small>ATZ ‚Üí ATE0 ‚Üí ATL0 ‚Üí ATS0 ‚Üí ATSP0 ‚Üí 0100</small></div>
          <div class="quickBtn" id="qVIN"><b>Leer VIN (0902)</b><small>Identificaci√≥n del veh√≠culo</small></div>
          <div class="quickBtn" id="qIM"><b>Monitores I/M</b><small>0101 Estado OBD</small></div>
          <div class="quickBtn" id="qFreeze"><b>Freeze Frame</b><small>Modo 02</small></div>
        </div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">OBD2 scanner</h3>
        <div class="cardRow">
          <div>
            <div class="name">Datos y control</div>
            <div class="sub" id="compatNote">Compatibilidad del navegador‚Ä¶</div>
          </div>
          <button id="btnQuickPoll" class="btn ghost">Lectura r√°pida (5s)</button>
        </div>
        <hr/>
        <label class="sub">Consola</label>
        <textarea id="console" rows="8" class="mono" style="width:100%; background:#0f1722; border:1px solid var(--line); color:var(--ink); border-radius:12px" readonly></textarea>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button id="btnClearLog" class="btn ghost">Limpiar</button>
          <span style="color:var(--muted); margin-left:auto">Tip: Chrome/Edge en laptop para Web Serial.</span>
        </div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">Sensor Data / PIDs</h3>
        <div class="listCards">
          <div class="cardRow"><div><div class="name">Ignition Status</div><div class="sub" id="pidIGN">‚Äî</div></div></div>
          <div class="cardRow"><div><div class="name">Battery Voltage</div><div class="sub" id="pidVBAT">‚Äî</div></div></div>
          <div class="cardRow"><div><div class="name">Vehicle Protocol</div><div class="sub" id="pidPROTO">‚Äî</div></div></div>
          <div class="cardRow"><div><div class="name">VIN Code</div><div class="sub mono" id="pidVIN">‚Äî</div></div></div>
          <div class="cardRow"><div><div class="name">Fuel System Status</div><div class="sub" id="pidFUEL">‚Äî</div></div></div>
        </div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">Car Codes (DTC)</h3>
        <div id="dtcContainer" class="listCards">
          <div class="cardRow"><div><div class="name mono">‚Äî</div><div class="sub">Sin c√≥digos</div></div><span class="status ok">OK</span></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="btnScanDTC" class="btn primary">Leer DTC (03)</button>
          <button id="btnReadPending" class="btn ghost">Pendientes (07)</button>
          <button id="btnReadPermanent" class="btn ghost">Permanentes (0A)</button>
          <button id="btnClearDTC" class="btn ghost" style="margin-left:auto">Borrar (04)</button>
        </div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">Charts (tiempo real)</h3>
        <div class="canvasWrap"><canvas id="chartRPM" height="110"></canvas></div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="chartSPD" height="110"></canvas></div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="chartECT" height="110"></canvas></div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="chartTHR" height="110"></canvas></div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">Reporte PDF</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
          <div><label>Cliente</label><input id="pdfCliente" placeholder="Nombre del cliente" style="width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0f1722; color:var(--ink)"></div>
          <div><label>Notas</label><textarea id="pdfNotas" rows="3" placeholder="Observaciones..." style="width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0f1722; color:var(--ink)"></textarea></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="btnGenPDF" class="btn primary">Generar PDF</button>
          <button id="btnClearSeries" class="btn ghost">Limpiar series</button>
        </div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">Car brand</h3>
        <div class="brandSearch">
          <input id="brandSearch" placeholder="Brand name" style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0f1722; color:var(--ink)"/>
        </div>
        <div id="brandList" class="brandList"></div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">Ajustes r√°pidos</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
          <div>
            <label>Subir logo</label><input type="file" id="logoFile" accept="image/*"/>
            <div style="display:flex; gap:8px; margin-top:8px">
              <label>Primario</label><input type="color" id="colorPri" value="#1dd6b3"/>
              <label>Acento</label><input type="color" id="colorAcc" value="#7aa2f7"/>
              <button id="btnSaveTheme" class="btn primary">Guardar</button>
              <button id="btnResetTheme" class="btn ghost">Restablecer</button>
            </div>
          </div>
          <div>
            <label>Usuario</label><input id="uUser" placeholder="admin" style="width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0f1722; color:var(--ink)">
            <label>Contrase√±a</label><input id="uPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0f1722; color:var(--ink)">
            <div style="display:flex; gap:8px; margin-top:8px">
              <button id="btnRegister" class="btn ghost">Crear/Actualizar</button>
              <button id="btnLogin" class="btn primary">Iniciar sesi√≥n</button>
              <button id="btnLogout" class="btn ghost">Cerrar sesi√≥n</button>
            </div>
            <div id="authState" class="tag" style="margin-top:8px">No autenticado</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">Soporte y mejoras</h3>
        <a class="btn primary" href="https://wa.me/17876643079" target="_blank" rel="noopener">üí¨ WhatsApp: 787-664-3079</a>
      </div>

    </div>
  </section>

  <!-- ====== P√ÅGINA UPGRADE simple (si la quieres separada) ====== -->
  <section id="page-upgrade" class="card hidden">
    <div class="h"><h2>Soporte y mejoras</h2><span class="tag">Contacto directo</span></div>
    <p>¬øNecesitas una funci√≥n nueva, soporte o integraci√≥n? Comun√≠cate por WhatsApp con el desarrollador:</p>
    <a class="btn primary" href="https://wa.me/17876643079" target="_blank" rel="noopener">üí¨ WhatsApp: 787-664-3079</a>
  </section>
</div>

<footer style="text-align:center; opacity:.7; font-size:12px; padding:28px 0">¬© <span id="year"></span> Doctor Car Pro</footer>

<script>
/* =========================================================
   L√≥gica completa OBD-II + UI premium
   ========================================================= */
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];
const sleep = ms=> new Promise(r=>setTimeout(r,ms));
const BRAND_KEY='dcp.brand', AUTH_KEY='dcp.auth', PREF_KEY='dcp.prefs', GARAGE_KEY='dcp.garage';

const S = {
  transport:'auto', conn:null, reader:null, writer:null,
  bleDev:null, bleTx:null, bleRx:null, serialPort:null,
  buffer:'', liveTimer:null, quickTimer:null, logged:false,
  dtcLast:[], // para PDF
  t0:Date.now(), series:{t:[],rpm:[],spd:[],ect:[],thr:[]}, maxPoints:300, charts:{}
};

function log(t){ const c=$("#console"); c.value += (t.endsWith("\n")? t : (t+"\n")); c.scrollTop=c.scrollHeight; }
function clean(s){ return s.replace(/\r/g,'').replace(/ELM327 v[^\n]+\n?/i,'').replace(/^>/gm,'').replace(/\n\n+/g,'\n').trim(); }
function blobToDataURL(buf, type){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(new Blob([buf],{type})); }); }

/* ---------- Marca/tema persistente ---------- */
function loadBrand(){
  const x = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
  if (x.logo) $("#appLogo").src = x.logo; else $("#appLogo").src = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="#000"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="${getComputedStyle(document.documentElement).getPropertyValue('--pri')||'#1dd6b3'}" font-family="Arial" font-size="34">DCP</text></svg>`);
  if (x.pri) document.documentElement.style.setProperty('--teal2', x.pri), document.documentElement.style.setProperty('--pri', x.pri);
  if (x.acc) document.documentElement.style.setProperty('--acc', x.acc);
}
loadBrand();
$("#logoFile").addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  const b = await f.arrayBuffer(); const img = await blobToDataURL(b, f.type);
  const brand = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}'); brand.logo = img;
  localStorage.setItem(BRAND_KEY, JSON.stringify(brand)); loadBrand();
});
$("#colorPri").oninput = e=> document.documentElement.style.setProperty('--pri', e.target.value);
$("#colorAcc").oninput = e=> document.documentElement.style.setProperty('--acc', e.target.value);
$("#btnSaveTheme").onclick = ()=>{ const brand=JSON.parse(localStorage.getItem(BRAND_KEY)||'{}'); brand.pri=$("#colorPri").value; brand.acc=$("#colorAcc").value; localStorage.setItem(BRAND_KEY, JSON.stringify(brand)); };
$("#btnResetTheme").onclick = ()=>{ localStorage.removeItem(BRAND_KEY); loadBrand(); };

/* ---------- Preferencias ---------- */
function loadPrefs(){ return JSON.parse(localStorage.getItem(PREF_KEY)||'{}'); }
function savePrefs(p){ localStorage.setItem(PREF_KEY, JSON.stringify(p)); }
(function restorePrefs(){
  const p = loadPrefs();
  if (p.transport) $("#transport").value = p.transport;
})();

/* ---------- Garage (foto/modelo/a√±o) ---------- */
function loadGarage(){ return JSON.parse(localStorage.getItem(GARAGE_KEY)||'{"name":"Toyota Camry","year":"2019","photo":""}'); }
function saveGarage(g){ localStorage.setItem(GARAGE_KEY, JSON.stringify(g)); }
function paintGarage(){
  const g=loadGarage();
  $("#carName").textContent=g.name||'‚Äî';
  $("#carYear").textContent=(g.year?g.year+' ‚Ä¢ ':'') + ($("#connStatus").textContent || '‚Äî');
  if(g.photo) $("#carPhoto").src=g.photo; else $("#carPhoto").src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80"><rect width="100%" height="100%" fill="#0a0f14"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="#66f0cf" font-family="Arial" font-size="16">Car</text></svg>`);
}
paintGarage();
$("#btnEditCar").onclick=()=>{
  const g=loadGarage();
  const name=prompt('Modelo', g.name||''); if(name!==null) g.name=name;
  const year=prompt('A√±o', g.year||''); if(year!==null) g.year=year;
  const input=document.createElement('input'); input.type='file'; input.accept='image/*';
  input.onchange=async e=>{
    const f=e.target.files[0]; if(!f) return save();
    const b=await f.arrayBuffer();
    const u=await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(new Blob([b],{type:f.type})) });
    g.photo=u; save();
  };
  function save(){ saveGarage(g); paintGarage(); }
  input.click();
};

/* ---------- Autenticaci√≥n local ---------- */
function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return 'H'+(h>>>0).toString(16); }
function authState(){ const a=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}'); S.logged=!!a.user; $("#authState").textContent=S.logged?`Autenticado como ${a.user}`:'No autenticado'; }
authState();
$("#btnRegister").onclick=()=>{ const u=$("#uUser").value.trim(), p=$("#uPass").value; if(!u||!p) return alert('Usuario y contrase√±a requeridos'); localStorage.setItem(AUTH_KEY, JSON.stringify({user:u, pass:hash(p)})); authState(); alert('Usuario guardado'); };
$("#btnLogin").onclick=()=>{ const u=$("#uUser").value.trim(), p=$("#uPass").value; const a=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}'); if(a.user===u && a.pass===hash(p)){ S.logged=true; authState(); } else alert('Credenciales inv√°lidas'); };
$("#btnLogout").onclick=()=>{ localStorage.removeItem(AUTH_KEY); authState(); };

/* ---------- Compatibilidad ---------- */
function showCompat(){
  const b=[]; b.push(('serial' in navigator)?'Web Serial disponible':'Web Serial no disponible');
  b.push((navigator.bluetooth)?'Web Bluetooth disponible':'Web Bluetooth no disponible');
  $("#compatNote").textContent = b.join(' ‚Ä¢ ') + '.';
}
showCompat();

/* ---------- Transporte (Serial / BLE / Demo) ---------- */
const Transport = {
  async connect(kind){ S.transport=kind||$("#transport").value; const prefs=loadPrefs(); prefs.transport=S.transport; savePrefs(prefs);
    if (S.transport==='serial' || (S.transport==='auto' && 'serial' in navigator)) return await TransportSerial.connect();
    else if (S.transport==='ble' || (S.transport==='auto' && navigator.bluetooth)) return await TransportBLE.connect();
    else if (S.transport==='demo') return await TransportDemo.connect();
    else throw new Error('No hay transporte compatible. Prueba Web Serial (Chrome desktop) o BLE compatible.');
  },
  async disconnect(){ await TransportSerial.disconnect(); await TransportBLE.disconnect(); await TransportDemo.disconnect(); S.conn=null; S.writer=null; S.reader=null; $("#connStatus").textContent='Desconectado'; $("#btnConnect").classList.remove('hidden'); $("#btnDisconnect").classList.add('hidden'); paintGarage(); },
  async write(line){ const txt=line.endsWith('\r')? line : line+'\r'; log('> '+line); if(S.writer){ await S.writer(txt); } else throw new Error('No hay writer activo'); },
  async request(line, timeout=1200){ await Transport.write(line); return await Transport.readUntil('>', timeout); },
  async readUntil(term='>', timeout=1200){ const started=Date.now(); while(Date.now()-started<timeout){ const chunk=await Transport.readChunk(timeout-(Date.now()-started)); if(chunk){ S.buffer+=chunk; const idx=S.buffer.lastIndexOf(term); if(idx>=0){ const out=S.buffer.slice(0,idx); S.buffer=S.buffer.slice(idx+term.length); return clean(out); } } else { await sleep(20); } } return clean(S.buffer); },
  async readChunk(){ return null; }
};
const TransportSerial = {
  async connect(){ if(!('serial' in navigator)) throw new Error('Web Serial no disponible');
    S.serialPort = await navigator.serial.requestPort();
    await S.serialPort.open({ baudRate: 38400 });
    const dec = new TextDecoderStream(); S.serialPort.readable.pipeTo(dec.writable); const reader = dec.readable.getReader();
    S.reader = async ()=>{ const {value,done}=await reader.read(); if(done) return null; return value||null; };
    const enc = new TextEncoderStream(); enc.readable.pipeTo(S.serialPort.writable); const writer = enc.writable.getWriter(); S.writer = async (txt)=>{ writer.write(txt); };
    S.conn='serial'; $("#connStatus").textContent='Conectado (Serial)'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[Serial] Conectado.'); paintGarage(); return true;
  },
  async disconnect(){ try{ if(S.serialPort){ await S.serialPort.close(); S.serialPort=null; } }catch(e){} }
};
const BLE_UUID={ svc:'6e400001-b5a3-f393-e0a9-e50e24dcca9e', tx:'6e400002-b5a3-f393-e0a9-e50e24dcca9e', rx:'6e400003-b5a3-f393-e0a9-e50e24dcca9e' };
const TransportBLE = {
  async connect(){ if(!navigator.bluetooth) throw new Error('Web Bluetooth no disponible');
    S.bleDev = await navigator.bluetooth.requestDevice({ filters:[{services:[BLE_UUID.svc]}], optionalServices:[BLE_UUID.svc] });
    const server = await S.bleDev.gatt.connect(); const svc = await server.getPrimaryService(BLE_UUID.svc);
    S.bleTx = await svc.getCharacteristic(BLE_UUID.tx); S.bleRx = await svc.getCharacteristic(BLE_UUID.rx);
    await S.bleRx.startNotifications(); let queue=''; S.bleRx.addEventListener('characteristicvaluechanged', e=>{ const v=new TextDecoder().decode(e.target.value); queue+=v; });
    S.reader = async ()=>{ await sleep(60); if(queue){ const z=queue; queue=''; return z; } return ''; };
    S.writer = async (txt)=>{ const data=new TextEncoder().encode(txt); for(let i=0;i<data.length;i+=20){ await S.bleTx.writeValueWithoutResponse(data.slice(i,i+20)); await sleep(8);} };
    S.conn='ble'; $("#connStatus").textContent='Conectado (BLE)'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[BLE] Conectado.'); paintGarage(); return true;
  },
  async disconnect(){ try{ if(S.bleDev && S.bleDev.gatt.connected) S.bleDev.gatt.disconnect(); S.bleDev=null; S.bleTx=null; S.bleRx=null; }catch(e){} }
};
const TransportDemo = { async connect(){ S.reader=async()=>{ await sleep(50); return ''; }; S.writer=async()=>{}; S.conn='demo'; $("#connStatus").textContent='Demo'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[Demo] Modo demostraci√≥n activo.'); paintGarage(); return true; }, async disconnect(){} };

/* ---------- OBD helpers ---------- */
const hexToBytes = h => { h=h.replace(/\s/g,''); const a=[]; for(let i=0;i<h.length;i+=2)a.push(parseInt(h.substr(i,2),16)); return a; };
const parseLines = resp => resp.split('\n').map(x=>x.trim()).filter(Boolean);
const lastDataLine = (resp,prefix)=>{ const lines=parseLines(resp).filter(x=>x && (!prefix || x.startsWith(prefix))); return lines.length? lines[lines.length-1]:''; };
const parseOBD = (prefix, resp)=>{ const l=lastDataLine(resp,prefix).replace(/^([0-9A-F]{2}\s*){2}/i,'').trim(); return hexToBytes(l.replace(/\s/g,'')); };
// PIDs base
async function pid010C(){ const r=await Transport.request('010C'); const b=parseOBD('41 0C',r); if(b.length>=2){ return ((b[0]<<8)|b[1])/4; } return null; }
async function pid010D(){ const r=await Transport.request('010D'); const b=parseOBD('41 0D',r); if(b.length>=1) return b[0]; return null; }
async function pid0105(){ const r=await Transport.request('0105'); const b=parseOBD('41 05',r); if(b.length>=1) return b[0]-40; return null; }
async function pid0111(){ const r=await Transport.request('0111'); const b=parseOBD('41 11',r); if(b.length>=1) return (b[0]*100/255); return null; }
async function readIM(){ const r=await Transport.request('0101'); alert('I/M:\n'+r); }
async function readFreeze(){ const r=await Transport.request('02'); alert('Freeze Frame:\n'+r); }
async function mode09_02(){ const r=await Transport.request('0902'); const lines=parseLines(r).filter(x=>x.match(/^49 02/i)); let bytes=[]; lines.forEach(line=>{ const parts=line.replace(/^49 02 [0-9A-F]{2}\s*/i,'').trim(); bytes=bytes.concat(hexToBytes(parts)); }); const ascii=bytes.filter(b=>b>=0x20 && b<=0x7E); const vin=new TextDecoder().decode(new Uint8Array(ascii)).trim(); return vin||''; }

/* ---------- Inicializaci√≥n ECU ---------- */
async function initECU(){
  await Transport.request('ATZ',1500); await sleep(300);
  await Transport.request('ATE0'); await Transport.request('ATL0'); await Transport.request('ATS0'); await Transport.request('ATH0'); await Transport.request('ATSP0');
  const pids = await Transport.request('0100'); log(pids);
  const vin = await mode09_02(); $("#pidVIN").textContent = vin||'‚Äî';
  try{ const prot=await Transport.request('ATDP'); $("#pidPROTO").textContent = prot.split('\n').pop() || prot; }catch(e){}
  // opcionales
  $("#pidIGN").textContent = '‚Äî'; // si agregas PID espec√≠fico
  $("#pidFUEL").textContent = '‚Äî';
}

/* ---------- Live / KPIs / Charts ---------- */
function makeCfg(label){ return {
  type:'line', data:{ labels:S.series.t, datasets:[{ label, data:[], borderWidth:2, pointRadius:0, tension:.25 }]},
  options:{ animation:false, responsive:true, maintainAspectRatio:false,
    scales:{ x:{ ticks:{color:'#9aa'}, grid:{color:'#1b2530'} }, y:{ ticks:{color:'#9aa'}, grid:{color:'#1b2530'} } },
    plugins:{ legend:{labels:{color:'#e7eaf3'}}}
  }
};}
function initCharts(){
  S.charts.rpm = new Chart(document.getElementById('chartRPM').getContext('2d'), makeCfg('RPM'));
  S.charts.spd = new Chart(document.getElementById('chartSPD').getContext('2d'), makeCfg('Velocidad'));
  S.charts.ect = new Chart(document.getElementById('chartECT').getContext('2d'), makeCfg('ECT ¬∞C'));
  S.charts.thr = new Chart(document.getElementById('chartTHR').getContext('2d'), makeCfg('Throttle %'));
}
initCharts();

function refreshCharts(){
  if(!S.charts.rpm) return;
  S.charts.rpm.data.labels=S.series.t; S.charts.rpm.data.datasets[0].data=S.series.rpm; S.charts.rpm.update('none');
  S.charts.spd.data.labels=S.series.t; S.charts.spd.data.datasets[0].data=S.series.spd; S.charts.spd.update('none');
  S.charts.ect.data.labels=S.series.t; S.charts.ect.data.datasets[0].data=S.series.ect; S.charts.ect.update('none');
  S.charts.thr.data.labels=S.series.t; S.charts.thr.data.datasets[0].data=S.series.thr; S.charts.thr.update('none');
}
function pushSample(rpm,spd,ect,thr){
  const t=(Date.now()-S.t0)/1000;
  S.series.t.push(t);
  S.series.rpm.push(rpm??null);
  S.series.spd.push(spd??null);
  S.series.ect.push(ect??null);
  S.series.thr.push(thr??null);
  ['t','rpm','spd','ect','thr'].forEach(k=>{ if(S.series[k].length>S.maxPoints) S.series[k].shift(); });
  refreshCharts();
}
function updateKPI(rpm,spd,ect){
  if(rpm!=null) $("#kpiRPM").textContent = `${rpm.toFixed(0)} rpm`;
  if(spd!=null) $("#kpiSPD").textContent = `${spd} kph`;
  if(ect!=null) $("#kpiECT").textContent = `${ect} ¬∞C`;
}

/* ---------- DTC ---------- */
function dtcFromBytes(arr){ const out=[]; for(let i=0;i+1<arr.length;i+=2){ const A=arr[i],B=arr[i+1]; const sys=['P','C','B','U'][(A & 0xC0)>>6]; const d1=(A & 0x30)>>4; const d2=(A & 0x0F); const code=sys + d1 + d2 + ((B>>4)&0x0F) + (B&0x0F); if(code!=='P0000') out.push(code); } return out; }
const DTC_DESC={ "P0300":"Random/Multiple Cylinder Misfire Detected","P0301":"Cylinder 1 Misfire Detected","P0171":"System Too Lean (Bank 1)","P0172":"System Too Rich (Bank 1)","P0118":"Coolant Temp Sensor High","P0117":"Coolant Temp Sensor Low","P0101":"MAF Range/Performance","P0420":"Catalyst Efficiency Below Threshold (B1)","P0430":"Catalyst Efficiency Below Threshold (B2)","P0440":"EVAP System Malfunction","P0130":"O2 Sensor B1S1 Circuit" };
function paintDTC(list){
  const box=$("#dtcContainer");
  if(!list.length){ box.innerHTML='<div class="cardRow"><div><div class="name mono">‚Äî</div><div class="sub">Sin c√≥digos</div></div><span class="status ok">OK</span></div>'; return; }
  box.innerHTML=list.map(c=>`<div class="cardRow"><div><div class="name mono">${c}</div><div class="sub">${DTC_DESC[c]||''}</div></div><span class="status pending">Pending</span></div>`).join('');
}

/* ---------- PDF ---------- */
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const margin=36, line=18; let y=margin;
  const brand = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
  if(brand.logo){ try{ doc.addImage(brand.logo,'PNG', margin, y, 90, 90); }catch(e){} }
  doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text('Doctor Car Pro ‚Äî Reporte de Diagn√≥stico', margin+100, y+20);
  doc.setFontSize(10); doc.setFont('helvetica','normal'); const now=new Date(); doc.text(now.toLocaleString(), margin+100, y+40);
  y += 100;

  const proto = $("#pidPROTO").textContent||'‚Äî';
  const vin = $("#pidVIN").textContent||'‚Äî';
  doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Datos del veh√≠culo', margin, y); y+=line;
  doc.setFont('helvetica','normal'); doc.text(`VIN: ${vin}`, margin, y); y+=line;
  doc.text(`Protocolo: ${proto}`, margin, y); y+=line;

  y+=line/2; doc.setFont('helvetica','bold'); doc.text('Lecturas actuales', margin, y); y+=line;
  doc.setFont('helvetica','normal'); doc.text(`RPM: ${$("#kpiRPM").textContent}`, margin, y); y+=line;
  doc.text(`Velocidad: ${$("#kpiSPD").textContent}`, margin, y); y+=line;
  doc.text(`ECT: ${$("#kpiECT").textContent}`, margin, y); y+=line;

  y+=line/2; doc.setFont('helvetica','bold'); doc.text('C√≥digos DTC', margin, y); y+=line;
  doc.setFont('helvetica','normal');
  if(S.dtcLast.length){ S.dtcLast.forEach(c=>{ const d=DTC_DESC[c]||''; doc.text(`‚Ä¢ ${c}${d?(' - '+d):''}`, margin, y); y+=line; }); }
  else { doc.text('Sin c√≥digos activos.', margin, y); y+=line; }

  const cliente = $("#pdfCliente").value || ''; const notas = $("#pdfNotas").value || '';
  y+=line/2; doc.setFont('helvetica','bold'); doc.text('Cliente / Notas', margin, y); y+=line;
  doc.setFont('helvetica','normal'); if(cliente){ doc.text(`Cliente: ${cliente}`, margin, y); y+=line; }
  if(notas){ const split=doc.splitTextToSize(notas, 520); doc.text(split, margin, y); y += split.length*line; } else { doc.text('‚Äî', margin, y); y+=line; }

  if(S.charts.rpm){
    const w=240,h=140;
    try{ const img1=S.charts.rpm.toBase64Image(); doc.addImage(img1,'PNG', margin, y, w, h); }catch(e){}
    try{ const img2=S.charts.spd.toBase64Image(); doc.addImage(img2,'PNG', margin+w+20, y, w, h); }catch(e){}
    y+=h+10;
    try{ const img3=S.charts.ect.toBase64Image(); doc.addImage(img3,'PNG', margin, y, w, h); }catch(e){}
    try{ const img4=S.charts.thr.toBase64Image(); doc.addImage(img4,'PNG', margin+w+20, y, w, h); }catch(e){}
  }
  doc.setFont('helvetica','italic'); doc.setFontSize(9);
  doc.text('Generado por Doctor Car Pro ‚Äî OBD-II (uso informativo; no sustituye diagn√≥stico del fabricante).', margin, 812);
  doc.save(`DoctorCarPro_${vin||'vehiculo'}_${new Date().toISOString().slice(0,10)}.pdf`);
}

/* ---------- Acciones UI ---------- */
function go(p){ ['home','upgrade'].forEach(id=>$('#page-'+id).classList.add('hidden')); $('#page-'+p).classList.remove('hidden'); $('#btnBackHome').style.display = (p!=='home')?'inline-flex':'none'; window.scrollTo(0,0); }
$('#btnBackHome').onclick=()=>go('home');
$('#year').textContent = new Date().getFullYear();

$("#btnConnect").onclick = async ()=>{ try{ await Transport.connect($("#transport").value); }catch(e){ alert(e.message); log('[ERROR] '+e.message);} };
$("#btnConnect2").onclick = ()=> $("#btnConnect").click();
$("#btnDisconnect").onclick = async ()=>{ await Transport.disconnect(); };
$("#btnClearLog").onclick = ()=> $("#console").value='';

$("#qInit").onclick = async ()=>{ if(!S.conn && S.transport!=='demo') return alert('Con√©ctate primero'); try{ await initECU(); log('[OK] ECU inicializada.'); }catch(e){ log('[ERROR] init: '+e.message);} };
$("#qVIN").onclick = async ()=>{ if(!S.conn && S.transport!=='demo') return alert('Con√©ctate primero'); const v=await mode09_02(); $("#pidVIN").textContent=v||'‚Äî'; };
$("#qIM").onclick = readIM;
$("#qFreeze").onclick = readFreeze;

$("#btnQuickPoll").onclick = async ()=>{
  if(!S.conn && S.transport!=='demo') return alert('Con√©ctate primero');
  clearInterval(S.quickTimer);
  S.quickTimer = setInterval(async ()=>{
    try{
      const [rpm,spd,ect,thr]=await Promise.all([pid010C(),pid010D(),pid0105(),pid0111()]);
      updateKPI(rpm,spd,ect); pushSample(rpm,spd,ect,thr);
    }catch(e){}
  }, 800);
  setTimeout(()=> clearInterval(S.quickTimer), 5000);
};

let liveTimer=null;
$("#btnClearSeries").onclick = ()=>{ S.series = { t:[], rpm:[], spd:[], ect:[], thr:[] }; S.t0=Date.now(); refreshCharts(); };
$("#btnGenPDF").onclick = generatePDF;

/* DTC botones */
$("#btnScanDTC").onclick = async ()=>{
  if(!S.conn && S.transport!=='demo') return alert('Con√©ctate primero');
  const r = await Transport.request('03', 2500); log(r);
  const lines = parseLines(r).filter(x=>x.match(/^43 /i));
  let bytes=[]; lines.forEach(line=>{ const body=line.replace(/^43\s*/i,'').trim(); bytes=bytes.concat(hexToBytes(body.replace(/\s/g,''))); });
  const list = dtcFromBytes(bytes); S.dtcLast = list; paintDTC(list);
};
$("#btnClearDTC").onclick = async ()=>{
  if(!S.conn && S.transport!=='demo') return alert('Con√©ctate primero');
  if(!confirm('¬øSeguro que deseas borrar DTC (04)?')) return;
  const r=await Transport.request('04',2500); log(r); alert('Solicitud de borrado enviada.'); S.dtcLast=[]; paintDTC([]);
};
$("#btnReadPending").onclick = async ()=>{ if(!S.conn && S.transport!=='demo') return alert('Con√©ctate primero'); const r=await Transport.request('07',2500); alert('Pendientes:\n'+r); };
$("#btnReadPermanent").onclick = async ()=>{ if(!S.conn && S.transport!=='demo') return alert('Con√©ctate primero'); const r=await Transport.request('0A',2500); alert('Permanentes:\n'+r); };

/* Live streaming continuo al conectar (opcional: activa si quieres) */
/*
liveTimer = setInterval(async ()=>{ if(!S.conn) return; try{
  const [rpm,spd,ect,thr]=await Promise.all([pid010C(),pid010D(),pid0105(),pid0111()]);
  updateKPI(rpm,spd,ect); pushSample(rpm,spd,ect,thr);
}catch(e){} }, 600);
*/

/* ---------- Brands con buscador ---------- */
const BRANDS=["Abarth","Acura","Alfa Romeo","Aston Martin","Audi","Bentley","BMW","Bugatti","Buick","Cadillac","Chevrolet","Chrysler","Citro√´n","Dacia","Dodge","Ferrari","Fiat","Ford","Genesis","GMC","Honda","Hyundai","Infiniti","Jaguar","Jeep","Kia","Lamborghini","Lancia","Land Rover","Lexus","Lincoln","Maserati","Mazda","McLaren","Mercedes-Benz","MINI","Mitsubishi","Nissan","Opel","Peugeot","Porsche","Ram","Renault","Rolls-Royce","Saab","Seat","≈†koda","Subaru","Suzuki","Tesla","Toyota","Volkswagen","Volvo"];
function renderBrands(filter=''){
  const list=BRANDS.filter(b=>b.toLowerCase().includes(filter.toLowerCase()));
  $("#brandList").innerHTML=list.map(b=>`<div class="brandItem"><div class="brandLogo">üöó</div><b>${b}</b><span class="sub">Tap to select</span></div>`).join('');
}
renderBrands(); $("#brandSearch").oninput=e=>renderBrands(e.target.value);

/* ---------- Conectar / desconectar desde header ---------- */
$("#btnDisconnect").onclick = async ()=>{ await Transport.disconnect(); };

/* ---------- Compat iOS nota ---------- */
(function boot(){
  const ua = navigator.userAgent;
  const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
  if (isIOS) $("#compatNote").textContent += ' ‚Ä¢ iOS: Web Serial no disponible; BLE limitado.';
})();
</script>
</body>
</html>
