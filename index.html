<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taller PRO – Códigos, Trabajos, Inventario & PDF</title>
<style>
:root{
  --bg:#0e1216; --panel:#131a21; --ink:#eaf2f7; --muted:#9fb3c4;
  --accent:#4cc2ff; --ok:#2ecc71; --warn:#ffcf44; --danger:#ff5678; --line:#203040;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; color:var(--ink); background:linear-gradient(180deg,#0c1116,#0a0e12)}
header{
  position:sticky; top:0; z-index:10; background:rgba(10,14,18,.9); backdrop-filter:saturate(140%) blur(6px);
  border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; padding:10px 12px;
}
header img{height:30px}
header b{font-size:16px; letter-spacing:.3px}
nav{display:flex; flex-wrap:wrap; gap:8px; margin-left:auto}
nav button{
  background:#18222c; color:var(--ink); border:1px solid #223246; padding:8px 10px; border-radius:8px;
  cursor:pointer
}
nav button.active{outline:2px solid var(--accent)}
main{max-width:1200px; margin:0 auto; padding:16px}
.panel{
  background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; margin:0 0 16px 0;
}
h2{margin:6px 0 12px 0; font-size:18px}
.grid{display:grid; gap:12px}
.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
input,select,textarea{
  width:100%; background:#0f161d; border:1px solid #223246; color:var(--ink); border-radius:8px; padding:8px 10px;
}
label{font-size:12px; color:var(--muted)}
.table{width:100%; border-collapse:collapse; font-size:14px}
.table th,.table td{border-bottom:1px solid #223246; padding:8px; text-align:left}
.table th{color:#cfe3f2; font-weight:600; background:#0f1821}
.btn{
  display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border-radius:8px; border:1px solid #223246;
  background:#15202b; color:var(--ink); cursor:pointer; text-decoration:none
}
.btn.ok{background:#12331f; border-color:#1c6b3f}
.btn.warn{background:#2d2713; border-color:#6e5b17}
.btn.danger{background:#3a141b; border-color:#84424f}
.btn.ghost{background:transparent}
.small{font-size:12px; color:var(--muted)}
.tag{font-size:11px; background:#0f1821; border:1px solid #223246; padding:3px 6px; border-radius:6px}
hr{border:none; border-top:1px solid #223246; margin:12px 0}

.print-only{display:none}
/* ====== Estilos de impresión (PDF) ====== */
@media print {
  header,nav,#noPrint, .no-print{display:none !important}
  body{background:white; color:#000}
  .panel{border:none}
  .invoice{border:1px solid #aaa; padding:16px}
  .print-only{display:block}
}
</style>
</head>
<body>
<header>
  <img id="logoHeader" src="" alt="" style="display:none">
  <b>Taller PRO</b>
  <span class="tag">Local</span>
  <nav id="topnav"></nav>
</header>

<main>

  <!-- DASHBOARD -->
  <section id="sec-dashboard" class="panel">
    <h2>Dashboard</h2>
    <div class="grid cols-4">
      <div class="panel">
        <b>Trabajos abiertos</b>
        <div id="metric-open" class="big"></div>
        <a class="btn" href="#" onclick="goto('jobs')">Ir a Trabajos</a>
      </div>
      <div class="panel">
        <b>Horas hoy</b>
        <div id="metric-hours"></div>
        <a class="btn" href="#" onclick="goto('labor')">Rastrear Mano de Obra</a>
      </div>
      <div class="panel">
        <b>Inventario bajo</b>
        <div id="metric-low"></div>
        <a class="btn" href="#" onclick="goto('inventory')">Inventario</a>
      </div>
      <div class="panel">
        <b>Citas próximas</b>
        <div id="metric-appts"></div>
        <a class="btn" href="#" onclick="goto('schedule')">Agenda</a>
      </div>
    </div>
  </section>

  <!-- CODIGOS DE ERROR -->
  <section id="sec-codes" class="panel" hidden>
    <h2>Códigos de error automotrices</h2>
    <div class="grid cols-3">
      <div><label>Búsqueda</label><input id="codeSearch" placeholder="P0300, ABS, ‘misfire’, etc." oninput="renderCodeTable()"></div>
      <div><label>Marca (opcional)</label><input id="codeMake" placeholder="Toyota, GM, etc." oninput="renderCodeTable()"></div>
      <div class="grid">
        <button class="btn" onclick="importCodes()">Importar CSV/JSON</button>
        <button class="btn" onclick="exportCodes()">Exportar CSV</button>
        <button class="btn ok" onclick="openCodeEditor()">Añadir código</button>
      </div>
    </div>
    <table class="table" id="codeTable"><thead><tr>
      <th>Código</th><th>Sistema</th><th>Descripción</th><th>Marca</th><th class="no-print">Acciones</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <!-- TRABAJOS / FACTURACION -->
  <section id="sec-jobs" class="panel" hidden>
    <h2>Trabajos & Facturación</h2>
    <div class="grid cols-3">
      <div><label>Cliente</label><input id="jCliente" placeholder="Nombre"></div>
      <div><label>Teléfono</label><input id="jTel" placeholder="+1 ..."></div>
      <div><label>Email</label><input id="jEmail" placeholder="correo@..."></div>
      <div><label>Vehículo (VIN/Placa)</label><input id="jVeh" placeholder="VIN o placa"></div>
      <div><label>Notas</label><input id="jNotas" placeholder="Descripción del problema"></div>
      <div class="grid">
        <button class="btn ok" onclick="addJob()">Crear trabajo</button>
        <button class="btn" onclick="renderJobs()">Refrescar</button>
      </div>
    </div>
    <table class="table" id="jobsTable"><thead><tr>
      <th>#</th><th>Cliente</th><th>Vehículo</th><th>Total</th><th>Estado</th><th class="no-print">Acciones</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <!-- MANO DE OBRA / TIMERS -->
  <section id="sec-labor" class="panel" hidden>
    <h2>Rastreo de mano de obra</h2>
    <div class="grid cols-4">
      <div><label>ID Trabajo</label><input id="labJob" placeholder="ID"></div>
      <div><label>Técnico</label><input id="labTech" placeholder="Nombre"></div>
      <div><label>Tarifa $/h</label><input id="labRate" type="number" value="65"></div>
      <div><label>Detalle</label><input id="labNote" placeholder="Diagnóstico, reparación…"></div>
      <div class="grid">
        <button class="btn ok" onclick="startTimer()">Iniciar</button>
        <button class="btn warn" onclick="stopTimer()">Detener</button>
        <button class="btn" onclick="renderLabor()">Refrescar</button>
      </div>
    </div>
    <table class="table" id="laborTable"><thead><tr>
      <th>Trabajo</th><th>Técnico</th><th>Inicio</th><th>Fin</th><th>Horas</th><th>Costo</th><th class="no-print">Acciones</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <!-- INVENTARIO -->
  <section id="sec-inventory" class="panel" hidden>
    <h2>Inventario</h2>
    <div class="grid cols-4">
      <div><label>SKU</label><input id="iSku"></div>
      <div><label>Descripción</label><input id="iDesc"></div>
      <div><label>Costo</label><input id="iCost" type="number" step="0.01"></div>
      <div><label>Precio</label><input id="iPrice" type="number" step="0.01"></div>
      <div><label>Cantidad</label><input id="iQty" type="number" value="1"></div>
      <div class="grid">
        <button class="btn ok" onclick="addInv()">Añadir</button>
        <button class="btn" onclick="exportInv()">Exportar CSV</button>
        <button class="btn" onclick="importInv()">Importar CSV</button>
      </div>
    </div>
    <table class="table" id="invTable"><thead><tr>
      <th>SKU</th><th>Descripción</th><th>Cant</th><th>Precio</th><th class="no-print">Acciones</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <!-- AGENDA -->
  <section id="sec-schedule" class="panel" hidden>
    <h2>Agenda / Scheduling</h2>
    <div class="grid cols-4">
      <div><label>Cliente</label><input id="aCliente"></div>
      <div><label>Fecha y hora</label><input id="aDate" type="datetime-local"></div>
      <div><label>Vehículo</label><input id="aVeh"></div>
      <div><label>Notas</label><input id="aNotas"></div>
      <div class="grid">
        <button class="btn ok" onclick="addAppt()">Crear cita</button>
        <button class="btn" onclick="renderAppts()">Refrescar</button>
      </div>
    </div>
    <table class="table" id="apptTable"><thead><tr>
      <th>Fecha</th><th>Cliente</th><th>Vehículo</th><th>Notas</th><th class="no-print">ICS</th><th class="no-print">Borrar</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <!-- HISTORIAL -->
  <section id="sec-history" class="panel" hidden>
    <h2>Historial de servicio</h2>
    <div class="grid cols-3">
      <div><label>Cliente/VIN/Placa</label><input id="hKey" placeholder="Busca…"></div>
      <div><label>Detalle</label><input id="hDetail"></div>
      <div class="grid">
        <button class="btn ok" onclick="addHistory()">Añadir</button>
        <button class="btn" onclick="renderHistory()">Refrescar</button>
      </div>
    </div>
    <table class="table" id="histTable"><thead><tr>
      <th>Fecha</th><th>Clave</th><th>Detalle</th><th class="no-print">Borrar</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <!-- REPORTES -->
  <section id="sec-reports" class="panel" hidden>
    <h2>Reportes & Exportaciones</h2>
    <div class="grid cols-3">
      <div class="panel">
        <b>Ventas (facturas cerradas)</b>
        <div id="repSales" class="small"></div>
      </div>
      <div class="panel">
        <b>Horas trabajadas</b>
        <div id="repHours" class="small"></div>
      </div>
      <div class="panel">
        <b>Inventario usado</b>
        <div id="repInv" class="small"></div>
      </div>
    </div>
    <div class="grid">
      <button class="btn" onclick="exportCSV('jobs',get('jobs'))">Exportar trabajos CSV</button>
      <button class="btn" onclick="exportCSV('labor',get('labor'))">Exportar mano de obra CSV</button>
      <button class="btn" onclick="exportCSV('inventory',get('inv'))">Exportar inventario CSV</button>
      <button class="btn" onclick="window.print()">Exportar PDF (Imprimir)</button>
    </div>
  </section>

  <!-- SUPLIDORES / ORDENES ONLINE -->
  <section id="sec-suppliers" class="panel" hidden>
    <h2>Part Supplier & Online Ordering</h2>
    <div class="grid cols-3">
      <div><label>Nombre</label><input id="sName"></div>
      <div><label>URL</label><input id="sUrl" placeholder="https://…"></div>
      <div class="grid"><button class="btn ok" onclick="addSupplier()">Añadir</button></div>
    </div>
    <div><label>Búsqueda de pieza</label><input id="sQuery" placeholder="Ej. alternator corolla 2015" oninput="renderSuppliers()"></div>
    <table class="table" id="supTable"><thead><tr>
      <th>Suplidor</th><th>Visitar</th><th class="no-print">Borrar</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <!-- CONFIGURACION -->
  <section id="sec-settings" class="panel" hidden>
    <h2>Configuración</h2>
    <div class="grid cols-3">
      <div><label>Nombre del taller</label><input id="sShop" value="Taller PRO"></div>
      <div><label>Teléfono</label><input id="sPhone" value="(787) 000-0000"></div>
      <div><label>Impuesto/IVU %</label><input id="sTax" type="number" value="11.5"></div>
      <div><label>Logo (encabezado)</label><input id="sLogo" type="file" accept="image/*" onchange="saveLogo(this)"></div>
      <div><label>URL Pagos con tarjeta</label><input id="sPayUrl" placeholder="Pega aquí tu Stripe/ATH Checkout"></div>
      <div><label>URL base para pedidos online</label><input id="sOrderBase" placeholder="https://tutienda.com/buscar?q="></div>
      <div class="grid">
        <button class="btn ok" onclick="saveSettings()">Guardar</button>
        <button class="btn danger" onclick="if(confirm('¿Borrar todo?')){localStorage.clear();location.reload()}">Reset</button>
      </div>
    </div>
    <p class="small">Conexiones “Tablet x5”: usa <b>Exportar sesión</b> en esta sección y abre el JSON en hasta 5 tablets (Importar sesión) para clonar datos de lectura.</p>
    <div class="grid">
      <button class="btn" onclick="exportSession()">Exportar sesión</button>
      <button class="btn" onclick="importSession()">Importar sesión</button>
    </div>
  </section>

  <!-- MODALES SENCILLOS -->
  <dialog id="dlg-code">
    <form method="dialog" class="grid">
      <h3>Nuevo/Editar Código</h3>
      <input id="mCode" placeholder="Código (P0xxx/ABS/etc)">
      <input id="mSys" placeholder="Sistema (Motor/Frenos/etc)">
      <textarea id="mDesc" rows="3" placeholder="Descripción"></textarea>
      <input id="mMake" placeholder="Marca (opcional)">
      <menu>
        <button class="btn" value="cancel">Cancelar</button>
        <button class="btn ok" value="ok">Guardar</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlg-invoice">
    <form method="dialog" class="grid">
      <h3>Factura / Order de trabajo</h3>
      <div class="grid cols-3">
        <div><label>Trabajo ID</label><input id="fId" readonly></div>
        <div><label>Estado</label>
          <select id="fState">
            <option value="abierto">Abierto</option>
            <option value="aprobado">Aprobado</option>
            <option value="cerrado">Cerrado</option>
          </select>
        </div>
        <div><label>Descuento $</label><input id="fDisc" type="number" value="0"></div>
      </div>

      <div class="grid cols-4">
        <div><label>SKU</label><input id="fSku"></div>
        <div><label>Cant</label><input id="fQty" type="number" value="1"></div>
        <div><label>Precio</label><input id="fPrice" type="number" step="0.01"></div>
        <div class="grid"><button class="btn" onclick="return addLine()">Añadir línea</button></div>
      </div>

      <div id="fLines" class="small"></div>
      <div id="fTotals"><b>Total:</b> $0.00</div>

      <menu>
        <button class="btn" value="cancel">Cerrar</button>
        <button class="btn" onclick="return printInvoice()">Imprimir / PDF</button>
        <a id="payBtn" class="btn ok" href="#" target="_blank">Pagar ahora</a>
        <button class="btn ok" value="ok">Guardar cambios</button>
      </menu>

      <div class="invoice print-only">
        <h2 id="pShop">Taller PRO</h2>
        <div id="pShopMeta" class="small"></div>
        <hr>
        <div id="pClient"></div>
        <div id="pJob"></div>
        <table class="table">
          <thead><tr><th>SKU/Descripción</th><th>Cant</th><th>Precio</th><th>Subtotal</th></tr></thead>
          <tbody id="pLines"></tbody>
        </table>
        <div id="pTotals" style="text-align:right;margin-top:8px"></div>
      </div>
    </form>
  </dialog>

  <input id="filePicker" type="file" accept=".csv,.json" style="display:none">
</main>

<script>
// ======= Utilidades LocalStorage =======
const get = k => JSON.parse(localStorage.getItem(k)||'[]');
const put = (k,v) => localStorage.setItem(k,JSON.stringify(v));
const num = n => Number(n||0);
const fmt = v => '$'+(Math.round(v*100)/100).toFixed(2);

// ======= Navegación =======
const sections = {
  dashboard:'sec-dashboard', codes:'sec-codes', jobs:'sec-jobs', labor:'sec-labor',
  inventory:'sec-inventory', schedule:'sec-schedule', history:'sec-history',
  reports:'sec-reports', suppliers:'sec-suppliers', settings:'sec-settings'
};
const menu = [
  ['Dashboard','dashboard'], ['Códigos','codes'], ['Trabajos','jobs'],
  ['Mano de obra','labor'], ['Inventario','inventory'], ['Agenda','schedule'],
  ['Historial','history'], ['Reportes','reports'], ['Suplidores','suppliers'], ['Config','settings']
];
function buildNav(){
  const nav = document.getElementById('topnav'); nav.innerHTML='';
  menu.forEach(([t, id])=>{
    const b = document.createElement('button'); b.textContent=t;
    b.onclick=()=>goto(id); b.id='btn-'+id; nav.appendChild(b);
  });
}
function goto(id){
  Object.values(sections).forEach(sec=>document.getElementById(sec).hidden=true);
  document.getElementById(sections[id]).hidden=false;
  menu.forEach(([t,i])=>document.getElementById('btn-'+i).classList.toggle('active', i===id));
  if(id==='dashboard') refreshMetrics();
}
buildNav(); goto('dashboard');

// ======= Configuración & Logo =======
function saveSettings(){
  const s = {
    shop: document.getElementById('sShop').value.trim(),
    phone: document.getElementById('sPhone').value.trim(),
    tax: num(document.getElementById('sTax').value),
    payUrl: document.getElementById('sPayUrl').value.trim(),
    orderBase: document.getElementById('sOrderBase').value.trim(),
    logo: localStorage.getItem('logoHeader')||''
  };
  localStorage.setItem('settings', JSON.stringify(s));
  applySettings();
  alert('Configuración guardada');
}
function applySettings(){
  const s = JSON.parse(localStorage.getItem('settings')||'{}');
  if(s.shop){ document.querySelector('header b').textContent = s.shop; }
  const lg = document.getElementById('logoHeader');
  if(s.logo){ lg.src=s.logo; lg.style.display='block'; }
  document.getElementById('sShop').value = s.shop||'Taller PRO';
  document.getElementById('sPhone').value = s.phone||'(787) 000-0000';
  document.getElementById('sTax').value = s.tax??11.5;
  document.getElementById('sPayUrl').value = s.payUrl||'';
  document.getElementById('sOrderBase').value = s.orderBase||'';
}
function saveLogo(inp){
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { localStorage.setItem('logoHeader', e.target.result); applySettings(); };
  r.readAsDataURL(f);
}
applySettings();

// ======= Códigos =======
function renderCodeTable(){
  const q = document.getElementById('codeSearch').value.toLowerCase();
  const mk = document.getElementById('codeMake').value.toLowerCase();
  const tb = document.querySelector('#codeTable tbody'); tb.innerHTML='';
  get('codes').filter(c=>{
    return (!q || (c.code+c.sys+c.desc).toLowerCase().includes(q))
        && (!mk || (c.make||'').toLowerCase().includes(mk));
  }).forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.code}</td><td>${c.sys}</td><td>${c.desc}</td><td>${c.make||''}</td>
    <td class="no-print"><button class="btn" onclick="editCode(${i})">Editar</button>
    <button class="btn danger" onclick="delCode(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}
function openCodeEditor(c=null, idx=null){
  const d = document.getElementById('dlg-code');
  document.getElementById('mCode').value=c?.code||'';
  document.getElementById('mSys').value=c?.sys||'';
  document.getElementById('mDesc').value=c?.desc||'';
  document.getElementById('mMake').value=c?.make||'';
  d.returnValue=''; d.showModal();
  d.onclose=()=>{
    if(d.returnValue==='ok'){
      const item = {
        code: document.getElementById('mCode').value.trim(),
        sys: document.getElementById('mSys').value.trim(),
        desc: document.getElementById('mDesc').value.trim(),
        make: document.getElementById('mMake').value.trim()
      };
      const arr=get('codes');
      if(idx!=null) arr[idx]=item; else arr.push(item);
      put('codes',arr); renderCodeTable();
    }
  }
}
function editCode(i){ const arr=get('codes'); openCodeEditor(arr[i], i); }
function delCode(i){ const arr=get('codes'); arr.splice(i,1); put('codes',arr); renderCodeTable(); }
function importCodes(){
  const fp=document.getElementById('filePicker'); fp.onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      let data=[]; const txt=ev.target.result;
      if(f.name.endsWith('.json')) data=JSON.parse(txt);
      else { // CSV: code,sys,desc,make
        txt.split(/\r?\n/).slice(1).forEach(line=>{
          const [code,sys,desc,make]=line.split(','); if(code) data.push({code,sys,desc,make});
        });
      }
      put('codes', get('codes').concat(data)); renderCodeTable();
    };
    r.readAsText(f);
  }; fp.click();
}
function exportCodes(){
  const rows=[['code','sys','desc','make']]
  get('codes').forEach(c=>rows.push([c.code,c.sys,c.desc,c.make]));
  downloadCSV('codes.csv', rows);
}

// ======= Trabajos =======
function addJob(){
  const jobs=get('jobs');
  const j={
    id: Date.now().toString().slice(-6),
    cliente: document.getElementById('jCliente').value.trim(),
    tel: document.getElementById('jTel').value.trim(),
    email: document.getElementById('jEmail').value.trim(),
    veh: document.getElementById('jVeh').value.trim(),
    notas: document.getElementById('jNotas').value.trim(),
    state:'abierto', lines:[], discount:0, subtotal:0, tax:0, total:0
  };
  jobs.push(j); put('jobs',jobs); renderJobs(); alert('Trabajo creado #'+j.id); goto('jobs');
}
function renderJobs(){
  const tb=document.querySelector('#jobsTable tbody'); tb.innerHTML='';
  get('jobs').forEach(j=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${j.id}</td><td>${j.cliente}</td><td>${j.veh}</td>
    <td>${fmt(j.total||0)}</td><td>${j.state}</td>
    <td class="no-print">
      <button class="btn" onclick="openInvoice('${j.id}')">Factura</button>
      <button class="btn danger" onclick="delJob('${j.id}')">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}
function delJob(id){ const arr=get('jobs').filter(j=>j.id!==id); put('jobs',arr); renderJobs(); }

// ======= Factura / líneas =======
let curInvJob=null;
function openInvoice(id){
  const j=get('jobs').find(x=>x.id===id); if(!j) return;
  curInvJob=j;
  document.getElementById('fId').value=j.id;
  document.getElementById('fState').value=j.state;
  document.getElementById('fDisc').value=j.discount||0;
  renderInvoiceLines();
  const s = JSON.parse(localStorage.getItem('settings')||'{}');
  const pay = document.getElementById('payBtn');
  pay.href = s.payUrl||'#';
  pay.style.display = s.payUrl ? 'inline-flex':'none';
  const dlg=document.getElementById('dlg-invoice');
  dlg.returnValue=''; dlg.showModal();
  dlg.onclose=()=>{
    if(dlg.returnValue==='ok'){
      j.state=document.getElementById('fState').value;
      j.discount=num(document.getElementById('fDisc').value);
      calcTotals(j);
      const jobs=get('jobs').map(x=>x.id===j.id?j:x); put('jobs',jobs); renderJobs();
    }
  }
}
function addLine(){
  const sku=document.getElementById('fSku').value.trim(); if(!sku) return false;
  const qty=num(document.getElementById('fQty').value)||1;
  let price=num(document.getElementById('fPrice').value);
  if(!price){
    const inv=get('inv').find(i=>i.sku===sku);
    if(inv){ price=inv.price; inv.qty=Math.max(0,(inv.qty||0)-qty); put('inv', get('inv')); renderInv(); }
  }
  curInvJob.lines.push({sku,qty,price});
  renderInvoiceLines(); return false;
}
function renderInvoiceLines(){
  const box=document.getElementById('fLines'); box.innerHTML='';
  curInvJob.lines.forEach((ln,i)=>{
    const div=document.createElement('div');
    div.innerHTML=`${i+1}. ${ln.sku} × ${ln.qty} @ ${fmt(ln.price)} = ${fmt(ln.qty*ln.price)}
    <button class="btn danger no-print" onclick="remLine(${i})">Quitar</button>`;
    box.appendChild(div);
  });
  document.getElementById('fTotals').innerHTML = `<b>Total:</b> ${fmt(calcTotals(curInvJob))}`;
}
function remLine(i){ curInvJob.lines.splice(i,1); renderInvoiceLines(); }
function calcTotals(j){
  const s = JSON.parse(localStorage.getItem('settings')||'{}');
  j.subtotal = j.lines.reduce((a,b)=>a + (num(b.qty)*num(b.price)),0);
  j.tax = j.subtotal * (num(s.tax)/100);
  const total = Math.max(0, j.subtotal + j.tax - num(j.discount||0));
  j.total = total;
  return total;
}
function printInvoice(){
  // Poblar plantilla de impresión
  const s = JSON.parse(localStorage.getItem('settings')||'{}');
  document.getElementById('pShop').textContent = s.shop||'Taller PRO';
  document.getElementById('pShopMeta').textContent = `${s.phone||''}`;
  document.getElementById('pClient').innerHTML = `<b>Cliente:</b> ${curInvJob.cliente} — ${curInvJob.email||''} — ${curInvJob.tel||''}`;
  document.getElementById('pJob').innerHTML = `<b>Trabajo #${curInvJob.id}</b> | Vehículo: ${curInvJob.veh||''} | Estado: ${curInvJob.state}`;
  const tb=document.getElementById('pLines'); tb.innerHTML='';
  curInvJob.lines.forEach(ln=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ln.sku}</td><td>${ln.qty}</td><td>${fmt(ln.price)}</td><td>${fmt(ln.qty*ln.price)}</td>`;
    tb.appendChild(tr);
  });
  const t = `
    Subtotal: ${fmt(curInvJob.subtotal)}<br>
    Impuesto (${s.tax||0}%): ${fmt(curInvJob.tax)}<br>
    Descuento: ${fmt(num(curInvJob.discount||0))}<br>
    <b>Total: ${fmt(curInvJob.total)}</b>`;
  document.getElementById('pTotals').innerHTML=t;
  window.print();
  return false;
}

// ======= Mano de obra (timers simples) =======
let activeTimer=null;
function startTimer(){
  if(activeTimer){ alert('Ya hay un timer activo.'); return; }
  const item = {
    job: document.getElementById('labJob').value.trim(),
    tech: document.getElementById('labTech').value.trim() || 'Técnico',
    rate: num(document.getElementById('labRate').value)||0,
    note: document.getElementById('labNote').value.trim(),
    start: Date.now(), end:null, hours:0, cost:0
  };
  activeTimer=item; alert('Timer iniciado.');
}
function stopTimer(){
  if(!activeTimer){ alert('No hay timer activo.'); return; }
  activeTimer.end=Date.now();
  const h = (activeTimer.end - activeTimer.start)/3600000;
  activeTimer.hours = h;
  activeTimer.cost = h * (activeTimer.rate||0);
  const arr=get('labor'); arr.push(activeTimer); put('labor',arr);
  // Sumatoria a trabajo
  if(activeTimer.job){
    const jobs=get('jobs'); const j=jobs.find(x=>x.id===activeTimer.job);
    if(j){ j.lines.push({sku:`Mano de obra (${activeTimer.note||activeTimer.tech})`, qty:h.toFixed(2), price:activeTimer.rate}); calcTotals(j); put('jobs',jobs); }
  }
  activeTimer=null; renderLabor(); renderJobs();
}
function renderLabor(){
  const tb=document.querySelector('#laborTable tbody'); tb.innerHTML='';
  get('labor').forEach((l,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${l.job||'-'}</td><td>${l.tech}</td>
    <td>${new Date(l.start).toLocaleString()}</td>
    <td>${l.end?new Date(l.end).toLocaleString():'—'}</td>
    <td>${(l.hours||0).toFixed(2)}</td><td>${fmt(l.cost||0)}</td>
    <td class="no-print"><button class="btn danger" onclick="delLabor(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}
function delLabor(i){ const arr=get('labor'); arr.splice(i,1); put('labor',arr); renderLabor(); }

// ======= Inventario =======
function addInv(){
  const item={sku:val('iSku'), desc:val('iDesc'), cost:num(val('iCost')), price:num(val('iPrice')), qty:num(val('iQty'))||0};
  const arr=get('inv'); const ex=arr.find(x=>x.sku===item.sku);
  if(ex){ ex.desc=item.desc; ex.cost=item.cost; ex.price=item.price; ex.qty = (ex.qty||0)+(item.qty||0); }
  else arr.push(item);
  put('inv',arr); renderInv();
}
function renderInv(){
  const tb=document.querySelector('#invTable tbody'); tb.innerHTML='';
  get('inv').forEach((i,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i.sku}</td><td>${i.desc}</td><td>${i.qty||0}</td><td>${fmt(i.price||0)}</td>
    <td class="no-print"><button class="btn" onclick="useInv(${idx})">Usar</button>
    <button class="btn danger" onclick="delInv(${idx})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}
function useInv(idx){
  const inv=get('inv'); const it=inv[idx]; const jobId=prompt('Trabajo ID para aplicar esta pieza:'); if(!jobId) return;
  const qty = num(prompt('Cantidad:',1))||1;
  const jobs=get('jobs'); const j=jobs.find(x=>x.id===jobId); if(!j) return alert('Trabajo no encontrado');
  if((it.qty||0) < qty) return alert('Cantidad insuficiente en inventario');
  it.qty -= qty; j.lines.push({sku:it.sku+' - '+it.desc, qty, price:it.price}); calcTotals(j);
  put('inv',inv); put('jobs',jobs); renderInv(); renderJobs();
}
function delInv(i){ const arr=get('inv'); arr.splice(i,1); put('inv',arr); renderInv(); }
function exportInv(){
  const rows=[['sku','desc','cost','price','qty']];
  get('inv').forEach(i=>rows.push([i.sku,i.desc,i.cost,i.price,i.qty]));
  downloadCSV('inventario.csv', rows);
}
function importInv(){
  pickFile(text=>{
    const lines=text.split(/\r?\n/).slice(1);
    const arr=get('inv');
    lines.forEach(l=>{ if(!l.trim())return; const [sku,desc,cost,price,qty]=l.split(','); 
      arr.push({sku,desc,cost:num(cost),price:num(price),qty:num(qty)}); });
    put('inv',arr); renderInv();
  });
}

// ======= Agenda =======
function addAppt(){
  const appts=get('appts');
  const a={date:val('aDate'), cliente:val('aCliente'), veh:val('aVeh'), notas:val('aNotas'), id:Date.now()};
  appts.push(a); put('appts',appts); renderAppts();
}
function renderAppts(){
  const tb=document.querySelector('#apptTable tbody'); tb.innerHTML='';
  get('appts').sort((a,b)=>a.date.localeCompare(b.date)).forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(a.date).toLocaleString()}</td><td>${a.cliente}</td><td>${a.veh}</td><td>${a.notas}</td>
      <td class="no-print"><button class="btn" onclick='downloadICS(${JSON.stringify(a.id)})'>ICS</button></td>
      <td class="no-print"><button class="btn danger" onclick='delAppt(${JSON.stringify(a.id)})'>Borrar</button></td>`;
    tb.appendChild(tr);
  });
}
function delAppt(id){ put('appts', get('appts').filter(x=>x.id!==id)); renderAppts(); }
function downloadICS(id){
  const a=get('appts').find(x=>x.id===id); if(!a) return;
  const dt=new Date(a.date);
  const pad=n=>String(n).padStart(2,'0');
  const dtstamp = dt.getUTCFullYear()+pad(dt.getUTCMonth()+1)+pad(dt.getUTCDate())+'T'+pad(dt.getUTCHours())+pad(dt.getUTCMinutes())+'00Z';
  const end = new Date(dt.getTime()+60*60*1000);
  const dtend = end.getUTCFullYear()+pad(end.getUTCMonth()+1)+pad(end.getUTCDate())+'T'+pad(end.getUTCHours())+pad(end.getUTCMinutes())+'00Z';
  const ics = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTAMP:${dtstamp}
DTSTART:${dtstamp}
DTEND:${dtend}
SUMMARY:${a.cliente} – Servicio
DESCRIPTION:${a.veh} ${a.notas}
END:VEVENT
END:VCALENDAR`;
  downloadText('cita_'+a.id+'.ics', ics);
}

// ======= Historial =======
function addHistory(){
  const arr=get('hist');
  arr.push({date:Date.now(), key:val('hKey'), detail:val('hDetail')});
  put('hist',arr); renderHistory();
}
function renderHistory(){
  const tb=document.querySelector('#histTable tbody'); tb.innerHTML='';
  get('hist').sort((a,b)=>b.date-a.date).forEach((h,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(h.date).toLocaleString()}</td><td>${h.key}</td><td>${h.detail}</td>
    <td class="no-print"><button class="btn danger" onclick="delHist(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}
function delHist(i){ const arr=get('hist'); arr.splice(i,1); put('hist',arr); renderHistory(); }

// ======= Reportes & Métricas =======
function refreshMetrics(){
  const open = get('jobs').filter(j=>j.state!=='cerrado').length;
  document.getElementById('metric-open').textContent = open;
  const today = new Date(); today.setHours(0,0,0,0);
  const hours = get('labor').filter(l=>l.end && l.end>=today.getTime()).reduce((a,b)=>a+(b.hours||0),0);
  document.getElementById('metric-hours').textContent = hours.toFixed(2)+' h';
  const low = get('inv').filter(i=>(i.qty||0)<=2).length;
  document.getElementById('metric-low').textContent = low;
  const appts = get('appts').filter(a=>new Date(a.date)>=new Date()).length;
  document.getElementById('metric-appts').textContent = appts;
}
function renderReports(){
  const closed = get('jobs').filter(j=>j.state==='cerrado');
  const sales = closed.reduce((a,b)=>a+(b.total||0),0);
  document.getElementById('repSales').textContent = `Facturas: ${closed.length} — Total: ${fmt(sales)}`;
  const hours = get('labor').reduce((a,b)=>a+(b.hours||0),0);
  document.getElementById('repHours').textContent = `${hours.toFixed(2)} horas`;
  const used = get('inv').filter(i=>(i.qty||0)<=2).length;
  document.getElementById('repInv').textContent = `Bajo stock: ${used}`;
}
setInterval(refreshMetrics, 5000);

// ======= Suplidores =======
function addSupplier(){
  const s={name:val('sName'), url:val('sUrl')};
  const arr=get('sup'); arr.push(s); put('sup',arr); renderSuppliers();
}
function renderSuppliers(){
  const q = (document.getElementById('sQuery').value||'').trim();
  const tb=document.querySelector('#supTable tbody'); tb.innerHTML='';
  const arr=get('sup');
  const base = (JSON.parse(localStorage.getItem('settings')||'{}').orderBase)||'';
  arr.forEach((s,i)=>{
    const link = q ? (s.url.includes('%s') ? s.url.replace('%s', encodeURIComponent(q)) :
               (s.url+(s.url.includes('?')?'&':'?')+'q='+encodeURIComponent(q))) : s.url;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td><td><a class="btn" href="${link}" target="_blank">Abrir</a></td>
    <td class="no-print"><button class="btn danger" onclick="delSup(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}
function delSup(i){ const arr=get('sup'); arr.splice(i,1); put('sup',arr); renderSuppliers(); }

// ======= Sesión (Tablets) =======
function exportSession(){
  const data={
    settings: JSON.parse(localStorage.getItem('settings')||'{}'),
    codes:get('codes'), inv:get('inv'), sup:get('sup')
  };
  downloadText('taller_soloLectura.json', JSON.stringify(data));
}
function importSession(){
  pickFile(text=>{
    const data=JSON.parse(text);
    if(data.settings) localStorage.setItem('settings', JSON.stringify(data.settings));
    ['codes','inv','sup'].forEach(k=>data[k] && put(k,data[k]));
    applySettings(); renderAll(); alert('Sesión importada.');
  });
}

// ======= Helpers de archivos =======
function val(id){return document.getElementById(id).value.trim();}
function downloadText(name,content){
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:'text/plain'})); a.download=name; a.click();
}
function downloadCSV(name,rows){
  const csv = rows.map(r=>r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(',')).join('\n');
  downloadText(name,csv);
}
function exportCSV(name,arr){ const keys=Object.keys(arr[0]||{}); const rows=[keys]; arr.forEach(o=>rows.push(keys.map(k=>o[k]??''))); downloadCSV(name+'.csv',rows); }
function pickFile(cb){
  const fp=document.getElementById('filePicker'); fp.onchange=e=>{ const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=ev=>cb(ev.target.result); r.readAsText(f); };
  fp.click();
}

// ======= Render inicial =======
function renderAll(){ renderCodeTable(); renderJobs(); renderLabor(); renderInv(); renderAppts(); renderHistory(); renderReports(); renderSuppliers(); refreshMetrics(); }
renderAll();

// ======= Demo seeds (puedes borrar) =======
if(get('codes').length===0){
  put('codes',[
    {code:'P0300', sys:'Motor', desc:'Fallo múltiple de encendido (misfire aleatorio)', make:''},
    {code:'P0420', sys:'Emisiones', desc:'Eficiencia baja del catalizador (Banco 1)', make:''},
    {code:'C0035', sys:'ABS', desc:'Sensor de velocidad rueda delantera izquierda – circuito', make:'GM'},
    {code:'U0100', sys:'Red CAN', desc:'Pérdida de comunicación con ECM/PCM', make:''}
  ]);
  renderCodeTable();
}
if(get('sup').length===0){
  put('sup',[
    {name:'RockAuto', url:'https://www.rockauto.com/'},
    {name:'PartsGeek', url:'https://www.partsgeek.com/'},
    {name:'Amazon', url:'https://www.amazon.com/s?k=%s'}
  ]); renderSuppliers();
}
</script>
</body>
</html>
