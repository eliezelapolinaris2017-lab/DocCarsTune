<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OBD-II Avanzado — DTC + Freeze Frame (J1850 / ISO14230 / CAN15765)</title>
<meta name="description" content="Lector OBD-II en navegador con ELM327. DTC genéricos (03/07/0A), Freeze Frame (Modo 02), perfiles por marca, impresión en PDF.">
<style>
:root{
  --bg:#0e0f13; --fg:#e8eaf2; --muted:#a7a7b6; --card:#171a23; --line:#2a2e40;
  --accent:#6ee7b7; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter}
header{position:sticky;top:0;background:#0b0c12cc;border-bottom:1px solid var(--line);backdrop-filter:blur(8px);z-index:10}
h1{font-size:24px;margin:10px 0}
h2{font-size:18px;margin:18px 0 8px}
main{max-width:1200px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
label{font-size:13px;color:var(--muted)}
select,input,button,textarea{
  background:#11131a;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:10px 12px;
}
textarea{width:100%;min-height:120px;resize:vertical}
button{cursor:pointer}
button.primary{border-color:#23352f;background:#13211b}
button.primary:hover{outline:1px solid var(--accent)}
.kbd{font-family:var(--mono);font-size:13px}
pre{background:#0c1018;border:1px solid #1b2132;border-radius:10px;padding:12px;overflow:auto;max-height:260px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
small,.muted{color:var(--muted)}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;color:#cfd0d8;background:#11131a;margin-right:6px}
.ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
.grid{display:grid;gap:16px}
@media(min-width:980px){.grid.cols-2{grid-template-columns:1fr 1fr}}
footer{padding:24px;color:var(--muted);text-align:center}
#printArea h1{margin-top:0}
@media print{
  body{background:#fff;color:#000}
  header, #controls{display:none !important}
  .card{border:none}
  .no-print{display:none !important}
  .only-print{display:block !important}
}
.only-print{display:none}
</style>
</head>
<body>
<header id="controls">
  <main class="row" style="align-items:center;justify-content:space-between;">
    <div>
      <h1>OBD-II Avanzado — DTC + Freeze Frame</h1>
      <small>ELM327 por Web Serial (USB) · HTTPS · Chromium (Chrome/Edge)</small>
    </div>
    <div class="row">
      <button id="btnConnect" class="primary">Conectar ELM327 (USB)</button>
      <button id="btnDisconnect">Desconectar</button>
      <button id="btnSimToggle">Simulador: Off</button>
      <button id="btnPrint">Imprimir / PDF</button>
    </div>
  </main>
</header>

<main id="app">
  <section class="card">
    <h2>1) Protocolo, Perfil y Ajustes</h2>
    <div class="row">
      <div>
        <label>Protocolo (AT SP)</label><br/>
        <select id="proto">
          <option value="0">0 - Auto</option>
          <option value="1">1 - SAE J1850 PWM</option>
          <option value="2">2 - SAE J1850 VPW</option>
          <option value="4">4 - ISO 14230-4 KWP (5-baud)</option>
          <option value="5">5 - ISO 14230-4 KWP (fast)</option>
          <option value="6" selected>6 - ISO 15765-4 CAN (11/500)</option>
          <option value="7">7 - ISO 15765-4 CAN (29/500)</option>
          <option value="8">8 - ISO 15765-4 CAN (11/250)</option>
          <option value="9">9 - ISO 15765-4 CAN (29/250)</option>
        </select>
      </div>
      <div>
        <label>Perfil por marca</label><br/>
        <select id="brand">
          <option value="generic">Genérico OBD-II (funcional)</option>
          <option value="toyota">Toyota / Lexus (CAN11 500, req 7DF, resp 7E8)</option>
          <option value="gm">GM (CAN11 500, 7E0/7E8 ECU motor)</option>
          <option value="vag">VW/Audi (CAN11 500, 7DF/7E8)</option>
          <option value="fca">FCA (CAN11 500, 7E0/7E8; a veces 29-bit)</option>
          <option value="ford">Ford (CAN11 500, 7DF/7E8)</option>
        </select>
      </div>
      <div>
        <label>Cabeceras (ATH)</label><br/>
        <select id="ath">
          <option value="0">ATH0 (ocultar)</option>
          <option value="1" selected>ATH1 (mostrar)</option>
        </select>
      </div>
      <div>
        <label>Timeout (AT ST)</label><br/>
        <select id="timeout">
          <option value="0A">0A (100 ms)</option>
          <option value="0F" selected>0F (250 ms)</option>
          <option value="14">14 (400 ms)</option>
          <option value="28">28 (1 s)</option>
        </select>
      </div>
      <div style="align-self:end">
        <button id="btnInit" class="primary">Inicializar ELM</button>
      </div>
    </div>
    <small>Secuencia típica: <span class="pill">ATZ</span><span class="pill">ATE0</span><span class="pill">ATL0</span><span class="pill">ATS0</span><span class="pill">ATHx</span><span class="pill">ATST xx</span><span class="pill">ATSP x</span><span class="pill">ATSH/ATCRA (según perfil)</span></small>
  </section>

  <section class="card">
    <h2>2) DTC — Leer / Borrar</h2>
    <div class="row">
      <button id="btnReadMil" class="primary">MIL & Monitores (01 01)</button>
      <button id="btnDTCStored" class="primary">DTC almacenados (03)</button>
      <button id="btnDTCPending" class="primary">DTC pendientes (07)</button>
      <button id="btnDTCPermanent" class="primary">DTC permanentes (0A)</button>
      <button id="btnClearDTC" class="bad">Borrar DTC (04)</button>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div>
        <h3>Salida cruda</h3>
        <pre id="raw"></pre>
      </div>
      <div>
        <h3>Decodificación</h3>
        <div id="decoded"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>3) Freeze Frame (Modo 02)</h2>
    <div class="row">
      <div>
        <label>PID Freeze Frame</label><br/>
        <select id="ffPid">
          <option value="00">02 00 — PIDs soportados FF</option>
          <option value="01">02 01 — MIL & DTC count (FF)</option>
          <option value="03">02 03 — Fuel system status (FF)</option>
          <option value="04">02 04 — Carga calc. (FF)</option>
          <option value="05" selected>02 05 — Temp. refrigerante (FF)</option>
          <option value="0B">02 0B — MAP (FF)</option>
          <option value="0C">02 0C — RPM (FF)</option>
          <option value="0D">02 0D — Velocidad (FF)</option>
          <option value="10">02 10 — MAF (FF)</option>
          <option value="11">02 11 — Acelerador (FF)</option>
          <option value="14">02 14 — O2 S1 Voltaje/Trim (FF)</option>
          <option value="06">02 06 — STFT Bank1 (FF)</option>
          <option value="07">02 07 — LTFT Bank1 (FF)</option>
        </select>
      </div>
      <div style="align-self:end">
        <button id="btnFFRead" class="primary">Leer Freeze Frame</button>
      </div>
    </div>
    <small>El <b>Freeze Frame</b> captura una “foto” de parámetros cuando se registra el primer DTC. Se accede con Modo 02 y PIDs análogos a Modo 01.</small>
  </section>

  <section class="card">
    <h2>4) PIDs rápidos (Modo 01) & Comando personalizado</h2>
    <div class="row">
      <button data-cmd="0100" class="primary">01 00 — PIDs soportados</button>
      <button data-cmd="010C" class="primary">01 0C — RPM</button>
      <button data-cmd="010D" class="primary">01 0D — Velocidad</button>
      <button data-cmd="0105" class="primary">01 05 — ECT</button>
      <button data-cmd="0110" class="primary">01 10 — MAF</button>
      <button data-cmd="0111" class="primary">01 11 — Acelerador</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="customCmd" class="kbd" placeholder="Comando crudo (ej: 2210A0 para UDS)"/>
      <button id="btnSendCustom">Enviar</button>
    </div>
    <small>Para pruebas UDS/extendido (cuando aplique), puedes usar <b>22 F1 90</b>, etc., según la ECU. Requiere encabezados adecuados (<b>ATSH</b>) y protocolo CAN/ISO-TP.</small>
  </section>

  <section class="card">
    <h2>5) Reporte</h2>
    <div class="row">
      <input id="vehInfo" placeholder="Cliente/Placa/VIN (opcional)"/>
      <button id="btnAddNote">Añadir nota al reporte</button>
      <button id="btnClearReport">Limpiar reporte</button>
    </div>
    <div id="report" class="card" style="margin-top:10px;background:#12141c">
      <div id="printArea">
        <h1>Reporte OBD-II</h1>
        <p class="muted">Fecha: <span id="repDate"></span></p>
        <p><b>Vehículo:</b> <span id="repVeh"></span></p>
        <div id="repBody"></div>
      </div>
    </div>
  </section>

  <section class="card no-print">
    <h2>Notas</h2>
    <ul>
      <li>Para **J1850/KWP**, aumenta <b>AT ST</b> si ves “NO DATA”.</li>
      <li>En **CAN**, el ELM reensambla tramas largas (ISO-TP) cuando corresponde.</li>
      <li>El borrado (04) elimina DTC y <i>freeze frame</i>. Hazlo bajo tu responsabilidad, motor apagado.</li>
    </ul>
  </section>
</main>

<footer class="no-print">
  Hecho para GitHub Pages · Requiere navegador con <b>Web Serial</b>. © 2025
</footer>

<script>
/* ======================================================
   Núcleo OBD-II Web Serial + Perfiles por Marca + Freeze
   ====================================================== */
let port, reader, writer;
let rawEl = document.getElementById('raw');
let decodedEl = document.getElementById('decoded');
let isSim = false;

const UI = {
  logRaw: (s) => { rawEl.textContent = (rawEl.textContent + s + "\\n").slice(-14000); },
  clearRaw: () => rawEl.textContent = '',
  showDecoded: (html) => decodedEl.innerHTML = html,
  appendDecoded: (html) => decodedEl.innerHTML += html,
  addReport: (html) => document.getElementById('repBody').innerHTML += html,
  setRepVeh: (txt) => document.getElementById('repVeh').textContent = txt || "—",
  touchDate: ()=> document.getElementById('repDate').textContent = new Date().toLocaleString()
};

UI.touchDate();

/* --------------- Simulador (sin hardware) ---------------- */
const Sim = {
  on: false,
  send: async (cmd) => {
    const c = cmd.replace(/\\s+/g,'').toUpperCase();
    // Respuestas típicas minimalistas
    if(c==="ATZ") return "ELM327 v1.5\\r\\r>";
    if(/^AT(E0|L0|S0|H[01]|SP[0-9]|ST[0-9A-F]{2}|SH[0-9A-F]+|CRA[0-9A-F]+)$/.test(c)) return "OK\\r\\r>";
    if(c==="0101") return "41 01 83 07 65 00\\r\\r>"; // MIL on (ejemplo), 3 DTC
    if(c==="03")   return "43 01 33 02 10 00\\r\\r>"; // P0133, P0210
    if(c==="07")   return "47 03 00 00 00\\r\\r>";     // P0300 pendiente
    if(c==="0A")   return "4A 00 00 00 00\\r\\r>";     // sin permanentes
    if(c==="04")   return "44\\r\\r>";                // borrado ok
    // Freeze Frame (02 xx)
    if(c==="0205") return "42 05 5A\\r\\r>";          // ECT ~ 50°C (0x5A -> 90-40)
    if(c==="020C") return "42 0C 1A F8\\r\\r>";       // RPM ~ 1726
    if(c==="020D") return "42 0D 28\\r\\r>";          // 40 km/h
    if(c==="0210") return "42 10 01 F4\\r\\r>";       // MAF 0x01F4 -> 5.00 g/s
    if(c==="0211") return "42 11 50\\r\\r>";          // Throttle 80 *100/255 ~31% (nota: demo)
    if(c==="020B") return "42 0B 3C\\r\\r>";          // MAP 60 kPa
    if(c==="0214") return "42 14 20 80\\r\\r>";       // O2 S1 0.32V, STFT ~ 0%
    if(c==="0105") return "41 05 5A\\r\\r>";
    if(c==="010C") return "41 0C 1A F8\\r\\r>";
    if(c==="010D") return "41 0D 28\\r\\r>";
    if(c==="0110") return "41 10 01 F4\\r\\r>";
    if(c==="0111") return "41 11 50\\r\\r>";
    if(c==="0100") return "41 00 BE 3F A8 13\\r\\r>";
    return "NO DATA\\r\\r>";
  }
};

/* --------------- Helpers HEX / Decodificación ------------- */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const hexBytes = (str)=>str.replace(/[^0-9A-F]/gi,' ').trim().split(/\\s+/).filter(Boolean);
const toHex = (n)=>n.toString(16).toUpperCase().padStart(2,'0');

/* DTC (SAE J2012) */
function decodeDTCsFromService(resp, expectService){
  let body = resp.replace(/\\r/g,' ').replace(/>/g,' ').replace(/S:.*?\\n/g,' ').replace(/\\s+/g,' ').trim();
  const tokens = hexBytes(body);
  // Busca cabecera de servicio (ej: 43, 47, 4A)
  let i = tokens.findIndex(t => t.toUpperCase()===expectService);
  if(i>=0) i++;
  else i = 0; // heurística si ATH0
  const dtcs = [];
  for(let k=i; k+1<tokens.length; k+=2){
    const A = parseInt(tokens[k],16), B = parseInt(tokens[k+1],16);
    if(isNaN(A)||isNaN(B)) break;
    if(A===0 && B===0) break;
    const type = ["P","C","B","U"][A>>6] || "P";
    const d1 = (A>>4)&0x3, d2=A&0xF, d3=(B>>4)&0xF, d4=B&0xF;
    dtcs.push(`${type}${d1}${d2}${d3}${d4}`);
  }
  return dtcs;
}

/* 41 01 MIL & monitores */
function decodeMil41_01(resp){
  const t = hexBytes(resp);
  const i = t.findIndex(x=>x.toUpperCase()==="41");
  let A,B,C,D;
  if(i>=0 && t[i+1]==="01"){ A=parseInt(t[i+2],16); B=parseInt(t[i+3],16); C=parseInt(t[i+4],16); D=parseInt(t[i+5],16);}
  if([A,B,C,D].some(x=>isNaN(x))) return "<p class='muted'>No se pudo interpretar 41 01.</p>";
  const mil = (A & 0x80)!==0, cnt=A&0x7F;
  return `<p><b>MIL:</b> ${mil?'<span class="bad">ON</span>':'<span class="ok">OFF</span>'} — <b>DTC:</b> ${cnt}</p>
          <p class="muted">A=${toHex(A)} B=${toHex(B)} C=${toHex(C)} D=${toHex(D)}</p>`;
}

/* Decodificadores de PIDs (01/02) comunes */
const PID = {
  rpm:(A,B)=>((256*A+B)/4).toFixed(0)+" rpm",
  speed:(A)=>A+" km/h",
  ect:(A)=>(A-40)+" °C",
  map:(A)=>A+" kPa",
  maf:(A,B)=>(((256*A+B)/100).toFixed(2))+" g/s",
  tps:(A)=>((A*100)/255).toFixed(1)+" %",
  o2v_stft:(A,B)=>((A/200).toFixed(2)+" V / "+(((B-128)*100)/128).toFixed(1)+" %")
};

function decodePID(resp, modePid /* e.g. '41 0C' or '42 0C' */){
  const t = hexBytes(resp);
  const mode = modePid.slice(0,2).toUpperCase(); // '41' o '42'
  const pid  = modePid.slice(3,5).toUpperCase(); // '0C'
  const i = t.findIndex(x=>x.toUpperCase()===mode);
  if(i<0) return null;
  if(t[i+1]!==pid) return null;
  const A = parseInt(t[i+2],16), B=parseInt(t[i+3],16), C=parseInt(t[i+4]||"00",16);
  switch(pid){
    case "0C": return PID.rpm(A,B);
    case "0D": return PID.speed(A);
    case "05": return PID.ect(A);
    case "0B": return PID.map(A);
    case "10": return PID.maf(A,B);
    case "11": return PID.tps(A);
    case "14": return PID.o2v_stft(A,B);
    case "06": return ((A-128)*100/128).toFixed(1)+" % (STFT B1)";
    case "07": return ((A-128)*100/128).toFixed(1)+" % (LTFT B1)";
    default: return "Valor decodificado no implementado para PID "+pid;
  }
}

/* --------------- Web Serial ---------------- */
async function connect(){
  if(!("serial" in navigator) && !Sim.on){
    alert("Tu navegador no soporta Web Serial. Usa Chrome/Edge de escritorio o activa el simulador.");
    return;
  }
  if(Sim.on) return; // sin puerto
  port = await navigator.serial.requestPort();
  await port.open({ baudRate: 38400 });
  writer = port.writable.getWriter();
  reader = port.readable.getReader();
}

async function disconnect(){
  try{ if(reader){await reader.releaseLock();} if(writer){await writer.releaseLock();} if(port){await port.close();} }catch(e){}
}

/* Envío / lectura hasta '>' */
async function serialWrite(line){
  const clean = line.trim();
  UI.logRaw("> "+clean);
  if(Sim.on){
    const simResp = await Sim.send(clean);
    UI.logRaw(simResp.trim());
    return simResp;
  }
  await writer.write(new TextEncoder().encode(clean+"\\r"));
  let buffer = "";
  while(true){
    const {value, done} = await reader.read();
    if(done) break;
    const txt = new TextDecoder().decode(value);
    buffer += txt;
    if(txt.includes(">")) break;
  }
  UI.logRaw(buffer.trim());
  return buffer;
}

/* --------------- Perfiles por marca -------------- */
const Profiles = {
  generic: async()=>{ /* funcional 7DF */ await serialWrite("ATSH7DF"); await serialWrite("ATCRA7E8"); },
  toyota:  async()=>{ await serialWrite("ATSP6");  await serialWrite("ATSH7DF"); await serialWrite("ATCRA7E8"); },
  gm:      async()=>{ await serialWrite("ATSP6");  await serialWrite("ATSH7E0"); await serialWrite("ATCRA7E8"); }, // ECU motor 7E0/7E8
  vag:     async()=>{ await serialWrite("ATSP6");  await serialWrite("ATSH7DF"); await serialWrite("ATCRA7E8"); },
  fca:     async()=>{ await serialWrite("ATSP6");  await serialWrite("ATSH7E0"); await serialWrite("ATCRA7E8"); },
  ford:    async()=>{ await serialWrite("ATSP6");  await serialWrite("ATSH7DF"); await serialWrite("ATCRA7E8"); },
};

/* --------------- Inicialización ELM --------------- */
async function initElm(){
  UI.clearRaw(); UI.showDecoded(""); UI.touchDate();
  const ath = document.getElementById('ath').value;
  const st  = document.getElementById('timeout').value;
  const sp  = document.getElementById('proto').value;
  await serialWrite("ATZ"); await sleep(300);
  await serialWrite("ATE0");
  await serialWrite("ATL0");
  await serialWrite("ATS0");
  await serialWrite("ATH"+ath);
  await serialWrite("ATST"+st);
  await serialWrite("ATSP"+sp);
  // Perfil
  const brand = document.getElementById('brand').value;
  if(Profiles[brand]){ await Profiles[brand](); }
  UI.showDecoded(`<p>ELM listo. Protocolo: ${sp}, ATH${ath}, ST=${st}, Perfil: <b>${brand}</b></p>`);
}

/* --------------- Operaciones OBD ------------------ */
async function readMil(){
  const resp = await serialWrite("0101");
  const html = decodeMil41_01(resp);
  UI.showDecoded(html);
  UI.addReport(`<h3>MIL & Monitores</h3>${html}`);
}

async function readDtcStored(){
  const resp = await serialWrite("03");
  const codes = decodeDTCsFromService(resp, "43");
  renderDtc("DTC almacenados (03)", codes);
}
async function readDtcPending(){
  const resp = await serialWrite("07");
  const codes = decodeDTCsFromService(resp, "47");
  renderDtc("DTC pendientes (07)", codes);
}
async function readDtcPermanent(){
  const resp = await serialWrite("0A");
  const codes = decodeDTCsFromService(resp, "4A");
  renderDtc("DTC permanentes (0A)", codes);
}
function renderDtc(title, codes){
  if(!codes.length){
    UI.showDecoded(`<p class="ok">Sin códigos en ${title}.</p>`);
    UI.addReport(`<h3>${title}</h3><p>Sin códigos.</p>`);
    return;
  }
  let html = `<h3>${title}</h3><table class="table"><thead><tr><th>Código</th><th>Sistema</th></tr></thead><tbody>`;
  codes.forEach(c=>{
    const sys = c[0]==="P"?"Powertrain":c[0]==="C"?"Chassis":c[0]==="B"?"Body":"Network";
    html += `<tr><td><b>${c}</b></td><td>${sys}</td></tr>`;
  });
  html += "</tbody></table>";
  UI.showDecoded(html);
  UI.addReport(html);
}

async function clearDTC(){
  if(!confirm("Borrar DTC y Freeze Frame (Modo 04). Motor apagado, ignición en ON. ¿Continuar?")) return;
  const resp = await serialWrite("04");
  UI.showDecoded("<p>Solicitud de borrado enviada (04). Verifica MIL y vuelve a leer DTC.</p>");
  UI.addReport("<p><b>Borrado de DTC solicitado.</b></p>");
}

/* Freeze Frame (Modo 02) */
async function readFreezeFrame(){
  const pid = document.getElementById('ffPid').value.toUpperCase();
  const cmd = "02"+pid;
  const resp = await serialWrite(cmd);
  let txt = decodePID((resp||""), (pid>'00' ? "42 "+pid : "42 00"));
  if(!txt) txt = "<span class='muted'>No se pudo decodificar el dato de FF.</span>";
  const title = `Freeze Frame — PID ${pid}`;
  UI.showDecoded(`<h3>${title}</h3><p>${txt}</p>`);
  UI.addReport(`<h3>${title}</h3><p>${txt}</p>`);
}

/* PIDs rápidos y comando crudo */
async function sendCmdRaw(cmd){
  const clean = cmd.replace(/[^0-9A-Fa-f]/g,'').toUpperCase();
  if(!clean){ alert("Comando vacío"); return; }
  const resp = await serialWrite(clean);
  // Decodificación básica si es 41/42 0C/0D/05/10/11/14
  const maybe = ["41 0C","41 0D","41 05","41 10","41 11","41 14","42 0C","42 0D","42 05","42 10","42 11","42 14"];
  for(const key of maybe){
    const val = decodePID(resp, key);
    if(val){ UI.appendDecoded(`<p>${key}: <b>${val}</b></p>`); UI.addReport(`<p>${key}: <b>${val}</b></p>`); }
  }
}

document.querySelectorAll('[data-cmd]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{ UI.showDecoded(""); await sendCmdRaw(btn.getAttribute('data-cmd')); });
});

/* --------- UI Events --------- */
document.getElementById('btnConnect').addEventListener('click', async ()=>{
  try{ await connect(); alert("Conectado. Ahora inicializa el ELM."); }catch(e){ alert("No se pudo abrir el puerto: "+e); }
});
document.getElementById('btnDisconnect').addEventListener('click', async ()=>{ await disconnect(); alert("Desconectado."); });
document.getElementById('btnInit').addEventListener('click', initElm);
document.getElementById('btnReadMil').addEventListener('click', readMil);
document.getElementById('btnDTCStored').addEventListener('click', readDtcStored);
document.getElementById('btnDTCPending').addEventListener('click', readDtcPending);
document.getElementById('btnDTCPermanent').addEventListener('click', readDtcPermanent);
document.getElementById('btnClearDTC').addEventListener('click', clearDTC);
document.getElementById('btnFFRead').addEventListener('click', readFreezeFrame);
document.getElementById('btnSendCustom').addEventListener('click', async ()=>{
  UI.showDecoded("");
  const p = document.getElementById('customCmd').value.trim();
  await sendCmdRaw(p);
});
document.getElementById('btnSimToggle').addEventListener('click', ()=>{
  Sim.on = !Sim.on; isSim = Sim.on;
  document.getElementById('btnSimToggle').textContent = "Simulador: " + (Sim.on?"On":"Off");
  alert("Simulador " + (Sim.on?"activado":"desactivado") + ".");
});
document.getElementById('btnPrint').addEventListener('click', ()=>{ window.print(); });
document.getElementById('btnAddNote').addEventListener('click', ()=>{
  const txt = prompt("Nota para el reporte:");
  if(txt) UI.addReport(`<p>• ${txt}</p>`);
});
document.getElementById('btnClearReport').addEventListener('click', ()=>{
  document.getElementById('repBody').innerHTML = "";
  UI.touchDate();
});
document.getElementById('vehInfo').addEventListener('change', (e)=> UI.setRepVeh(e.target.value));
UI.setRepVeh(document.getElementById('vehInfo').value||"—");
</script>
</body>
</html>
