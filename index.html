<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Doctor Car Pro ‚Äî OBD-II (ELM327)</title>
<meta name="theme-color" content="#0b0f12">
<!-- librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg0:#0b0f12; --panel:#0f1722; --ink:#e9edf4; --muted:#9aa4b2;
  --pri:#1dd6b3; --pri2:#66f0cf; --acc:#7aa2f7; --line:#1f2a33;
  --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --radius:16px; --gap:14px; --shadow:0 12px 28px rgba(0,0,0,.45);
  --font: ui-sans-serif, system-ui, -apple-system, "SF Pro Text", Inter, Roboto, Arial;
}
*{box-sizing:border-box} html,body{height:100%} body{
  margin:0; font-family:var(--font); color:var(--ink);
  background: radial-gradient(1200px 700px at 70% -10%, #113a39 0%, transparent 60%),
              radial-gradient(900px 600px at -10% 0%, #12313b 0%, transparent 60%),
              var(--bg0);
  letter-spacing:.2px;
}
header{position:sticky; top:0; z-index:80; backdrop-filter:saturate(130%) blur(10px);
  background:rgba(10,14,18,.55); border-bottom:1px solid var(--line)}
.topbar{display:flex; align-items:center; gap:12px; padding:12px 14px}
.logo{width:36px; height:36px; border-radius:10px; background:#000; object-fit:cover}
.brand{font-weight:800} .badge{font-size:12px; color:var(--muted)}
.grow{flex:1}
.btn{display:inline-flex; align-items:center; gap:8px; border-radius:12px; padding:9px 12px; border:1px solid var(--line); cursor:pointer}
.btn.primary{background:linear-gradient(180deg,var(--pri2),var(--pri)); color:#05211b; font-weight:800; border:none}
.btn.ghost{background:#111825; color:var(--ink)}
.backBtn{display:none}
.tag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}

.container{max-width:1100px; margin:18px auto; padding:0 14px}
.card{background:linear-gradient(180deg,#0f1922,#0b1218); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; margin-bottom:16px}
.h{display:flex; align-items:center; gap:10px; margin-bottom:10px}
.h h2{margin:0; font-size:18px}
.row{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--gap)}
@media (max-width:900px){ .row{grid-template-columns:1fr} }
input,select,textarea{width:100%; padding:10px 12px; background:#0f1722; color:var(--ink); border:1px solid var(--line); border-radius:12px; outline:none}
.table{width:100%; border-collapse:collapse; font-size:14px}
.table th,.table td{border-bottom:1px solid var(--line); padding:10px 8px; text-align:left}
.canvasWrap{background:#0f1722; border:1px solid var(--line); border-radius:12px; padding:8px}
.notice{padding:10px 12px; border:1px dashed var(--line); border-radius:10px; color:var(--muted)}
.hidden{display:none!important}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

/* ====== HOME (pantalla completa con botones) ====== */
.homeGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
@media (max-width:900px){ .homeGrid{grid-template-columns:repeat(2,1fr)} }
.tile{
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
  padding:18px; min-height:140px; border-radius:16px;
  background:linear-gradient(180deg,#151e29 0%, #0f1722 100%); border:1px solid var(--line);
  cursor:pointer; box-shadow:var(--shadow); transition:.08s transform, .1s outline; text-align:center; user-select:none
}
.tile:hover{ outline:2px solid var(--pri) } .tile:active{ transform:scale(.98) }
.tile .iconWrap{width:64px; height:64px; border-radius:14px; display:grid; place-items:center; background:#0d1320; border:1px solid #222a3a}
.tile svg{width:34px; height:34px}
.tile .title{font-weight:800} .tile .sub{font-size:12px; color:var(--muted)}
/* evitamos cualquier navegaci√≥n por tabs cl√°sica */
nav{display:none}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <button id="btnBackHome" class="btn ghost backBtn" title="Regresar al men√∫">‚Üê Men√∫ principal</button>
    <img id="appLogo" class="logo" alt="Logo">
    <div>
      <div class="brand">Doctor Car Pro</div>
      <div class="badge">OBD-II ‚Ä¢ ELM327</div>
    </div>
    <span class="grow"></span>
    <span id="connStatus" class="tag">Desconectado</span>
    <button id="btnConnect" class="btn primary">Conectar</button>
    <button id="btnDisconnect" class="btn ghost hidden">Desconectar</button>
  </div>
</header>

<div class="container">
  <!-- ====== HOME (SOLO BOTONES) ====== -->
  <section id="page-home" class="card">
    <div class="h"><h2>Men√∫ principal</h2><span class="tag">Selecciona una funci√≥n</span></div>
    <div class="homeGrid" id="homeGrid">
      <div class="tile" data-go="dash"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 12h4l2 4h4l2-4h2a2 2 0 0 0 2-2V8a3 3 0 0 0-3-3H7A3 3 0 0 0 4 8v2"/><circle cx="9" cy="16.5" r="1.5"/><circle cx="15" cy="16.5" r="1.5"/></svg></div><div class="title">OBD-II / Panel</div><div class="sub">Conexi√≥n y lecturas</div></div>
      <div class="tile" data-go="scan"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 7h16M4 12h16M4 17h16"/><rect x="3" y="5" width="18" height="14" rx="2"/></svg></div><div class="title">Escanear DTC</div><div class="sub">Leer / borrar</div></div>
      <div class="tile" data-go="live"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 12h4l3 6 4-12 3 6h4"/></svg></div><div class="title">Datos en vivo</div><div class="sub">Stream PIDs</div></div>
      <div class="tile" data-go="charts"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 3v18h18"/><path d="M7 13l3 3 7-7"/></svg></div><div class="title">Gr√°ficas & PDF</div><div class="sub">Reporte</div></div>
      <div class="tile" data-go="ff"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 4h16v16H4z"/><path d="M8 8h8v8H8z"/></svg></div><div class="title">Freeze Frame</div><div class="sub">Modo 02</div></div>
      <div class="tile" data-go="im"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 12l4 4 8-8"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg></div><div class="title">Monitores I/M</div><div class="sub">0101 / 01C0</div></div>
      <div class="tile" data-go="info"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="9"/><path d="M12 8v8M12 6h.01"/></svg></div><div class="title">Info del veh√≠culo</div><div class="sub">Modo 09</div></div>
      <div class="tile" data-go="settings"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.6 1.6 0 0 0 .3 1.8l.1.1a2 2 0 1 1-2.8 2.8l-.1-.1a1.6 1.6 0 0 0-1.8-.3 1.6 1.6 0 0 0-1 1.5V21a2 2 0 1 1-4 0v-.2a1.6 1.6 0 0 0-1-1.5 1.6 1.6 0 0 0-1.8.3l-.1.1a2 2 0 1 1-2.8-2.8l.1-.1a1.6 1.6 0 0 0 .3-1.8 1.6 1.6 0 0 0-1.5-1H3a2 2 0 1 1 0-4h.2a1.6 1.6 0 0 0 1.5-1z"/></svg></div><div class="title">Configuraci√≥n</div><div class="sub">Tema/Logo/Usuario</div></div>
      <div class="tile" data-go="upgrade"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg></div><div class="title">Upgrade</div><div class="sub">WhatsApp soporte</div></div>
      <div class="tile" data-go="help"><div class="iconWrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M9 9a3 3 0 0 1 6 0c0 3-3 3-3 6"/><path d="M12 17h.01"/><circle cx="12" cy="12" r="9"/></svg></div><div class="title">Ayuda</div><div class="sub">Tips r√°pidos</div></div>
    </div>
  </section>

  <!-- ====== PANTALLAS (cada funci√≥n) ====== -->

  <!-- Panel -->
  <section id="page-dash" class="card hidden">
    <div class="h"><h2>Panel</h2><span class="tag">Estado general</span></div>
    <div class="row">
      <div class="card">
        <div class="h"><h2>Conexi√≥n</h2></div>
        <label>Transporte</label>
        <div style="display:flex; gap:10px; align-items:center">
          <select id="transport" style="width:auto">
            <option value="auto">Auto (Web Serial/BLE)</option>
            <option value="serial">Web Serial (USB)</option>
            <option value="ble">Web Bluetooth (BLE UART)</option>
            <option value="demo">Demo (sin hardware)</option>
          </select>
          <button id="btnInit" class="btn ghost">Inicializar ECU</button>
        </div>
        <div style="margin-top:10px" class="notice" id="compatNote"></div>
        <hr/>
        <label>Consola</label>
        <textarea id="console" rows="10" class="mono" readonly></textarea>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px">
          <button id="btnClearLog" class="btn ghost">Limpiar</button>
          <span style="color:var(--muted); margin-left:auto">Chrome/Edge desktop recomendado.</span>
        </div>
      </div>
      <div class="card">
        <div class="h"><h2>Acciones r√°pidas</h2></div>
        <div style="display:flex; flex-wrap:wrap; gap:8px">
          <button class="btn ghost" data-at="ATZ">ATZ</button>
          <button class="btn ghost" data-at="ATE0">ATE0</button>
          <button class="btn ghost" data-at="ATL0">ATL0</button>
          <button class="btn ghost" data-at="ATS0">ATS0</button>
          <button class="btn ghost" data-at="ATH0">ATH0</button>
          <button class="btn ghost" data-at="ATSP0">ATSP0</button>
          <button class="btn ghost" data-req="0100">0100 (PIDs)</button>
          <button class="btn ghost" id="btnReadVIN">0902 (VIN)</button>
          <button class="btn ghost" id="btnReadVBAT">0142 (Voltaje)</button>
        </div>
        <hr/>
        <table class="table">
          <tbody>
            <tr><td>Protocolo</td><td class="mono" id="kProto">‚Äî</td></tr>
            <tr><td>VIN</td><td class="mono" id="kVIN">‚Äî</td></tr>
            <tr><td>Voltaje (0142)</td><td class="mono" id="kVBAT">‚Äî</td></tr>
            <tr><td>PIDs 0x00-0x20</td><td class="mono" id="kPID">‚Äî</td></tr>
            <tr><td>C√≥digos DTC activos</td><td class="mono" id="dDTC">‚Äî</td></tr>
          </tbody>
        </table>
        <div style="display:flex; gap:10px; align-items:center">
          <button id="btnQuickPoll" class="btn primary">Leer r√°pido (5s)</button>
          <button id="btnStopPoll" class="btn ghost">Detener</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Scan DTC -->
  <section id="page-scan" class="card hidden">
    <div class="h"><h2>Escanear y borrar DTC</h2><span class="tag">Modo 03 / 04</span></div>
    <div style="display:flex; flex-wrap:wrap; gap:10px">
      <button id="btnScanDTC" class="btn primary">Leer DTC (03)</button>
      <button id="btnClearDTC" class="btn ghost">Borrar DTC (04)</button>
      <button id="btnReadPending" class="btn ghost">Pendientes (07)</button>
      <button id="btnReadPermanent" class="btn ghost">Permanentes (0A)</button>
    </div>
    <hr/>
    <div id="dtcList"></div>
  </section>

  <!-- Live Data -->
  <section id="page-live" class="card hidden">
    <div class="h"><h2>Datos en vivo</h2><span class="tag">Modo 01 PIDs</span></div>
    <div class="row">
      <div class="card"><div class="h"><h2>RPM</h2></div><div class="mono" id="liveRPM" style="font-size:22px">‚Äî</div></div>
      <div class="card"><div class="h"><h2>Velocidad</h2></div><div class="mono" id="liveSPD" style="font-size:22px">‚Äî</div></div>
      <div class="card"><div class="h"><h2>ECT</h2></div><div class="mono" id="liveECT" style="font-size:22px">‚Äî</div></div>
      <div class="card"><div class="h"><h2>Throttle</h2></div><div class="mono" id="liveTHR" style="font-size:22px">‚Äî</div></div>
    </div>
    <div style="display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap">
      <button id="btnStartLive" class="btn primary">Iniciar streaming</button>
      <button id="btnStopLive" class="btn ghost">Detener</button>
      <select id="liveRate" style="width:auto">
        <option value="300">300 ms</option>
        <option value="500" selected>500 ms</option>
        <option value="800">800 ms</option>
        <option value="1000">1000 ms</option>
      </select>
      <span class="tag">Re√∫ne datos para gr√°ficas y PDF</span>
    </div>
    <div class="notice">Tip: usa <span class="mono">ATE0, ATL0, ATS0, ATSP0</span> para menor latencia.</div>
  </section>

  <!-- Reportes & Gr√°ficas -->
  <section id="page-charts" class="card hidden">
    <div class="h"><h2>Reportes & Gr√°ficas</h2><span class="tag">Tiempo real + PDF</span></div>
    <div class="row">
      <div class="card">
        <h3 style="margin-top:0">Gr√°ficas</h3>
        <div class="canvasWrap"><canvas id="chartRPM" height="120"></canvas></div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="chartSPD" height="120"></canvas></div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="chartECT" height="120"></canvas></div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="chartTHR" height="120"></canvas></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Reporte PDF</h3>
        <label>Cliente</label><input id="pdfCliente" placeholder="Nombre del cliente">
        <label>Notas</label><textarea id="pdfNotas" rows="6" placeholder="Observaciones del diagn√≥stico..."></textarea>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button id="btnGenPDF" class="btn primary">Generar PDF</button>
          <button id="btnClearSeries" class="btn ghost">Limpiar series</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Freeze Frame -->
  <section id="page-ff" class="card hidden">
    <div class="h"><h2>Freeze Frame</h2><span class="tag">Modo 02</span></div>
    <button id="btnFF" class="btn ghost">Leer Freeze Frame (02)</button>
    <pre class="mono" id="ffOut">‚Äî</pre>
  </section>

  <!-- I/M readiness -->
  <section id="page-im" class="card hidden">
    <div class="h"><h2>Monitores I/M</h2><span class="tag">0101 / 01C0</span></div>
    <button id="btnIM" class="btn ghost">Leer estado (0101)</button>
    <pre class="mono" id="imOut">‚Äî</pre>
  </section>

  <!-- Vehicle Info -->
  <section id="page-info" class="card hidden">
    <div class="h"><h2>Informaci√≥n del veh√≠culo</h2><span class="tag">Modo 09</span></div>
    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <button id="btnVIN" class="btn ghost">VIN (0902)</button>
      <button id="btnCALID" class="btn ghost">CALID/CVN (0904/0906)</button>
      <button id="btnECUName" class="btn ghost">Nombre ECU (090A)</button>
    </div>
    <pre class="mono" id="infoOut">‚Äî</pre>
  </section>

  <!-- Settings -->
  <section id="page-settings" class="card hidden">
    <div class="h"><h2>Configuraci√≥n</h2><span class="tag">Tema, logo y acceso</span></div>
    <div class="row">
      <div class="card">
        <h3 style="margin-top:0">Personalizaci√≥n visual</h3>
        <label>Subir logo</label><input type="file" id="logoFile" accept="image/*"/>
        <label>Color primario</label><input type="color" id="colorPri" value="#1dd6b3" />
        <label>Color acento</label><input type="color" id="colorAcc" value="#7aa2f7" />
        <div style="display:flex; gap:10px; margin-top:10px">
          <button id="btnSaveTheme" class="btn primary">Guardar tema</button>
          <button id="btnResetTheme" class="btn ghost">Restablecer</button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Usuarios</h3>
        <div class="notice">Login local: credenciales guardadas <b>solo</b> en este dispositivo (LocalStorage, hash).</div>
        <label>Usuario</label><input id="uUser" placeholder="admin"/>
        <label>Contrase√±a</label><input id="uPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button id="btnRegister" class="btn ghost">Crear / Actualizar</button>
          <button id="btnLogin" class="btn primary">Iniciar sesi√≥n</button>
          <button id="btnLogout" class="btn ghost" style="margin-left:auto">Cerrar sesi√≥n</button>
        </div>
        <div id="authState" class="tag" style="margin-top:10px">No autenticado</div>
      </div>
    </div>
  </section>

  <!-- Upgrade -->
  <section id="page-upgrade" class="card hidden">
    <div class="h"><h2>Soporte y mejoras</h2><span class="tag">Contacto directo</span></div>
    <p>¬øNecesitas una funci√≥n nueva, soporte o integraci√≥n? Comun√≠cate por WhatsApp con el desarrollador:</p>
    <a class="btn primary" href="https://wa.me/17876643079" target="_blank" rel="noopener">üí¨ WhatsApp: 787-664-3079</a>
  </section>

  <!-- Help -->
  <section id="page-help" class="card hidden">
    <div class="h"><h2>Ayuda r√°pida</h2><span class="tag">SAE J1850 ‚Ä¢ ISO 14230 ‚Ä¢ ISO 15765 (CAN)</span></div>
    <ul>
      <li>Chrome/Edge (desktop): Web Serial con ELM327 USB/CDC.</li>
      <li>Web Bluetooth (BLE UART) si el adaptador lo soporta.</li>
      <li>Secuencia: <span class="mono">ATZ ‚Üí ATE0 ‚Üí ATL0 ‚Üí ATS0 ‚Üí ATSP0 ‚Üí 0100</span></li>
      <li>DTC: <span class="mono">03</span> lee, <span class="mono">04</span> borra. VIN: <span class="mono">0902</span>. I/M: <span class="mono">0101</span>. Freeze: <span class="mono">02</span>.</li>
    </ul>
  </section>
</div>

<footer style="opacity:.7; font-size:12px; text-align:center; padding:30px 0">¬© <span id="year"></span> Doctor Car Pro</footer>

<!-- Login modal -->
<div id="loginModal" class="modal hidden" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:100">
  <div class="card" style="width:min(560px,92vw)">
    <div class="h"><h2>Bienvenido a Doctor Car Pro</h2></div>
    <p>Crea tu usuario local para proteger configuraci√≥n y datos.</p>
    <div class="row">
      <div><label>Usuario</label><input id="mUser" placeholder="admin"></div>
      <div><label>Contrase√±a</label><input id="mPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    </div>
    <div style="display:flex; gap:10px; margin-top:12px">
      <button id="mCreate" class="btn primary">Crear y entrar</button>
      <button id="mLater" class="btn ghost" style="margin-left:auto">Luego</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Doctor Car Pro ‚Äî Funcional 100% con pantallas individuales
   ========================================================= */
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];
const log = (t)=>{ const c=$("#console"); if(!c) return; c.value += (t.endsWith("\n")? t : (t+"\n")); c.scrollTop=c.scrollHeight; };
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const BRAND_KEY='dcp.brand', AUTH_KEY='dcp.auth', PREF_KEY='dcp.prefs';

const S = {
  transport:'auto', conn:null, reader:null, writer:null,
  bleDev:null, bleTx:null, bleRx:null, serialPort:null,
  buffer:'', liveTimer:null, quickTimer:null, logged:false,
  dtcLast:[], t0: Date.now(),
  series: { t:[], rpm:[], spd:[], ect:[], thr:[] }, maxPoints: 300,
  charts:{}
};

/* ====== Router simple + volver al men√∫ ====== */
const pages=['home','dash','scan','live','charts','ff','im','info','settings','upgrade','help'];
function go(p){ pages.forEach(id=>$("#page-"+id)?.classList.add('hidden')); $("#page-"+p)?.classList.remove('hidden'); $("#btnBackHome").style.display = (p!=='home')?'inline-flex':'none'; window.scrollTo(0,0); savePrefs({ ...loadPrefs(), last:p }); }
go('home');
$("#btnBackHome").onclick=()=>go('home');
$("#homeGrid").addEventListener('click',e=>{ const t=e.target.closest('.tile'); if(!t) return; go(t.dataset.go); });

/* ====== Marca/tema persistente ====== */
function blobToDataURL(buf, type){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(new Blob([buf],{type})); }); }
function loadBrand(){ const x = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
  if (x.logo) $("#appLogo").src = x.logo; else $("#appLogo").src = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="black"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="#1dd6b3" font-family="Arial" font-size="34">DCP</text></svg>`);
  if (x.pri) document.documentElement.style.setProperty('--pri', x.pri);
  if (x.acc) document.documentElement.style.setProperty('--acc', x.acc);
}
loadBrand();
$("#logoFile")?.addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  const b = await f.arrayBuffer(); const img = await blobToDataURL(b, f.type);
  const brand = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}'); brand.logo = img;
  localStorage.setItem(BRAND_KEY, JSON.stringify(brand)); loadBrand();
});
$("#colorPri")?.addEventListener('input', e=> document.documentElement.style.setProperty('--pri', e.target.value));
$("#colorAcc")?.addEventListener('input', e=> document.documentElement.style.setProperty('--acc', e.target.value));
$("#btnSaveTheme")?.addEventListener('click', ()=>{ const b=JSON.parse(localStorage.getItem(BRAND_KEY)||'{}'); b.pri=$("#colorPri").value; b.acc=$("#colorAcc").value; localStorage.setItem(BRAND_KEY, JSON.stringify(b)); });
$("#btnResetTheme")?.addEventListener('click', ()=>{ localStorage.removeItem(BRAND_KEY); loadBrand(); });
$("#year").textContent=new Date().getFullYear();

/* ====== Preferencias ====== */
function loadPrefs(){ return JSON.parse(localStorage.getItem(PREF_KEY)||'{}'); }
function savePrefs(p){ localStorage.setItem(PREF_KEY, JSON.stringify(p)); }
(function restorePrefs(){ const p=loadPrefs(); if(p.transport) $("#transport") && ($("#transport").value=p.transport); if(p.last) go(p.last); })();

/* ====== Compat ====== */
(function showCompat(){ const b=[]; b.push(('serial' in navigator)?'Web Serial disponible':'Web Serial no disponible'); b.push((navigator.bluetooth)?'Web Bluetooth disponible':'Web Bluetooth no disponible'); $("#compatNote") && ($("#compatNote").innerHTML = b.join(' ‚Ä¢ ') + '.'); })();

/* ====== Login local ====== */
function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return 'H'+(h>>>0).toString(16); }
function authState(){ const a=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}'); S.logged=!!a.user; $("#authState") && ($("#authState").textContent=S.logged?`Autenticado como ${a.user}`:'No autenticado'); }
authState();
$("#btnRegister")?.addEventListener('click',()=>{ const u=$("#uUser").value.trim(), p=$("#uPass").value; if(!u||!p) return alert('Usuario y contrase√±a requeridos'); localStorage.setItem(AUTH_KEY, JSON.stringify({user:u, pass:hash(p)})); authState(); alert('Usuario guardado'); });
$("#btnLogin")?.addEventListener('click',()=>{ const u=$("#uUser").value.trim(), p=$("#uPass").value; const a=JSON.parse(localStorage.getItem(AUTH_KEY)||'{}'); if(a.user===u && a.pass===hash(p)){ S.logged=true; $("#loginModal").classList.add('hidden'); authState(); } else alert('Credenciales inv√°lidas'); });
$("#btnLogout")?.addEventListener('click',()=>{ localStorage.removeItem(AUTH_KEY); authState(); });
$("#mCreate")?.addEventListener('click',()=>{ const u=$("#mUser").value.trim(), p=$("#mPass").value; if(!u||!p) return alert('Completa usuario y contrase√±a'); localStorage.setItem(AUTH_KEY, JSON.stringify({user:u, pass:hash(p)})); $("#loginModal").classList.add('hidden'); authState(); });
$("#mLater")?.addEventListener('click',()=> $("#loginModal").classList.add('hidden'));
if (!localStorage.getItem(AUTH_KEY)) $("#loginModal")?.classList.remove('hidden');

/* ====== Transporte ====== */
const Transport = {
  async connect(kind){
    S.transport=kind||($("#transport")?.value||'auto');
    savePrefs({ ...loadPrefs(), transport:S.transport });
    if (S.transport==='serial' || (S.transport==='auto' && 'serial' in navigator)) return await TransportSerial.connect();
    else if (S.transport==='ble' || (S.transport==='auto' && navigator.bluetooth)) return await TransportBLE.connect();
    else if (S.transport==='demo') return await TransportDemo.connect();
    else throw new Error('No hay transporte compatible. Prueba Web Serial (Chrome desktop) o BLE compatible.');
  },
  async disconnect(){ await TransportSerial.disconnect(); await TransportBLE.disconnect(); await TransportDemo.disconnect(); S.conn=null; S.writer=null; S.reader=null; $("#connStatus").textContent='Desconectado'; $("#btnConnect").classList.remove('hidden'); $("#btnDisconnect").classList.add('hidden'); },
  async write(line){ const txt=line.endsWith('\r')? line : line+'\r'; log('> '+line); if(S.writer){ await S.writer(txt); } else throw new Error('No hay writer activo'); },
  async request(line, timeout=1600){ await Transport.write(line); return await Transport.readUntil('>', timeout); },
  async readUntil(term='>', timeout=1600){ const started=Date.now(); while(Date.now()-started<timeout){ const chunk=await Transport.readChunk(timeout-(Date.now()-started)); if(chunk){ S.buffer+=chunk; const idx=S.buffer.lastIndexOf(term); if(idx>=0){ const out=S.buffer.slice(0,idx); S.buffer=S.buffer.slice(idx+term.length); return clean(out); } } else { await sleep(20); } } return clean(S.buffer); },
  async readChunk(){ return null; }
};
const TransportSerial = {
  async connect(){ if(!('serial' in navigator)) throw new Error('Web Serial no disponible');
    S.serialPort = await navigator.serial.requestPort();
    await S.serialPort.open({ baudRate: 38400 });
    const dec = new TextDecoderStream(); S.serialPort.readable.pipeTo(dec.writable); const reader = dec.readable.getReader();
    S.reader = async ()=>{ const {value,done}=await reader.read(); if(done) return null; return value||null; };
    const enc = new TextEncoderStream(); enc.readable.pipeTo(S.serialPort.writable); const writer = enc.writable.getWriter(); S.writer = async (txt)=>{ writer.write(txt); };
    S.conn='serial'; $("#connStatus").textContent='Conectado (Serial)'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[Serial] Conectado.'); return true;
  },
  async disconnect(){ try{ if(S.serialPort){ await S.serialPort.close(); S.serialPort=null; } }catch(e){} }
};
const BLE_UUID={ svc:'6e400001-b5a3-f393-e0a9-e50e24dcca9e', tx:'6e400002-b5a3-f393-e0a9-e50e24dcca9e', rx:'6e400003-b5a3-f393-e0a9-e50e24dcca9e' };
const TransportBLE = {
  async connect(){ if(!navigator.bluetooth) throw new Error('Web Bluetooth no disponible');
    S.bleDev = await navigator.bluetooth.requestDevice({ filters:[{services:[BLE_UUID.svc]}], optionalServices:[BLE_UUID.svc] });
    const server = await S.bleDev.gatt.connect(); const svc = await server.getPrimaryService(BLE_UUID.svc);
    S.bleTx = await svc.getCharacteristic(BLE_UUID.tx); S.bleRx = await svc.getCharacteristic(BLE_UUID.rx);
    await S.bleRx.startNotifications(); let queue=''; S.bleRx.addEventListener('characteristicvaluechanged', e=>{ const v=new TextDecoder().decode(e.target.value); queue+=v; });
    S.reader = async ()=>{ await sleep(60); if(queue){ const z=queue; queue=''; return z; } return ''; };
    S.writer = async (txt)=>{ const data=new TextEncoder().encode(txt); for(let i=0;i<data.length;i+=20){ await S.bleTx.writeValueWithoutResponse(data.slice(i,i+20)); await sleep(8);} };
    S.conn='ble'; $("#connStatus").textContent='Conectado (BLE)'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[BLE] Conectado.'); return true;
  },
  async disconnect(){ try{ if(S.bleDev && S.bleDev.gatt.connected) S.bleDev.gatt.disconnect(); S.bleDev=null; S.bleTx=null; S.bleRx=null; }catch(e){} }
};
const TransportDemo = { async connect(){ S.reader=async()=>{ await sleep(50); return ''; }; S.writer=async()=>{}; S.conn='demo'; $("#connStatus").textContent='Demo'; $("#btnConnect").classList.add('hidden'); $("#btnDisconnect").classList.remove('hidden'); log('[Demo] Modo demostraci√≥n activo.'); return true; }, async disconnect(){} };

function clean(s){ return s.replace(/\r/g,'').replace(/ELM327 v[^\n]+\n?/i,'').replace(/^>/gm,'').replace(/\n\n+/g,'\n').trim(); }

/* ====== OBD helpers ====== */
async function initECU(){
  await Transport.request('ATZ',1800); await sleep(300);
  await Transport.request('ATE0'); await Transport.request('ATL0'); await Transport.request('ATS0'); await Transport.request('ATH0'); await Transport.request('ATSP0');
  const pids = await Transport.request('0100'); $("#kPID").textContent = pids.split('\n').pop() || pids.slice(-64);
  const vin = await mode09_02(); $("#kVIN").textContent = vin||'‚Äî';
  try{ const prot=await Transport.request('ATDP'); $("#kProto").textContent = prot.split('\n').pop() || prot; }catch(e){}
  try{ const v=await pid0142(); if(v!=null){ $("#kVBAT").textContent = v.toFixed(2)+' V'; $("#dVBAT").textContent = v.toFixed(2)+' V'; } }catch(e){}
}
async function sendReq(cmd){ return await Transport.request(cmd); }
const hexToBytes = h => { h=h.replace(/\s/g,''); const a=[]; for(let i=0;i<h.length;i+=2)a.push(parseInt(h.substr(i,2),16)); return a; };
const parseLines = resp => resp.split('\n').map(x=>x.trim()).filter(Boolean);
const lastDataLine = (resp,prefix)=>{ const lines=parseLines(resp).filter(x=>x && (!prefix || x.startsWith(prefix))); return lines.length? lines[lines.length-1]:''; };
const parseOBD = (prefix, resp)=>{ const l=lastDataLine(resp,prefix).replace(/^([0-9A-F]{2}\s*){2}/i,'').trim(); return hexToBytes(l.replace(/\s/g,'')); };
/* PIDs */
async function pid010C(){ const r=await sendReq('010C'); const b=parseOBD('41 0C',r); if(b.length>=2){ return ((b[0]<<8)|b[1])/4; } return null; }
async function pid010D(){ const r=await sendReq('010D'); const b=parseOBD('41 0D',r); if(b.length>=1) return b[0]; return null; }
async function pid0105(){ const r=await sendReq('0105'); const b=parseOBD('41 05',r); if(b.length>=1) return b[0]-40; return null; }
async function pid0111(){ const r=await sendReq('0111'); const b=parseOBD('41 11',r); if(b.length>=1) return (b[0]*100/255); return null; }
/* 0142 ‚Äî Control Module Voltage -> (A*256 + B)/1000 V */
async function pid0142(){ const r=await sendReq('0142'); const b=parseOBD('41 42',r); if(b.length>=2){ return ((b[0]<<8)|b[1])/1000; } return null; }

async function readIM(){ const r=await sendReq('0101'); $("#imOut").textContent=r||'‚Äî'; }
async function mode09_02(){ const r=await sendReq('0902'); $("#infoOut").textContent=r; const lines=parseLines(r).filter(x=>x.match(/^49 02/i)); let bytes=[]; lines.forEach(line=>{ const parts=line.replace(/^49 02 [0-9A-F]{2}\s*/i,'').trim(); bytes=bytes.concat(hexToBytes(parts)); }); const ascii=bytes.filter(b=>b>=0x20 && b<=0x7E); const vin=new TextDecoder().decode(new Uint8Array(ascii)).trim(); return vin||''; }

/* DTC parse */
function dtcFromBytes(arr){ const out=[]; for(let i=0;i+1<arr.length;i+=2){ const A=arr[i],B=arr[i+1]; const sys=['P','C','B','U'][(A & 0xC0)>>6]; const d1=(A & 0x30)>>4; const d2=(A & 0x0F); const code=sys + d1 + d2 + ((B>>4)&0x0F) + (B&0x0F); if(code!=='P0000') out.push(code); } return out; }
const DTC_DESC={ "P0300":"Random/Multiple Cylinder Misfire Detected","P0301":"Cylinder 1 Misfire Detected","P0171":"System Too Lean (Bank 1)","P0172":"System Too Rich (Bank 1)","P0118":"ECT Sensor High","P0117":"ECT Sensor Low","P0101":"MAF Range/Performance","P0420":"Catalyst Efficiency Below Threshold (B1)","P0430":"Catalyst Efficiency Below Threshold (B2)","P0440":"EVAP System","P0130":"O2 Sensor B1S1 Circuit" };
function renderDTC(list, where){ const wrap=$(where); if(!list.length){ wrap.innerHTML=`<div class="notice">Sin c√≥digos.</div>`; return; } const items=list.map(c=>{ const d=DTC_DESC[c]||'Descripci√≥n gen√©rica no encontrada.'; return `<tr><td class="mono">${c}</td><td>${d}</td></tr>`; }).join(''); wrap.innerHTML=`<table class="table"><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th></tr></thead><tbody>${items}</tbody></table>`; }

/* ====== UI handlers ====== */
$("#btnConnect").onclick = async ()=>{ try{ await Transport.connect($("#transport")?.value||'auto'); }catch(e){ alert(e.message); log('[ERROR] '+e.message);} };
$("#btnDisconnect").onclick = async ()=>{ await Transport.disconnect(); };
$("#btnInit").onclick = async ()=>{ if(!S.conn){ alert('Con√©ctate primero'); return; } try{ await initECU(); log('[OK] ECU inicializada.'); }catch(e){ log('[ERROR] init: '+e.message);} };
$("#btnClearLog").onclick = ()=> $("#console").value='';
$("#btnReadVIN").onclick = async ()=>{ const v=await mode09_02(); $("#infoOut").textContent='VIN: '+(v||'‚Äî'); $("#kVIN").textContent=v||'‚Äî'; };
$("#btnReadVBAT").onclick = async ()=>{ const v=await pid0142(); $("#kVBAT").textContent = v!=null? (v.toFixed(2)+' V') : '‚Äî'; $("#dVBAT").textContent = $("#kVBAT").textContent; };

/* Acciones AT/REQ */
$$('button[data-at]').forEach(b=> b.onclick = async ()=> { if(!S.conn) return alert('Con√©ctate primero'); const cmd=b.getAttribute('data-at'); const r=await Transport.request(cmd); log(r); });
$$('button[data-req]').forEach(b=> b.onclick = async ()=>{ if(!S.conn) return alert('Con√©ctate primero'); const cmd=b.getAttribute('data-req'); const r=await Transport.request(cmd); log(r); });

/* Lectura r√°pida 5s */
$("#btnQuickPoll").onclick = async ()=>{
  if(!S.conn) return alert('Con√©ctate primero');
  clearInterval(S.quickTimer);
  S.quickTimer = setInterval(async ()=>{
    try{
      const [rpm,spd,ect,thr,vbat]=await Promise.all([pid010C(),pid010D(),pid0105(),pid0111(),pid0142()]);
      updateMini(rpm,spd,ect,thr,vbat);
    }catch(e){}
  }, 800);
  setTimeout(()=> clearInterval(S.quickTimer), 5000);
};
$("#btnStopPoll").onclick = ()=> clearInterval(S.quickTimer);

/* Live streaming */
function updateMini(rpm,spd,ect,thr,vbat){
  const d=(id,val)=>{ const el=$(id); if(el) el.textContent=val; };
  if(rpm!=null) d("#dRPM", `${rpm.toFixed(0)} rpm`);
  if(spd!=null) d("#dSPD", `${spd} km/h`);
  if(ect!=null) d("#dECT", `${ect} ¬∞C`);
  if(thr!=null) d("#dTHR", `${thr.toFixed(0)} %`);
  if(vbat!=null){ d("#dVBAT", `${vbat.toFixed(2)} V`); d("#kVBAT", `${vbat.toFixed(2)} V`); }
  const t=(Date.now()-S.t0)/1000;
  S.series.t.push(t);
  S.series.rpm.push(rpm??null); S.series.spd.push(spd??null); S.series.ect.push(ect??null); S.series.thr.push(thr??null);
  Object.keys(S.series).forEach(k=>{ if(Array.isArray(S.series[k]) && S.series[k].length>S.maxPoints){ S.series[k].shift(); } });
  refreshCharts();
}
$("#btnStartLive").onclick = async ()=>{
  if(!S.conn) return alert('Con√©ctate primero');
  const rate = +$("#liveRate").value || 500;
  clearInterval(S.liveTimer);
  if(!S.charts.rpm) initCharts(); // crear charts una vez
  S.liveTimer = setInterval(async ()=>{
    try{
      const [rpm,spd,ect,thr]=await Promise.all([pid010C(),pid010D(),pid0105(),pid0111()]);
      $("#liveRPM").textContent = rpm!=null? `${rpm.toFixed(0)} rpm`:'‚Äî';
      $("#liveSPD").textContent = spd!=null? `${spd} km/h`:'‚Äî';
      $("#liveECT").textContent = ect!=null? `${ect} ¬∞C`:'‚Äî';
      $("#liveTHR").textContent = thr!=null? `${thr.toFixed(0)} %`:'‚Äî';
      updateMini(rpm,spd,ect,thr,null);
    }catch(e){}
  }, rate);
};
$("#btnStopLive").onclick = ()=> clearInterval(S.liveTimer);

/* DTC */
$("#btnScanDTC").onclick = async ()=>{
  if(!S.conn) return alert('Con√©ctate primero');
  const r = await Transport.request('03', 3000); log(r);
  const lines = parseLines(r).filter(x=>x.match(/^43 /i));
  let bytes=[]; lines.forEach(line=>{ const body=line.replace(/^43\s*/i,'').trim(); bytes=bytes.concat(hexToBytes(body.replace(/\s/g,''))); });
  const list = dtcFromBytes(bytes); S.dtcLast = list; renderDTC(list, "#dtcList");
  $("#dDTC").textContent = list.length? list.join(', '): 'Ninguno';
};
$("#btnClearDTC").onclick = async ()=>{
  if(!S.conn) return alert('Con√©ctate primero');
  if(!confirm('¬øSeguro que deseas borrar DTC (04)?')) return;
  const r=await Transport.request('04',3000); log(r); alert('Solicitud de borrado enviada.');
  $("#dtcList").innerHTML=''; $("#dDTC").textContent='‚Äî'; S.dtcLast=[];
};
$("#btnReadPending").onclick = async ()=>{ if(!S.conn) return alert('Con√©ctate primero'); const r=await Transport.request('07',3000); alert('Pendientes:\n'+r); };
$("#btnReadPermanent").onclick = async ()=>{ if(!S.conn) return alert('Con√©ctate primero'); const r=await Transport.request('0A',3000); alert('Permanentes:\n'+r); };

/* Freeze / IM / Info */
$("#btnFF").onclick = async ()=>{ if(!S.conn) return alert('Con√©ctate primero'); const r=await Transport.request('02',3000); $("#ffOut").textContent=r; };
$("#btnIM").onclick = readIM;
$("#btnVIN").onclick = async ()=>{ const v=await mode09_02(); $("#infoOut").textContent='VIN: '+(v||'‚Äî'); $("#kVIN").textContent=v||'‚Äî'; };
$("#btnCALID").onclick = async ()=>{ const r=await Transport.request('0904'); const r2=await Transport.request('0906'); $("#infoOut").textContent=r+'\n'+r2; };
$("#btnECUName").onclick = async ()=>{ const r=await Transport.request('090A'); $("#infoOut").textContent=r; };

/* Charts */
function makeCfg(label){ return {
  type:'line', data:{ labels:S.series.t, datasets:[{ label, data:[], borderWidth:2, pointRadius:0, tension:.25 }]},
  options:{ animation:false, responsive:true, maintainAspectRatio:false,
    scales:{ x:{ ticks:{color:'#9aa'}, grid:{color:'#1b2530'} }, y:{ ticks:{color:'#9aa'}, grid:{color:'#1b2530'} } },
    plugins:{ legend:{labels:{color:'#e7eaf3'}}}
  }
};}
function initCharts(){
  S.charts.rpm = new Chart(document.getElementById('chartRPM').getContext('2d'), makeCfg('RPM'));
  S.charts.spd = new Chart(document.getElementById('chartSPD').getContext('2d'), makeCfg('Velocidad'));
  S.charts.ect = new Chart(document.getElementById('chartECT').getContext('2d'), makeCfg('ECT ¬∞C'));
  S.charts.thr = new Chart(document.getElementById('chartTHR').getContext('2d'), makeCfg('Throttle %'));
}
function refreshCharts(){
  if(!S.charts.rpm) return;
  S.charts.rpm.data.labels = S.series.t;   S.charts.rpm.data.datasets[0].data = S.series.rpm;   S.charts.rpm.update('none');
  S.charts.spd.data.labels = S.series.t;   S.charts.spd.data.datasets[0].data = S.series.spd;   S.charts.spd.update('none');
  S.charts.ect.data.labels = S.series.t;   S.charts.ect.data.datasets[0].data = S.series.ect;   S.charts.ect.update('none');
  S.charts.thr.data.labels = S.series.t;   S.charts.thr.data.datasets[0].data = S.series.thr;   S.charts.thr.update('none');
}
$("#btnClearSeries").onclick = ()=>{ S.series = { t:[], rpm:[], spd:[], ect:[], thr:[] }; S.t0=Date.now(); refreshCharts(); };

/* PDF */
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const margin=36, line=18; let y=margin;
  const brand = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
  if(brand.logo){ try{ doc.addImage(brand.logo,'PNG', margin, y, 90, 90); }catch(e){} }
  doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text('Doctor Car Pro ‚Äî Reporte de Diagn√≥stico', margin+100, y+20);
  doc.setFontSize(10); doc.setFont('helvetica','normal'); const now=new Date(); doc.text(now.toLocaleString(), margin+100, y+40); y += 100;
  const proto = $("#kProto").textContent || '‚Äî';
  const vin   = $("#kVIN").textContent || '‚Äî';
  const vbat  = $("#dVBAT").textContent || '‚Äî';
  doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Datos del veh√≠culo', margin, y); y+=line;
  doc.setFont('helvetica','normal'); doc.text(`VIN: ${vin}`, margin, y); y+=line;
  doc.text(`Protocolo: ${proto}`, margin, y); y+=line;
  doc.text(`Voltaje m√≥dulo: ${vbat}`, margin, y); y+=line;
  const rpm=$("#dRPM")?.textContent||'‚Äî', spd=$("#dSPD")?.textContent||'‚Äî', ect=$("#dECT")?.textContent||'‚Äî', thr=$("#dTHR")?.textContent||'‚Äî';
  y+=line/2; doc.setFont('helvetica','bold'); doc.text('Lecturas actuales', margin, y); y+=line;
  doc.setFont('helvetica','normal'); doc.text(`RPM: ${rpm}`, margin, y); y+=line;
  doc.text(`Velocidad: ${spd}`, margin, y); y+=line;
  doc.text(`ECT: ${ect}`, margin, y); y+=line;
  doc.text(`Throttle: ${thr}`, margin, y); y+=line;
  y+=line/2; doc.setFont('helvetica','bold'); doc.text('C√≥digos DTC', margin, y); y+=line;
  doc.setFont('helvetica','normal');
  if(S.dtcLast.length){ S.dtcLast.forEach(c=>{ const d = (window.DTC_DESC && DTC_DESC[c])? DTC_DESC[c] : ''; doc.text(`‚Ä¢ ${c} ${d?('- '+d):''}`, margin, y); y+=line; }); }
  else { doc.text('Sin c√≥digos activos.', margin, y); y+=line; }
  const cliente = $("#pdfCliente")?.value || ''; const notas = $("#pdfNotas")?.value || '';
  y+=line/2; doc.setFont('helvetica','bold'); doc.text('Cliente / Notas', margin, y); y+=line;
  doc.setFont('helvetica','normal'); if(cliente) { doc.text(`Cliente: ${cliente}`, margin, y); y+=line; }
  if(notas){ const split = doc.splitTextToSize(notas, 520); doc.text(split, margin, y); y += split.length*line; } else { doc.text('‚Äî', margin, y); y+=line; }
  if(S.charts.rpm){
    const w=240,h=140;
    try{ doc.addImage(S.charts.rpm.toBase64Image(),'PNG', margin, y, w, h); }catch(e){}
    try{ doc.addImage(S.charts.spd.toBase64Image(),'PNG', margin+w+20, y, w, h); }catch(e){}
    y+=h+10;
    try{ doc.addImage(S.charts.ect.toBase64Image(),'PNG', margin, y, w, h); }catch(e){}
    try{ doc.addImage(S.charts.thr.toBase64Image(),'PNG', margin+w+20, y, w, h); }catch(e){}
    y+=h+10;
  }
  doc.setFont('helvetica','italic'); doc.setFontSize(9);
  doc.text('Generado por Doctor Car Pro ‚Äî OBD-II (uso informativo; no sustituye diagn√≥stico del fabricante).', margin, 812);
  doc.save(`DoctorCarPro_${(vin||'vehiculo').replace(/\s/g,'')}_${new Date().toISOString().slice(0,10)}.pdf`);
}
$("#btnGenPDF").onclick = generatePDF;

/* Conectar / desconectar desde header */
$("#btnConnect").addEventListener('click', async ()=>{ try{ await Transport.connect($("#transport")?.value||'auto'); }catch(e){ alert(e.message); log('[ERROR] '+e.message);} });
$("#btnDisconnect").addEventListener('click', async ()=>{ await Transport.disconnect(); });

/* iOS nota */
(function boot(){ const ua=navigator.userAgent; const isIOS=/iPad|iPhone|iPod/.test(ua) && !window.MSStream; if (isIOS && $("#compatNote")) $("#compatNote").innerHTML += '<br>iOS: Web Serial no disponible; BLE limitado.'; })();
</script>
</body>
</html>
