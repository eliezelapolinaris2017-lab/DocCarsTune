<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Doctor Car Pro ‚Äî Suite Compacta OBD-II</title>
<meta name="description" content="Doctor Car Pro ‚Äî OBD-II (ELM327 USB/BLE). DTC, VIN, Freeze Frame, Live Data. Men√∫ editable, login, temas, logos de marcas, PDF/CSV.">
<style>
:root{
  --bg:#0b0e13; --fg:#e8edf6; --muted:#a5b0c2; --card:#131823; --line:#2a3650;
  --acc:#48c6ef; --ok:#34d399; --bad:#ef4444; --warn:#f59e0b;
  --side:#0f1320; --sideW:260px; --mono:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter}
a{color:var(--acc);text-decoration:none}
#app{display:flex;min-height:100vh}
aside{width:var(--sideW);background:var(--side);border-right:1px solid var(--line);padding:12px;position:sticky;top:0;height:100vh}
main{flex:1;min-width:0}
h1{font-size:22px;margin:8px 0} h2{font-size:18px;margin:18px 0 8px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select,button,textarea{background:#0f1320;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:9px 11px}
button{cursor:pointer} .primary{border-color:#1e3a5f;background:#0e2036} .primary:hover{outline:1px solid var(--acc)}
.small{color:var(--muted)} .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
pre{background:#0b0f1a;border:1px solid #16223a;border-radius:10px;padding:10px;overflow:auto;max-height:230px}
.table{width:100%;border-collapse:collapse} .table th,.table td{border-bottom:1px solid var(--line);padding:7px 6px;text-align:left}
.kbd{font-family:var(--mono);font-size:13px}
.logo{width:40px;height:40px;border-radius:8px;object-fit:contain;background:#0f1320;border:1px solid #1e2e52}
.brandbar{display:flex;gap:10px;align-items:center}
.menu h3{margin:8px 8px 6px;font-size:13px;color:#b9c2d9}
.menu button,.menu a{display:flex;gap:8px;align-items:center;width:100%;text-align:left;padding:9px 10px;border-radius:10px;border:1px solid transparent;background:transparent;color:#d9e3ff}
.menu a.active{background:#0f1626;border-color:#243a6a}
hr{border:none;border-top:1px solid var(--line);margin:10px 0}
.tag{display:inline-block;border:1px solid var(--line);padding:2px 7px;border-radius:999px;color:#cfd6ea;font-size:11px;background:#0f1320}
.grid{display:grid;gap:12px}
@media(min-width:1000px){.cols-2{grid-template-columns:1fr 1fr}}
canvas{width:100%;height:200px;background:#0b0f1a;border:1px solid #16223a;border-radius:10px}
footer{padding:16px 14px;color:var(--muted);text-align:center}
.hide{display:none!important}
.compact aside{--sideW:84px}
.compact .menu .label{display:none}
.compact .brandbar span{display:none}
.compact .brandbar{justify-content:center}
@media print{aside,#topbar,.no-print{display:none!important}.card{border:none} body{background:#fff;color:#000}}
</style>
</head>
<body>
<div id="loginView" class="card" style="max-width:460px;margin:8vh auto">
  <div class="brandbar" style="justify-content:center;margin-bottom:8px">
    <img id="loginLogo" class="logo" alt="Logo"/>
    <span><h1 style="margin:0">Doctor Car Pro</h1><div class="small">Acceso local (no requiere servidor)</div></span>
  </div>
  <div class="row"><input id="userName" placeholder="Usuario"/><input id="userPass" type="password" placeholder="Contrase√±a"/></div>
  <div class="row"><button id="btnLogin" class="primary">Entrar</button><button id="btnCreate">Crear/Reset usuario</button></div>
  <div class="small">Consejo: guarda un usuario sencillo para uso en taller. Las credenciales se almacenan en <code>localStorage</code> (solo en este equipo).</div>
</div>

<div id="app" class="hide">
  <aside>
    <div class="brandbar">
      <img id="brandLogo" class="logo" alt="Logo"/>
      <span>
        <b>Doctor Car Pro</b><br/>
        <span id="userTag" class="small"></span>
      </span>
    </div>
    <hr/>
    <div class="menu" id="menu">
      <!-- Se construye din√°micamente seg√∫n configuraci√≥n -->
    </div>
    <hr/>
    <div class="small">Dise√±o:</div>
    <div class="row">
      <button id="btnWide" class="tag">Ancho</button>
      <button id="btnCompact" class="tag">Compacto</button>
    </div>
    <hr/>
    <button id="btnLogout">Cerrar sesi√≥n</button>
  </aside>

  <main>
    <div id="topbar" class="card row" style="justify-content:space-between;align-items:center">
      <div class="row">
        <select id="brandPreset" title="Perfil de marca">
          <option value="generic">Gen√©rico</option>
          <option value="ford">Ford (CAN 11/500)</option>
          <option value="gm">GM (ECU 7E0/7E8)</option>
          <option value="fca">Chrysler/Jeep/Dodge</option>
          <option value="toyota">Toyota/Lexus</option>
          <option value="honda">Honda/Acura</option>
          <option value="nissan">Nissan/Infiniti</option>
          <option value="mazda">Mazda</option>
          <option value="subaru">Subaru</option>
        </select>
        <input type="file" id="logoInput" accept="image/*" title="Subir logo"/>
        <button id="btnLogoClear">Quitar logo</button>
        <span class="tag">PDF/CSV en p√°ginas</span>
      </div>
      <div class="row">
        <select id="themePreset" title="Tema">
          <option value="doctor">Doctor (por defecto)</option>
          <option value="darkMint">Dark Mint</option>
          <option value="amber">√Åmbar</option>
          <option value="mono">Monocromo</option>
        </select>
        <input id="colorAcc" type="color" title="Color acento"/>
      </div>
    </div>

    <!-- P√ÅGINAS -->
    <section id="pg_home" class="card">
      <h1>Inicio</h1>
      <p class="small">Bienvenido, <b id="helloUser"></b>. Usa el men√∫ para navegar. Estado de conexi√≥n: <span id="connState" class="tag">Desconectado</span></p>
      <div class="grid cols-2">
        <div class="card">
          <h2>Pasos r√°pidos</h2>
          <ol>
            <li>Conecta por <b>USB</b> o <b>BLE</b> en <a href="#" data-nav="pg_connect">Conexi√≥n</a>.</li>
            <li>Inicializa ELM con tu protocolo.</li>
            <li>Lee <b>VIN</b> y <b>PIDs</b> en <a href="#" data-nav="pg_id">Identificaci√≥n</a>.</li>
            <li>Consulta <b>DTC</b> en <a href="#" data-nav="pg_dtc">DTC</a> y <b>Freeze</b> en <a href="#" data-nav="pg_freeze">Freeze Frame</a>.</li>
            <li>Abre <a href="#" data-nav="pg_live">Live Data</a> para gr√°fica.</li>
          </ol>
        </div>
        <div class="card">
          <h2>Perfil activo</h2>
          <p id="profDesc" class="small">Gen√©rico OBD-II (funcional 7DF ‚Üí 7E8).</p>
          <div class="row small"><span class="tag">ATH</span><span id="tagATH" class="tag">1</span><span class="tag">ST</span><span id="tagST" class="tag">0F</span><span class="tag">SP</span><span id="tagSP" class="tag">6</span></div>
        </div>
      </div>
    </section>

    <section id="pg_id" class="card hide">
      <h1>Identificaci√≥n</h1>
      <div class="row">
        <button id="btnVIN" class="primary">Leer VIN (09 02)</button>
        <button id="btnPIDs" class="primary">PIDs soportados (01 00)</button>
      </div>
      <div id="idOut" class="small" style="margin-top:8px"></div>
    </section>

    <section id="pg_dtc" class="card hide">
      <h1>DTC</h1>
      <div class="row">
        <button id="btnMil" class="primary">MIL & Monitores (01 01)</button>
        <button id="btn03" class="primary">Almacenados (03)</button>
        <button id="btn07" class="primary">Pendientes (07)</button>
        <button id="btn0A" class="primary">Permanentes (0A)</button>
        <button id="btn04" class="bad">Borrar DTC (04)</button>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div><h3>Salida cruda</h3><pre id="raw"></pre></div>
        <div><h3>Decodificaci√≥n</h3><div id="dec"></div></div>
      </div>
      <div class="row no-print" style="margin-top:10px">
        <button id="btnCsv" class="tag">Exportar CSV</button>
        <button id="btnPrint" class="tag">Imprimir/PDF</button>
      </div>
    </section>

    <section id="pg_freeze" class="card hide">
      <h1>Freeze Frame (Modo 02)</h1>
      <div class="row">
        <select id="ffPid">
          <option value="00">02 00 ‚Äî PIDs FF soportados</option>
          <option value="01">02 01 ‚Äî MIL & DTC count</option>
          <option value="03">02 03 ‚Äî Fuel system</option>
          <option value="04">02 04 ‚Äî Carga</option>
          <option value="05" selected>02 05 ‚Äî ECT</option>
          <option value="0B">02 0B ‚Äî MAP</option>
          <option value="0C">02 0C ‚Äî RPM</option>
          <option value="0D">02 0D ‚Äî Velocidad</option>
          <option value="10">02 10 ‚Äî MAF</option>
          <option value="11">02 11 ‚Äî TPS</option>
          <option value="14">02 14 ‚Äî O2 S1 (V/Trim)</option>
          <option value="06">02 06 ‚Äî STFT</option>
          <option value="07">02 07 ‚Äî LTFT</option>
        </select>
        <button id="btnFF" class="primary">Leer FF (PID)</button>
        <button id="btnFFScan">Barrido FF</button>
      </div>
      <div id="ffOut" class="small" style="margin-top:8px"></div>
    </section>

    <section id="pg_live" class="card hide">
      <h1>Live Data</h1>
      <div class="row">
        <button id="liveStart" class="primary">Iniciar</button>
        <button id="liveStop">Detener</button>
        <select id="liveSel">
          <option value="010C">01 0C ‚Äî RPM</option>
          <option value="010D">01 0D ‚Äî Velocidad</option>
          <option value="0105" selected>01 05 ‚Äî ECT</option>
          <option value="0110">01 10 ‚Äî MAF</option>
          <option value="0111">01 11 ‚Äî TPS</option>
        </select>
        <input id="liveInt" type="number" min="200" value="800" style="width:110px" title="Intervalo ms"/>
      </div>
      <canvas id="chart"></canvas>
      <div id="liveOut" class="small" style="margin-top:8px"></div>
    </section>

    <section id="pg_connect" class="card hide">
      <h1>Conexi√≥n a ELM327</h1>
      <div class="grid cols-2">
        <div class="card">
          <h2>Transporte</h2>
          <div class="row">
            <button id="btnUsb" class="primary">USB (Web Serial)</button>
            <button id="btnBle" class="primary">Bluetooth (BLE)</button>
            <button id="btnDisc">Desconectar</button>
            <button id="btnSim">Simulador: Off</button>
          </div>
          <p class="small">BLE ‚â† Bluetooth cl√°sico (SPP). Usa dongles BLE.</p>
        </div>
        <div class="card">
          <h2>ELM & Protocolo</h2>
          <div class="row">
            <label>SP</label>
            <select id="proto">
              <option value="0">0 Auto</option><option value="1">1 J1850 PWM</option><option value="2">2 J1850 VPW</option>
              <option value="4">4 ISO14230 (5b)</option><option value="5">5 ISO14230 (fast)</option>
              <option value="6" selected>6 CAN 11/500</option><option value="7">7 CAN 29/500</option><option value="8">8 CAN 11/250</option><option value="9">9 CAN 29/250</option>
            </select>
            <label>ATH</label>
            <select id="ath"><option value="0">0</option><option value="1" selected>1</option></select>
            <label>ST</label>
            <select id="timeout"><option value="0A">0A</option><option value="0F" selected>0F</option><option value="14">14</option><option value="28">28</option></select>
            <button id="btnInit" class="primary">Inicializar ELM</button>
          </div>
          <div class="small">Secuencia: ATZ ¬∑ ATE0 ¬∑ ATL0 ¬∑ ATS0 ¬∑ ATHx ¬∑ ATST xx ¬∑ ATSP x</div>
        </div>
      </div>
    </section>

    <section id="pg_report" class="card hide">
      <h1>Reporte & Exportaci√≥n</h1>
      <div id="printArea" class="card">
        <div class="row" style="align-items:center">
          <img id="reportLogo" class="logo" alt="Logo"/>
          <div>
            <h2 style="margin:0">Reporte Doctor Car Pro</h2>
            <div class="small">Fecha: <span id="repDate"></span> ¬∑ VIN: <span id="repVIN">‚Äî</span></div>
          </div>
        </div>
        <div id="repBody" class="small"></div>
      </div>
      <div class="row no-print" style="margin-top:10px">
        <button id="btnAddNote">A√±adir nota</button>
        <button id="btnClearReport">Limpiar</button>
        <button id="btnPrint2" class="primary">Imprimir / PDF</button>
        <button id="btnCsv2">Exportar CSV</button>
      </div>
    </section>

    <section id="pg_settings" class="card hide">
      <h1>Configuraci√≥n</h1>
      <div class="grid cols-2">
        <div class="card">
          <h2>Men√∫ editable</h2>
          <div id="menuEdit"></div>
          <div class="small">Mueve ‚Üë/‚Üì para ordenar. Oculta lo que no uses. Se guarda autom√°ticamente.</div>
        </div>
        <div class="card">
          <h2>Tema y colores</h2>
          <div class="row">
            <label>Preset</label><select id="themePreset2">
              <option value="doctor">Doctor</option><option value="darkMint">Dark Mint</option><option value="amber">√Åmbar</option><option value="mono">Monocromo</option>
            </select>
            <label>Acento</label><input id="colorAcc2" type="color"/>
            <label>Compacto</label><input id="toggleCompact" type="checkbox"/>
          </div>
        </div>
        <div class="card">
          <h2>Credenciales</h2>
          <div class="row"><input id="setUser" placeholder="Usuario"/><input id="setPass" placeholder="Contrase√±a"/></div>
          <button id="btnSaveUser">Guardar usuario</button>
          <div class="small">Solo en este equipo (localStorage).</div>
        </div>
        <div class="card">
          <h2>Marca & Logo</h2>
          <div class="row">
            <select id="brandPreset2">
              <option value="generic">Gen√©rico</option><option value="ford">Ford</option><option value="gm">GM</option><option value="fca">Chrysler/Jeep/Dodge</option>
              <option value="toyota">Toyota/Lexus</option><option value="honda">Honda/Acura</option><option value="nissan">Nissan/Infiniti</option><option value="mazda">Mazda</option><option value="subaru">Subaru</option>
            </select>
            <input type="file" id="logoInput2" accept="image/*"/>
            <button id="btnLogoClear2">Quitar logo</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="no-print">Doctor Car Pro ‚Äî OBD-II USB/BLE ¬∑ ¬© 2025</footer>
  </main>
</div>

<script>
/* ================== Utilidades UI/Estado ================== */
const S = {
  menuItems: [
    {id:"pg_home", icon:"üè†", label:"Inicio", show:true},
    {id:"pg_id", icon:"üÜî", label:"Identificaci√≥n", show:true},
    {id:"pg_dtc", icon:"üõ†Ô∏è", label:"DTC", show:true},
    {id:"pg_freeze", icon:"‚ùÑÔ∏è", label:"Freeze", show:true},
    {id:"pg_live", icon:"üìà", label:"Live", show:true},
    {id:"pg_connect", icon:"üîå", label:"Conexi√≥n", show:true},
    {id:"pg_report", icon:"üìù", label:"Reporte", show:true},
    {id:"pg_settings", icon:"‚öôÔ∏è", label:"Configuraci√≥n", show:true},
  ],
  theme:"doctor", acc:"#48c6ef", compact:false,
  user:{u:"admin", p:"admin"},
  brand:"generic",
};
const store = (k,v)=>localStorage.setItem("dcp_"+k, JSON.stringify(v));
const load = (k,d)=>{ try{const v=JSON.parse(localStorage.getItem("dcp_"+k)); return v??d;}catch(e){return d;} };

function applyTheme(){
  const r = document.documentElement.style;
  const t = load("theme", S.theme), acc = load("acc", S.acc);
  const map = {
    doctor:{bg:"#0b0e13",fg:"#e8edf6",muted:"#a5b0c2",card:"#131823",line:"#2a3650",acc:acc},
    darkMint:{bg:"#0f1115",fg:"#e6f3ef",muted:"#a9c2ba",card:"#142027",line:"#23414b",acc:acc||"#6ee7b7"},
    amber:{bg:"#13100b",fg:"#f5efe6",muted:"#cab9a0",card:"#1c160c",line:"#3c2d16",acc:acc||"#f59e0b"},
    mono:{bg:"#0d0d0f",fg:"#ececf0",muted:"#b7b7c2",card:"#141418",line:"#2a2a38",acc:acc||"#a0a0a0"},
  }[t]||{};
  r.setProperty('--bg', map.bg); r.setProperty('--fg', map.fg); r.setProperty('--muted', map.muted);
  r.setProperty('--card', map.card); r.setProperty('--line', map.line); r.setProperty('--acc', map.acc||acc);
}
function applyCompact(flag){
  document.getElementById('app').classList.toggle('compact', !!flag);
}

/* ===== Login ===== */
const loginView = document.getElementById('loginView'), app = document.getElementById('app');
function setLoginLogo(){
  const data = localStorage.getItem('dcp_logo'); if(data) document.getElementById('loginLogo').src = data;
}
setLoginLogo();
function doLogin(){
  const U = load("user", S.user);
  const u = document.getElementById('userName').value.trim();
  const p = document.getElementById('userPass').value;
  if(u===U.u && p===U.p){
    loginView.classList.add('hide'); app.classList.remove('hide');
    document.getElementById('helloUser').textContent = u;
    document.getElementById('userTag').textContent = u;
    renderMenu(); renderMenuEditor();
    document.getElementById('repDate').textContent = new Date().toLocaleString();
  }else{
    alert("Usuario o contrase√±a incorrectos.");
  }
}
document.getElementById('btnLogin').addEventListener('click', doLogin);
document.getElementById('btnCreate').addEventListener('click', ()=>{
  const u = prompt("Usuario:", "admin"); const p = prompt("Contrase√±a:", "admin");
  if(u && p){ store("user", {u,p}); alert("Usuario guardado."); }
});

/* ===== Logo ===== */
function loadLogoAll(){
  const data = localStorage.getItem('dcp_logo');
  const brandLogo = document.getElementById('brandLogo');
  const reportLogo = document.getElementById('reportLogo');
  if(data){ brandLogo.src=data; reportLogo.src=data; document.getElementById('loginLogo').src=data; }
}
loadLogoAll();
document.getElementById('logoInput').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ localStorage.setItem('dcp_logo', r.result); loadLogoAll(); };
  r.readAsDataURL(f);
});
document.getElementById('btnLogoClear').addEventListener('click', ()=>{ localStorage.removeItem('dcp_logo'); loadLogoAll(); });
document.getElementById('logoInput2').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ localStorage.setItem('dcp_logo', r.result); loadLogoAll(); };
  r.readAsDataURL(f);
});
document.getElementById('btnLogoClear2').addEventListener('click', ()=>{ localStorage.removeItem('dcp_logo'); loadLogoAll(); });

/* ===== Men√∫ ===== */
function renderMenu(){
  const cfg = load("menu", S.menuItems);
  const box = document.getElementById('menu'); box.innerHTML = "";
  cfg.forEach(it=>{
    if(!it.show) return;
    const a = document.createElement('a');
    a.href="#"; a.dataset.nav = it.id; a.innerHTML = `<span>${it.icon||"‚Ä¢"}</span> <span class="label">${it.label}</span>`;
    a.addEventListener('click', (ev)=>{ ev.preventDefault(); openPage(it.id); [...box.querySelectorAll('a')].forEach(x=>x.classList.remove('active')); a.classList.add('active'); });
    box.appendChild(a);
  });
  // activa primera visible
  const first = box.querySelector('a'); if(first){ first.click(); }
}
function renderMenuEditor(){
  const cfg = load("menu", S.menuItems);
  const root = document.getElementById('menuEdit'); root.innerHTML="";
  cfg.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className="row"; row.style.justifyContent="space-between";
    row.innerHTML = `<span>${it.icon} ${it.label}</span>
      <span>
        <button data-up="${idx}">‚Üë</button>
        <button data-down="${idx}">‚Üì</button>
        <label class="small">Visible <input type="checkbox" data-show="${idx}" ${it.show?"checked":""}></label>
      </span>`;
    root.appendChild(row);
  });
  root.querySelectorAll("[data-up]").forEach(b=> b.onclick = ()=>{ const i=+b.dataset.up; if(i>0){ [cfg[i-1],cfg[i]]=[cfg[i],cfg[i-1]]; store("menu", cfg); renderMenuEditor(); renderMenu(); }});
  root.querySelectorAll("[data-down]").forEach(b=> b.onclick = ()=>{ const i=+b.dataset.down; if(i<cfg.length-1){ [cfg[i+1],cfg[i]]=[cfg[i],cfg[i+1]]; store("menu", cfg); renderMenuEditor(); renderMenu(); }});
  root.querySelectorAll("[data-show]").forEach(c=> c.onchange = ()=>{ const i=+c.dataset.show; cfg[i].show = c.checked; store("menu", cfg); renderMenu(); });
}

/* ===== Router simple ===== */
function openPage(id){
  document.querySelectorAll('main > section.card').forEach(s=> s.classList.add('hide'));
  document.getElementById(id).classList.remove('hide');
}

/* ===== Tema ===== */
function setAcc(val){ document.documentElement.style.setProperty('--acc', val); store("acc", val); }
document.getElementById('themePreset').addEventListener('change', e=>{ store("theme", e.target.value); applyTheme(); document.getElementById('themePreset2').value=e.target.value; });
document.getElementById('themePreset2').addEventListener('change', e=>{ store("theme", e.target.value); applyTheme(); document.getElementById('themePreset').value=e.target.value; });
document.getElementById('colorAcc').addEventListener('input', e=> setAcc(e.target.value));
document.getElementById('colorAcc2').addEventListener('input', e=> setAcc(e.target.value));
document.getElementById('btnWide').onclick = ()=>{ store("compact", false); applyCompact(false); document.getElementById('toggleCompact').checked=false; };
document.getElementById('btnCompact').onclick = ()=>{ store("compact", true); applyCompact(true); document.getElementById('toggleCompact').checked=true; };
document.getElementById('toggleCompact').onchange = (e)=>{ store("compact", e.target.checked); applyCompact(e.target.checked); };
document.getElementById('btnSaveUser').onclick = ()=>{ const u=document.getElementById('setUser').value||"admin"; const p=document.getElementById('setPass').value||"admin"; store("user",{u,p}); alert("Usuario guardado."); };

(function bootTheme(){
  applyTheme(); applyCompact(load("compact", S.compact));
  document.getElementById('themePreset').value = load("theme", S.theme);
  document.getElementById('themePreset2').value = load("theme", S.theme);
  document.getElementById('colorAcc').value = load("acc", S.acc);
  document.getElementById('colorAcc2').value = load("acc", S.acc);
})();

/* ===== Presets de Marca (IDs CAN, descripci√≥n) ===== */
const Profiles = {
  generic:{desc:"Gen√©rico OBD-II (req 7DF ‚Üí resp 7E8).", setup: async()=>{ await send("ATSH7DF"); await send("ATCRA7E8"); }},
  ford:{desc:"Ford (CAN 11/500). Funcional 7DF/7E8.", setup: async()=>{ await send("ATSH7DF"); await send("ATCRA7E8"); }},
  gm:{desc:"GM (CAN 11/500). ECU motor 7E0/7E8.", setup: async()=>{ await send("ATSH7E0"); await send("ATCRA7E8"); }},
  fca:{desc:"FCA (CAN 11/500). 7E0/7E8 (algunos 29-bit).", setup: async()=>{ await send("ATSH7E0"); await send("ATCRA7E8"); }},
  toyota:{desc:"Toyota/Lexus (CAN 11/500). 7DF/7E8.", setup: async()=>{ await send("ATSH7DF"); await send("ATCRA7E8"); }},
  honda:{desc:"Honda/Acura (CAN 11/500). 7DF/7E8.", setup: async()=>{ await send("ATSH7DF"); await send("ATCRA7E8"); }},
  nissan:{desc:"Nissan/Infiniti (CAN 11/500). 7DF/7E8.", setup: async()=>{ await send("ATSH7DF"); await send("ATCRA7E8"); }},
  mazda:{desc:"Mazda (CAN 11/500). 7DF/7E8.", setup: async()=>{ await send("ATSH7DF"); await send("ATCRA7E8"); }},
  subaru:{desc:"Subaru (CAN 11/500). 7DF/7E8.", setup: async()=>{ await send("ATSH7DF"); await send("ATCRA7E8"); }},
};
function applyBrand(preset){
  store("brand", preset);
  document.getElementById('brandPreset').value = preset;
  document.getElementById('brandPreset2').value = preset;
  document.getElementById('profDesc').textContent = Profiles[preset]?.desc || "Gen√©rico OBD-II.";
}
document.getElementById('brandPreset').onchange = (e)=> applyBrand(e.target.value);
document.getElementById('brandPreset2').onchange = (e)=> applyBrand(e.target.value);
applyBrand(load("brand", S.brand));

/* ========= Transporte: USB, BLE, Simulador ========= */
let transport = null, connState = document.getElementById('connState');
const UI = {
  log: s => { const raw=document.getElementById('raw'); raw.textContent = (raw.textContent + s + "\n").slice(-22000); },
  clear: ()=> document.getElementById('raw').textContent = '',
  show: html => document.getElementById('dec').innerHTML = html,
  add: html => document.getElementById('dec').innerHTML += html,
  id:  html => document.getElementById('idOut').innerHTML = html,
  ff:  html => document.getElementById('ffOut').innerHTML = html,
  toast: m => alert(m),
  rep:  html => document.getElementById('repBody').innerHTML += html,
  repSetVIN: v => document.getElementById('repVIN').textContent = v||"‚Äî",
  repDate: ()=> document.getElementById('repDate').textContent = new Date().toLocaleString()
}; UI.repDate();

const Sim = {
  async write(line){
    const c=line.replace(/\s+/g,'').toUpperCase();
    if(c==="ATZ") return "ELM327 v1.5\r\r>";
    if(/^AT(E0|L0|S0|H[01]|SP[0-9]|ST[0-9A-F]{2}|SH[0-9A-F]+|CRA[0-9A-F]+)$/.test(c)) return "OK\r\r>";
    if(c==="0902") return "49 02 01 57 50 30 5A 5A 5A 5A 5A 5A 31 32 33 34 35 36\r\r>";
    if(c==="0100") return "41 00 BE 3F A8 13\r\r>";
    if(c==="0101") return "41 01 83 07 65 00\r\r>";
    if(c==="03")   return "43 01 33 02 10 00\r\r>";
    if(c==="07")   return "47 00 00 00 00\r\r>";
    if(c==="0A")   return "4A 00 00 00 00\r\r>";
    if(c==="04")   return "44\r\r>";
    if(c==="0205") return "42 05 5A\r\r>";
    if(c==="020C") return "42 0C 1A F8\r\r>";
    if(c==="020D") return "42 0D 28\r\r>";
    if(c==="0210") return "42 10 01 F4\r\r>";
    if(c==="0211") return "42 11 50\r\r>";
    if(c==="020B") return "42 0B 3C\r\r>";
    if(c==="0214") return "42 14 20 80\r\r>";
    if(c==="0105") return "41 05 5A\r\r>";
    if(c==="010C") return "41 0C 1A F8\r\r>";
    if(c==="010D") return "41 0D 28\r\r>";
    if(c==="0110") return "41 10 01 F4\r\r>";
    if(c==="0111") return "41 11 50\r\r>";
    return "NO DATA\r\r>";
  }, async close(){}, type:'sim'
};
const USB = {
  port:null, reader:null, writer:null, type:'usb',
  async open(){ this.port=await navigator.serial.requestPort(); await this.port.open({baudRate:38400}); this.reader=this.port.readable.getReader(); this.writer=this.port.writable.getWriter(); },
  async close(){ try{ if(this.reader){await this.reader.releaseLock()} if(this.writer){await this.writer.releaseLock()} if(this.port){await this.port.close()} }catch(e){} },
  async write(line){ await this.writer.write(new TextEncoder().encode(line+"\r")); let buf=""; while(true){ const {value,done}=await this.reader.read(); if(done)break; const t=new TextDecoder().decode(value); buf+=t; if(t.includes(">")) break; } return buf; }
};
const UUID={NUS_S:"6e400001-b5a3-f393-e0a9-e50e24dcca9e",NUS_RX:"6e400002-b5a3-f393-e0a9-e50e24dcca9e",NUS_TX:"6e400003-b5a3-f393-e0a9-e50e24dcca9e",HM_S:"0000ffe0-0000-1000-8000-00805f9b34fb",HM_CH:"0000ffe1-0000-1000-8000-00805f9b34fb"};
function delay(ms){return new Promise(r=>setTimeout(r,ms));}
function makeBle(){
  return{ dev:null,server:null,srv:null,rx:null,tx:null,buf:"", type:'ble',
    async open(){
      this.dev = await navigator.bluetooth.requestDevice({filters:[{namePrefix:"OBD"},{namePrefix:"ELM"},{namePrefix:"Vgate"},{namePrefix:"OBDLink"}],optionalServices:[UUID.NUS_S,UUID.HM_S]});
      this.server = await this.dev.gatt.connect();
      try{ this.srv=await this.server.getPrimaryService(UUID.NUS_S); this.rx=await this.srv.getCharacteristic(UUID.NUS_RX); this.tx=await this.srv.getCharacteristic(UUID.NUS_TX); }
      catch(e){ this.srv=await this.server.getPrimaryService(UUID.HM_S); this.rx=await this.srv.getCharacteristic(UUID.HM_CH); this.tx=this.rx; }
      await this.tx.startNotifications();
      this.tx.addEventListener('characteristicvaluechanged', e=>{ this.buf += new TextDecoder().decode(e.target.value); });
    },
    async close(){ try{ if(this.dev?.gatt?.connected) this.dev.gatt.disconnect(); }catch(e){} },
    async write(line){
      const data=new TextEncoder().encode(line+"\r");
      for(let i=0;i<data.length;i+=20){ await this.rx.writeValueWithoutResponse(data.slice(i,i+20)); await delay(10); }
      let t0=Date.now(); while(Date.now()-t0<3000){ await delay(30); if(this.buf.includes(">")){ const o=this.buf; this.buf=""; return o; } }
      const o=this.buf; this.buf=""; return o||"NO DATA\r\r>";
    }
  };
}
async function send(line){
  if(!transport){ alert("Conecta primero."); return ""; }
  UI.log("> "+line);
  const r=await transport.write(line);
  UI.log(r.trim());
  return r;
}
/* Conectar/Desconectar */
document.getElementById('btnUsb').onclick = async ()=>{
  try{ if(!("serial" in navigator)) return alert("Tu navegador no soporta Web Serial.");
    await USB.open(); transport=USB; connState.textContent="USB"; connState.style.borderColor="#2d6"; alert("USB conectado. Inicializa el ELM."); }catch(e){ alert("Error USB: "+e); }
};
document.getElementById('btnBle').onclick = async ()=>{
  try{ if(!("bluetooth" in navigator)) return alert("Tu navegador no soporta Web Bluetooth.");
    const ble=makeBle(); await ble.open(); transport=ble; connState.textContent="BLE"; connState.style.borderColor="#2d6"; alert("BLE conectado. Inicializa el ELM."); }catch(e){ alert("Error BLE: "+e); }
};
document.getElementById('btnDisc').onclick = async ()=>{ try{ await transport?.close(); transport=null; connState.textContent="Desconectado"; connState.style.borderColor=""; alert("Desconectado."); }catch(e){} };
document.getElementById('btnSim').onclick = ()=>{
  if(transport?.type==='sim'){ transport=null; document.getElementById('btnSim').textContent="Simulador: Off"; connState.textContent="Desconectado"; return; }
  transport=Sim; document.getElementById('btnSim').textContent="Simulador: On"; connState.textContent="Sim"; alert("Simulador activado.");
};
/* Inicializaci√≥n ELM + Perfil */
async function initElm(){
  UI.clear(); UI.show(""); UI.repDate();
  const ath=document.getElementById('ath').value, st=document.getElementById('timeout').value, sp=document.getElementById('proto').value;
  await send("ATZ"); await new Promise(r=>setTimeout(r,300));
  await send("ATE0"); await send("ATL0"); await send("ATS0");
  await send("ATH"+ath); await send("ATST"+st); await send("ATSP"+sp);
  document.getElementById('tagATH').textContent = ath; document.getElementById('tagST').textContent = st; document.getElementById('tagSP').textContent = sp;
  const brand = load("brand","generic"); if(Profiles[brand]){ await Profiles[brand].setup(); }
  document.getElementById('dec').innerHTML = `<p>ELM listo. Protocolo ${sp}, ATH${ath}, ST=${st}, Perfil <b>${brand}</b>.</p>`;
}
document.getElementById('btnInit').onclick = initElm;

/* ===== Decodificaci√≥n ===== */
function bytes(str){return str.replace(/[^0-9A-F]/gi,' ').trim().split(/\s+/).filter(Boolean)}
function hx(n){return n.toString(16).toUpperCase().padStart(2,'0')}
function decodeMil(resp){
  const t=bytes(resp); const i=t.findIndex(x=>x.toUpperCase()==="41"); if(i<0||t[i+1]!=="01") return "<p class='small'>No se pudo interpretar 41 01.</p>";
  const A=parseInt(t[i+2],16),B=parseInt(t[i+3],16),C=parseInt(t[i+4],16),D=parseInt(t[i+5],16);
  if([A,B,C,D].some(isNaN)) return "<p class='small'>41 01 incompleto.</p>";
  const mil=(A&0x80)!==0, cnt=A&0x7F; return `<p><b>MIL:</b> ${mil?'<span class="bad">ON</span>':'<span class="ok">OFF</span>'} ‚Äî <b>DTC:</b> ${cnt}</p><p class='small'>A=${hx(A)} B=${hx(B)} C=${hx(C)} D=${hx(D)}</p>`;
}
function decodeDTC(resp,svc){
  const t=bytes(resp); let i=t.findIndex(x=>x.toUpperCase()===svc); if(i<0)i=0; else i++;
  const out=[]; for(let k=i;k+1<t.length;k+=2){ const A=parseInt(t[k],16),B=parseInt(t[k+1],16); if(isNaN(A)||isNaN(B)) break; if(A===0&&B===0) break;
    const type=["P","C","B","U"][A>>6]||"P"; out.push(type+((A>>4)&3)+(A&15)+((B>>4)&15)+(B&15)); } return out;
}
function renderDTC(title,codes){ if(!codes.length){ UI.show(`<p class="ok">Sin c√≥digos en ${title}.</p>`); UI.rep(`<h3>${title}</h3><p>Sin c√≥digos.</p>`); return; }
  let h=`<h3>${title}</h3><table class="table"><tr><th>C√≥digo</th><th>Sistema</th></tr>`;
  for(const c of codes){ const s=c[0]==="P"?"Powertrain":c[0]==="C"?"Chassis":c[0]==="B"?"Body":"Network"; h+=`<tr><td><b>${c}</b></td><td>${s}</td></tr>`; }
  h+="</table>"; UI.show(h); UI.rep(h);
}
function decodeVIN(resp){
  const t=bytes(resp); let vinBytes=[]; for(let i=0;i<t.length;i++){ if(t[i]==="49" && t[i+1]==="02"){ for(let k=i+3;k<i+17 && k<t.length;k++){ const b=parseInt(t[k],16); if(!isNaN(b)) vinBytes.push(b);} } }
  return vinBytes.map(b=>String.fromCharCode(b)).join("").replace(/[^0-9A-Z]/g,"").slice(0,17)||"‚Äî";
}
const PID={ rpm:(A,B)=>((256*A+B)/4), speed:(A)=>A, ect:(A)=>A-40, maf:(A,B)=>((256*A+B)/100), tps:(A)=>(A*100/255) };
function decodePID(resp, modePid){
  const t=bytes(resp); const m=modePid.slice(0,2).toUpperCase(); const p=modePid.slice(3,5).toUpperCase();
  const i=t.findIndex(x=>x.toUpperCase()===m); if(i<0||t[i+1]!==p) return null;
  const A=parseInt(t[i+2],16),B=parseInt(t[i+3]||"00",16);
  switch(p){case"0C":return {name:"RPM",val:PID.rpm(A,B),unit:"rpm"}; case"0D":return {name:"Velocidad",val:PID.speed(A),unit:"km/h"};
    case"05":return {name:"ECT",val:PID.ect(A),unit:"¬∞C"}; case"10":return {name:"MAF",val:PID.maf(A,B),unit:"g/s"}; case"11":return {name:"TPS",val:PID.tps(A),unit:"%"}; default:return null;}
}

/* ===== Acciones de p√°ginas ===== */
async function readVIN(){ const r=await send("0902"); const vin=decodeVIN(r); UI.id(`<p><b>VIN:</b> ${vin}</p>`); UI.repSetVIN(vin); }
async function readPIDs(){ const r=await send("0100"); UI.id(`<p><b>PIDs 01-20 soportados:</b> ${r.replace(/\r|>/g," ").trim()}</p>`); }
async function readMil(){ const h=decodeMil(await send("0101")); UI.show(h); UI.rep(`<h3>MIL & Monitores</h3>${h}`); }
async function read03(){ renderDTC("DTC almacenados (03)", decodeDTC(await send("03"),"43")); }
async function read07(){ renderDTC("DTC pendientes (07)", decodeDTC(await send("07"),"47")); }
async function read0A(){ renderDTC("DTC permanentes (0A)", decodeDTC(await send("0A"),"4A")); }
async function clearDTC(){ if(confirm("Borrar DTC (04). Motor apagado, ignici√≥n en ON. ¬øContinuar?")){ await send("04"); UI.show("<p>Comando 04 enviado. Verifica MIL y vuelve a leer DTC.</p>"); UI.rep("<p><b>Borrado de DTC solicitado.</b></p>"); } }
async function readFF(){ const pid=document.getElementById('ffPid').value.toUpperCase(); const r=await send("02"+pid);
  const d=decodePID(r, "42 "+pid); document.getElementById('ffOut').innerHTML = d ? `<p><b>${d.name}:</b> ${d.val.toFixed?d.val.toFixed(2):d.val} ${d.unit||""}</p>` : "<p class='small'>No se pudo decodificar.</p>";
  if(d) UI.rep(`<p>FF ${d.name}: <b>${d.val.toFixed?d.val.toFixed(2):d.val} ${d.unit||""}</b></p>`);
}
async function scanFF(){ const p=["01","03","04","05","06","07","0B","0C","0D","10","11","14"]; let out="<ul>";
  for(const x of p){ const r=await send("02"+x); const d=decodePID(r,"42 "+x); if(d){ out+=`<li>${d.name}: <b>${(d.val.toFixed?d.val.toFixed(2):d.val)} ${d.unit||""}</b></li>`; UI.rep(`<p>FF ${d.name}: <b>${(d.val.toFixed?d.val.toFixed(2):d.val)} ${d.unit||""}</b></p>`); } }
  out+="</ul>"; document.getElementById('ffOut').innerHTML=out;
}
/* Live + gr√°fico */
let liveTimer=null, liveSeries=[]; const canvas=document.getElementById('chart'); const ctx=canvas.getContext('2d');
function fmt(n){return (typeof n==="number" && n.toFixed)? n.toFixed(1): n;}
function drawChart(){ const w=canvas.width=canvas.clientWidth, h=canvas.height=canvas.clientHeight; ctx.clearRect(0,0,w,h);
  ctx.strokeStyle="#223a5f"; ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,h-20); ctx.lineTo(w-10,h-20); ctx.stroke();
  if(liveSeries.length<2) return; const max=Math.max(...liveSeries), min=Math.min(...liveSeries), span=(max-min)||1;
  ctx.beginPath(); ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--acc').trim()||"#48c6ef";
  liveSeries.forEach((v,i)=>{ const x=40+(i*(w-60))/Math.max(1,(liveSeries.length-1)); const y=(h-20)-((v-min)*(h-40)/span); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
  ctx.fillStyle="#9ab"; ctx.fillText(`min ${fmt(min)}  max ${fmt(max)}`, 50, 20);
}
async function liveTick(){ const sel=document.getElementById('liveSel').value; const r=await send(sel);
  const map={"010C":"41 0C","010D":"41 0D","0105":"41 05","0110":"41 10","0111":"41 11"}; const d=decodePID(r,map[sel]);
  if(d){ liveSeries.push(+d.val); if(liveSeries.length>120) liveSeries.shift(); drawChart(); document.getElementById('liveOut').innerHTML=`${d.name}: <b>${fmt(+d.val)} ${d.unit||""}</b>`; UI.rep(`<p>Live ${d.name}: <b>${fmt(+d.val)} ${d.unit||""}</b></p>`); }
}
function startLive(){ if(liveTimer) return; liveSeries=[]; drawChart(); const iv=Math.max(200, parseInt(document.getElementById('liveInt').value||800,10)); liveTimer=setInterval(liveTick, iv); }
function stopLive(){ if(liveTimer){clearInterval(liveTimer); liveTimer=null;} }
/* Export/Print */
function exportCSV(){ const txt=document.getElementById('raw').textContent.replace(/\n/g,"\r\n"); const blob=new Blob([txt],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="doctor_car_pro_log.csv"; a.click(); URL.revokeObjectURL(url); }

/* Eventos de p√°ginas */
document.querySelectorAll('[data-nav]').forEach(a=> a.addEventListener('click', e=>{ e.preventDefault(); openPage(a.dataset.nav); }));
document.getElementById('btnVIN').onclick = readVIN;
document.getElementById('btnPIDs').onclick = readPIDs;
document.getElementById('btnMil').onclick = readMil;
document.getElementById('btn03').onclick = read03;
document.getElementById('btn07').onclick = read07;
document.getElementById('btn0A').onclick = read0A;
document.getElementById('btn04').onclick = clearDTC;
document.getElementById('btnFF').onclick = readFF;
document.getElementById('btnFFScan').onclick = scanFF;
document.getElementById('liveStart').onclick = startLive;
document.getElementById('liveStop').onclick = stopLive;
document.getElementById('btnCsv').onclick = exportCSV;
document.getElementById('btnCsv2').onclick = exportCSV;
document.getElementById('btnPrint').onclick = ()=>window.print();
document.getElementById('btnPrint2').onclick = ()=>window.print();
document.getElementById('btnAddNote').onclick = ()=>{ const t=prompt("Nota para el reporte:"); if(t) UI.rep(`<p>‚Ä¢ ${t}</p>`); };
document.getElementById('btnClearReport').onclick = ()=>{ document.getElementById('repBody').innerHTML=""; UI.repDate(); };
document.getElementById('btnLogout').onclick = ()=>{ app.classList.add('hide'); loginView.classList.remove('hide'); };

/* ===== Arranque: si ya hab√≠a login guardado, no auto-logueamos por seguridad ===== */
</script>
</body>
</html>
